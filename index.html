<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Pro - Ujian Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #2563eb; }
        
        /* Glassmorphism & Utils */
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-card-login { background: rgba(255, 255, 255, 1); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .hidden-view { display: none !important; }
        
        /* Table Styles */
        .modern-table th { background: #f8fafc; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 12px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .modern-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.875rem; vertical-align: middle; white-space: nowrap; }
        .modern-table tr:hover { background: #f1f5f9; }
        
        /* Global Dropdown */
        #global-dropdown { position: fixed; z-index: 9999; background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; width: 180px; display: none; }
        #global-dropdown button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: #334155; transition: background 0.2s; }
        #global-dropdown button:hover { background-color: #f1f5f9; color: #2563eb; }

        /* Navigation Styles */
        .nav-item, .settings-nav-item { border-left: 4px solid transparent; transition: all 0.2s ease-in-out; cursor: pointer; }
        .nav-item.active-nav { background-color: #eff6ff; color: #2563eb; border-left-color: #2563eb; }
        .settings-nav-item.active { background: linear-gradient(90deg, #eff6ff 0%, #ffffff 100%); color: #2563eb; border-left-color: #2563eb; font-weight: 700; }
        .settings-nav-item:hover:not(.active), .nav-item:hover:not(.active-nav) { background-color: #f8fafc; border-left-color: #cbd5e1; }

        /* Sub-tab Button */
        .sub-tab-btn { border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .sub-tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 700; }
        .sub-tab-btn:hover:not(.active) { color: #334155; border-bottom-color: #cbd5e1; }

        /* Dash Card */
        .dash-stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s; }
        .dash-stat-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transform: translateY(-2px); }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
        
        #admin-sidebar { transition: width 0.3s ease; }
        .sidebar-collapsed { width: 5rem !important; }
        .sidebar-collapsed .nav-text, .sidebar-collapsed .nav-header, .sidebar-collapsed #sidebar-logo { display: none; }
        .sidebar-collapsed #sidebar-icon-only { display: flex !important; }

        /* Custom Editor Styles */
        .editor-content-area ul { list-style-type: disc; margin-left: 1.5rem; }
        .editor-content-area ol { list-style-type: decimal; margin-left: 1.5rem; }
        .editor-content-area b { font-weight: bold; }
        .editor-content-area i { font-style: italic; }
        .editor-content-area u { text-decoration: underline; }
        .editor-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }

        /* --- EXAM CARD ID SIZE (6cm x 4cm) --- */
        .exam-card { 
            width: 6cm; 
            height: 4cm; 
            border: 1px solid #000; 
            padding: 3px; 
            background: white; 
            font-family: 'Times New Roman', serif; 
            margin-bottom: 10px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 10px 10px;
            font-size: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        .exam-card-header { 
            display: flex; 
            border-bottom: 1px double #000; 
            padding-bottom: 2px; 
            margin-bottom: 3px; 
            align-items: center; 
            justify-content: center;
        }
        .exam-card-logo { width: 24px; height: 24px; object-fit: contain; margin-right: 3px; }
        .exam-card-header-text { flex: 1; text-align: center; line-height: 1; overflow: hidden; }
        .exam-card-h1 { font-size: 6px; font-weight: bold; margin-bottom: 1px; white-space: nowrap; }
        .exam-card-h2 { font-size: 7px; font-weight: bold; margin-bottom: 1px; white-space: nowrap; }
        .exam-card-h3 { font-size: 5px; white-space: nowrap; }
        
        .exam-card-body { display: flex; gap: 4px; }
        .exam-card-photo-box { width: 1.5cm; height: 1.8cm; background: #eee; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .exam-card-photo-img { width: 100%; height: 100%; object-fit: cover; }
        .exam-card-info { flex: 1; overflow: hidden; }

        .exam-card-title { font-weight: bold; font-size: 8px; text-align: center; margin-bottom: 1px; text-transform: uppercase; text-decoration: underline; }
        .exam-card-subtitle { font-weight: bold; font-size: 6px; text-align: center; margin-bottom: 2px; text-transform: uppercase; }
        
        .exam-card-row { display: flex; margin-bottom: 1px; font-size: 7px; line-height: 1.1; }
        .exam-card-label { width: 40px; font-weight: bold; }
        .exam-card-val { flex: 1; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* --- PRINT OPTIMIZATION (3 Cols x 6 Rows) --- */
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 0; 
            }
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; }
            body * { visibility: hidden; }
            
            #card-preview-area, #card-preview-area * { visibility: visible; }
            
            #card-preview-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 210mm; 
                min-height: 297mm;
                
                display: grid;
                grid-template-columns: repeat(3, 6cm); 
                grid-auto-rows: 4cm;
                column-gap: 5mm; 
                row-gap: 5mm;
                justify-content: start;
                align-content: start;
                
                padding-left: 10mm; 
                padding-top: 10mm;
            }
            
            .exam-card { 
                visibility: visible;
                margin: 0; 
                border: 1px solid #000; 
                width: 6cm;
                height: 4cm;
                page-break-inside: avoid;
                break-inside: avoid;
                background-image: none !important;
                box-shadow: none !important;
            }
            
            button, input, textarea, select, .no-print, #global-dropdown, #admin-sidebar, header { display: none !important; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col bg-blue-600" onclick="closeGlobalDropdown(event)">

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9g4AUZ14a0_vbAXwJob9a4lSh7bwYwUDB9ISCaiScU2PNwTOyzGNtQ8Nlt9kqayQ/exec"; 
        const ADMIN_PIN = "2025"; 
        const MAX_VIOLATIONS = 3;
        var tokenInterval;
    </script>

    <!-- GLOBAL DROPDOWN -->
    <div id="global-dropdown">
        <button onclick="alert('Daftarkan ke ujian...')">Daftarkan ke Ujian</button>
        <button onclick="editStudentAction()">Edit Peserta</button>
        <button onclick="moveClassAction()">Pindah Kelas</button>
        <button onclick="moveRoomAction()">Pindah Ruangan</button>
        <button onclick="moveSessionAction()">Pindah Sesi</button>
    </div>

    <!-- BACKGROUND -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-600 to-indigo-700"></div>
        <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-white opacity-10 blur-3xl"></div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col h-full overflow-hidden relative z-10">
        
        <!-- STUDENT HEADER -->
        <div id="student-header" class="w-full max-w-7xl mx-auto px-6 py-4 flex justify-between items-center transition-all duration-300">
            <div class="flex items-center gap-3 group cursor-default">
                <img id="school-logo-img" src="" alt="Logo" class="h-12 w-auto object-contain hidden bg-white rounded p-1 shadow-sm">
                <div id="default-logo" class="h-10 w-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i data-feather="box" class="w-6 h-6"></i>
                </div>
                <div><h1 class="font-bold text-xl leading-none text-white tracking-tight" id="school-name-display">CBT ONLINE</h1><p class="text-[11px] font-medium text-blue-100 uppercase tracking-wider mt-0.5">Secure Exam System</p></div>
            </div>
            <button onclick="showAdminLogin()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-md border border-white/10 transition flex items-center gap-2 shadow-sm"><i data-feather="lock" class="w-4 h-4"></i> Admin</button>
        </div>

        <!-- MAIN CONTENT -->
        <main class="flex-grow flex items-center justify-center p-4 overflow-hidden">

            <!-- 1. WELCOME VIEW (UPDATED: USERNAME & PASSWORD LOGIN) -->
            <div id="view-welcome" class="glass-card-login w-full max-w-md p-10 fade-in relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <div class="text-center mb-8"><h2 class="text-3xl font-extrabold text-slate-800 mb-1">Login Peserta</h2><p class="text-slate-400 text-sm">Silakan masuk menggunakan akun ujian</p></div>
                <div class="space-y-5">
                    <!-- Username Input -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Username</label>
                        <div class="relative group">
                            <i data-feather="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i>
                            <input type="text" id="input-login-user" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-semibold text-slate-700" placeholder="Masukan Username">
                        </div>
                    </div>
                    <!-- Password Input -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Password</label>
                        <div class="relative group">
                            <i data-feather="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i>
                            <input type="password" id="input-login-pass" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-semibold text-slate-700" placeholder="Masukan Password">
                        </div>
                    </div>
                    <!-- Token Input -->
                    <div id="token-input-group">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Token Soal</label>
                        <div class="relative group">
                            <i data-feather="key" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i>
                            <input type="text" id="input-token" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-bold text-blue-600 text-center tracking-[0.2em] uppercase" placeholder="TOKEN">
                        </div>
                    </div>
                </div>
                <div id="input-error" class="mt-4 hidden bg-red-50 border border-red-100 text-red-600 text-xs font-bold p-3 rounded-xl flex items-center animate-pulse"><i data-feather="alert-circle" class="w-4 h-4 mr-2 shrink-0"></i> <span id="error-text">Error</span></div>
                <button onclick="startQuiz()" class="w-full mt-8 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2 text-sm">Mulai Mengerjakan <i data-feather="arrow-right" class="w-4 h-4"></i></button>
            </div>

            <!-- 2. PLAYING VIEW -->
            <div id="view-playing" class="w-full max-w-5xl h-full flex flex-col hidden-view fade-in bg-slate-50 rounded-2xl overflow-hidden shadow-2xl">
                 <!-- ... (Playing view content same as before) ... -->
                 <div class="bg-white border-b px-6 py-4 flex justify-between items-center">
                    <div class="flex gap-4 items-center"><div class="h-10 w-10 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold shadow-sm" id="avatar-initial">U</div><div><h3 class="font-bold text-slate-800 text-sm" id="play-name">User</h3><p class="text-xs text-slate-500 font-medium" id="play-info">Info</p></div></div>
                    <div class="flex items-center gap-3"><span class="text-xs font-bold text-slate-400 uppercase hidden sm:inline">Sisa Waktu</span><div class="font-mono text-xl font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg border border-blue-100" id="timer-display">--:--</div></div>
                 </div>
                 <div class="w-full h-1 bg-slate-200"><div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div></div>
                 <div class="flex-grow overflow-y-auto p-6 md:p-10 custom-scrollbar bg-slate-50">
                    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div class="mb-6 flex justify-between items-center"><span class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm shadow-blue-200">SOAL NO <span id="q-num">1</span></span><span id="q-type-badge" class="text-xs font-bold text-slate-400 uppercase">Pilihan Ganda</span></div>
                        <div id="q-media" class="mb-6 hidden rounded-xl overflow-hidden border border-slate-100"></div>
                        <div id="q-text" class="prose max-w-none text-slate-800 mb-8 leading-relaxed editor-content-area">Pertanyaan...</div>
                        <div id="options-container" class="space-y-3"></div>
                    </div>
                 </div>
                 <div class="p-5 border-t bg-white flex justify-between items-center">
                    <button id="btn-prev" onclick="prevQ()" class="px-5 py-2.5 rounded-xl border-2 border-slate-100 text-slate-500 font-bold text-sm hover:bg-slate-50 transition">Sebelumnya</button>
                    <button id="btn-next" onclick="nextQ()" class="px-6 py-2.5 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition flex items-center gap-2">Selanjutnya <i data-feather="arrow-right" class="w-4 h-4"></i></button>
                    <button id="btn-finish" onclick="finishQuiz()" class="hidden px-6 py-2.5 rounded-xl bg-emerald-500 text-white text-sm font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition">Selesai & Kumpulkan</button>
                 </div>
            </div>

            <!-- 3. ADMIN DASHBOARD -->
            <div id="view-admin" class="w-full h-full hidden-view fade-in flex overflow-hidden bg-slate-100">
                <aside id="admin-sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 transition-all duration-300 z-20">
                    <div class="h-16 flex items-center px-6 border-b border-slate-100">
                        <div id="sidebar-logo" class="flex items-center gap-3 font-bold text-lg text-slate-800"><div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-200"><i data-feather="command" class="w-5 h-5"></i></div><span>Admin<span class="text-blue-600">Panel</span></span></div>
                        <div id="sidebar-icon-only" class="hidden w-full justify-center"><div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i data-feather="command" class="w-5 h-5"></i></div></div>
                    </div>
                    <nav class="flex-grow p-4 space-y-1 overflow-y-auto custom-scrollbar">
                        <p class="nav-header px-4 text-[10px] font-extrabold text-slate-400 uppercase mb-2 mt-2 tracking-wider">Menu Utama</p>
                        <button onclick="adminNav('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 active-nav"><i data-feather="grid" class="w-5 h-5"></i> <span class="nav-text">Dashboard</span></button>
                        <button onclick="adminNav('students')" id="nav-students" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="users" class="w-5 h-5"></i> <span class="nav-text">Data Peserta</span></button>
                        <button onclick="adminNav('questions')" id="nav-questions" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="file-text" class="w-5 h-5"></i> <span class="nav-text">Bank Soal</span></button>
                        <button onclick="adminNav('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="settings" class="w-5 h-5"></i> <span class="nav-text">Pengaturan</span></button>
                    </nav>
                    <div class="p-4 border-t"><button onclick="logoutAdmin()" class="w-full py-2 text-sm font-bold text-red-500 bg-red-50 rounded-lg hover:bg-red-100">Logout</button></div>
                </aside>

                <div class="flex-grow flex flex-col h-full overflow-hidden relative">
                    <header class="bg-white h-16 border-b border-slate-200 px-4 flex justify-between items-center z-10 shrink-0">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i data-feather="menu" class="w-5 h-5"></i></button>
                            <div class="relative hidden md:block group"><i data-feather="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition"></i><input type="text" placeholder="Cari ujian..." class="pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition w-64"></div>
                        </div>
                        <div class="flex items-center gap-3 md:gap-5">
                            <div id="digital-clock" class="hidden md:block font-mono font-bold text-slate-600 text-sm bg-slate-50 px-3 py-1 rounded-md border border-slate-200">00:00:00 AM</div>
                            <button onclick="toggleFullScreen()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i data-feather="maximize" class="w-5 h-5"></i></button>
                            <div class="relative">
                                <button onclick="toggleProfileMenu()" class="flex items-center gap-3 hover:bg-slate-50 p-1.5 pr-3 rounded-lg transition border border-transparent hover:border-slate-200"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-8 w-8 rounded-full bg-blue-100 border border-blue-200"><div class="text-left hidden sm:block"><p class="text-xs font-bold text-slate-700">Administrator</p><p class="text-[10px] text-slate-400 font-medium">Super Admin</p></div><i data-feather="chevron-down" class="w-4 h-4 text-slate-400 ml-1"></i></button>
                                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 z-50">
                                    <a href="#" onclick="adminNav('settings'); switchSettingsTab('profile'); toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Profil Saya</a>
                                    <a href="#" onclick="adminNav('settings'); switchSettingsTab('about'); toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Tentang</a>
                                    <div class="border-t border-slate-50 my-1"></div>
                                    <button onclick="logoutAdmin()" class="w-full text-left px-4 py-2 text-sm text-red-500 font-bold hover:bg-red-50">Keluar</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div class="flex-grow overflow-y-auto custom-scrollbar p-6 md:p-8 bg-slate-50/50">
                        <!-- PANEL: DASHBOARD -->
                        <div id="admin-panel-dashboard" class="admin-panel space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="dash-stat-card col-span-2 relative overflow-hidden">
                                    <div class="absolute top-0 right-
