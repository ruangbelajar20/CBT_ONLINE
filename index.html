<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Modern - Secure Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        
        /* Modern Glass Effect */
        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
        }

        .gradient-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden-view { display: none !important; }
        
        /* Table Styling */
        .modern-table th { background: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; padding: 1rem; border-bottom: 2px solid #e2e8f0; }
        .modern-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
        .modern-table tr:last-child td { border-bottom: none; }
        .modern-table tr:hover { background: #f8fafc; transition: background 0.2s; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col bg-slate-50">

    <script>
        // KONFIGURASI
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9g4AUZ14a0_vbAXwJob9a4lSh7bwYwUDB9ISCaiScU2PNwTOyzGNtQ8Nlt9kqayQ/exec"; 
        const ADMIN_PIN = "2025"; 
        const MAX_VIOLATIONS = 3;
    </script>

    <!-- BACKGROUND DECORATION -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-indigo-100 blur-3xl opacity-60"></div>
        <div class="absolute top-[10%] -right-[10%] w-[40%] h-[40%] rounded-full bg-purple-100 blur-3xl opacity-60"></div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col h-full overflow-hidden relative z-10">
        
        <!-- HEADER LOGO -->
        <div class="w-full max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 group cursor-default">
                <img id="school-logo-img" src="" alt="Logo" class="h-10 w-auto object-contain hidden bg-white rounded-lg p-1 shadow-sm border border-slate-100">
                <div id="default-logo" class="h-10 w-10 gradient-header rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i data-feather="box" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-none text-slate-800 tracking-tight" id="school-name-display">CBT ONLINE</h1>
                    <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-wider mt-1">Secure Exam System</p>
                </div>
            </div>
            <div id="top-nav-btn">
                <button onclick="showAdminLogin()" class="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold border border-slate-200 shadow-sm hover:shadow transition-all flex items-center gap-2 group">
                    <div class="bg-slate-100 p-1 rounded-md group-hover:bg-indigo-100 group-hover:text-indigo-600 transition">
                        <i data-feather="settings" class="w-3 h-3"></i>
                    </div>
                    Admin
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-grow flex items-center justify-center p-4 overflow-y-auto custom-scrollbar">

            <!-- 1. WELCOME VIEW (REDESIGNED) -->
            <div id="view-welcome" class="glass-card w-full max-w-md rounded-3xl p-8 fade-in relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 gradient-header"></div>
                
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-extrabold text-slate-800 mb-1">Login Peserta</h2>
                    <p class="text-slate-400 text-sm">Silakan masuk untuk memulai ujian</p>
                </div>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Nama Lengkap</label>
                        <div class="relative group">
                            <i data-feather="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <input type="text" id="input-nama" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:bg-white focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all font-medium text-slate-700 placeholder:text-slate-400" placeholder="Nama Anda...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Kelas</label>
                        <div class="relative group">
                            <i data-feather="users" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <select id="input-kelas" class="w-full pl-12 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:bg-white focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all font-medium text-slate-700 appearance-none cursor-pointer">
                                <option value="">Pilih Kelas</option>
                                <option value="X TKJ 1">X TKJ 1</option><option value="X TKJ 2">X TKJ 2</option>
                                <option value="XI TKJ 1">XI TKJ 1</option><option value="XI TKJ 2">XI TKJ 2</option>
                                <option value="XII TKJ 1">XII TKJ 1</option><option value="XII TKJ 2">XII TKJ 2</option>
                                <option value="X RPL 1">X RPL 1</option><option value="X RPL 2">X RPL 2</option>
                                <option value="XI RPL 1">XI RPL 1</option><option value="XI RPL 2">XI RPL 2</option>
                            </select>
                            <i data-feather="chevron-down" class="absolute right-4 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Token Soal</label>
                        <div class="relative group">
                            <i data-feather="key" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <input type="text" id="input-token" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:bg-white focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all font-bold text-indigo-600 text-center tracking-[0.2em] uppercase placeholder:text-slate-300 placeholder:tracking-normal placeholder:font-normal" placeholder="TOKEN">
                        </div>
                    </div>
                </div>

                <div id="input-error" class="mt-4 hidden bg-red-50 border border-red-100 text-red-600 text-xs font-bold p-3 rounded-xl flex items-center animate-pulse">
                    <i data-feather="alert-circle" class="w-4 h-4 mr-2 shrink-0"></i> <span id="error-text">Error message</span>
                </div>

                <button onclick="startQuiz()" class="w-full mt-8 gradient-header hover:opacity-90 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-indigo-200 transition-all transform active:scale-[0.98] flex justify-center items-center gap-2 text-sm">
                    Mulai Mengerjakan <i data-feather="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- 2. PLAYING VIEW -->
            <div id="view-playing" class="w-full max-w-5xl h-full flex flex-col hidden-view fade-in">
                <!-- Top Info Bar -->
                <div class="glass-card rounded-2xl p-4 mb-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="h-12 w-12 rounded-2xl gradient-header flex items-center justify-center text-white font-bold text-lg shadow-md" id="avatar-initial">U</div>
                        <div>
                            <h3 class="font-bold text-slate-800" id="play-name">User</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-500 font-medium mt-0.5">
                                <span id="play-mapel">Mapel</span>
                                <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                <span class="text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded">Ujian Aktif</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right hidden md:block">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Sisa Waktu</p>
                            <p class="font-mono text-xl font-bold text-slate-700 bg-slate-100 px-3 py-1 rounded-lg" id="timer-display">--:--</p>
                        </div>
                        <div class="bg-green-50 border border-green-100 text-green-700 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-sm" id="status-badge">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Aman
                        </div>
                    </div>
                </div>

                <!-- Main Question Area -->
                <div class="flex-grow flex gap-4 overflow-hidden">
                    <div class="flex-grow bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col overflow-hidden relative">
                        <!-- Progress Bar -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-slate-50">
                            <div id="progress-bar" class="h-full gradient-header transition-all duration-500 rounded-r-full" style="width: 0%"></div>
                        </div>
                        
                        <div class="p-8 md:p-10 flex-grow overflow-y-auto custom-scrollbar">
                            <div class="flex items-center justify-between mb-6">
                                <span class="bg-indigo-50 text-indigo-600 text-xs font-extrabold px-3 py-1.5 rounded-lg uppercase tracking-wide">Soal No. <span id="q-num">1</span></span>
                            </div>
                            
                            <h2 id="q-text" class="text-lg md:text-xl font-semibold text-slate-800 mb-8 leading-relaxed">Pertanyaan...</h2>
                            
                            <div id="options-container" class="space-y-3">
                                <!-- Options Injected Here -->
                            </div>
                        </div>

                        <div class="p-6 border-t border-slate-50 bg-white flex justify-between items-center">
                            <button id="btn-prev" onclick="prevQ()" class="px-5 py-2.5 rounded-xl bg-white border-2 border-slate-100 text-slate-500 font-bold text-sm hover:border-slate-200 hover:bg-slate-50 hover:text-slate-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                <i data-feather="chevron-left" class="w-4 h-4"></i> Sebelumnya
                            </button>
                            
                            <button id="btn-next" onclick="nextQ()" class="px-6 py-2.5 rounded-xl gradient-header text-white font-bold text-sm hover:opacity-90 shadow-lg shadow-indigo-200 transition flex items-center gap-2">
                                Selanjutnya <i data-feather="chevron-right" class="w-4 h-4"></i>
                            </button>
                            
                            <button id="btn-finish" onclick="finishQuiz()" class="hidden px-8 py-2.5 rounded-xl bg-emerald-500 text-white font-bold text-sm hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition flex items-center gap-2">
                                Selesai <i data-feather="check" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ADMIN DASHBOARD VIEW -->
            <div id="view-admin" class="w-full max-w-[90rem] h-full hidden-view fade-in flex gap-6 overflow-hidden p-2">
                
                <!-- Sidebar -->
                <aside class="w-72 bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col overflow-hidden shrink-0">
                    <div class="p-8 border-b border-slate-50">
                        <h2 class="font-bold text-xl text-slate-800 flex items-center gap-3">
                            <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-feather="command" class="w-5 h-5"></i></div>
                            Admin Panel
                        </h2>
                        <p class="text-xs text-slate-400 mt-2 font-medium pl-1">Control Center v3.0</p>
                    </div>
                    <nav class="flex-grow p-6 space-y-2 overflow-y-auto custom-scrollbar">
                        <button onclick="adminNav('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3.5 text-sm font-bold rounded-2xl text-slate-500 hover:bg-slate-50 transition-all nav-item active-nav">
                            <i data-feather="grid" class="w-4 h-4"></i> Dashboard Hasil
                        </button>
                        <button onclick="adminNav('questions')" id="nav-questions" class="w-full flex items-center gap-3 px-4 py-3.5 text-sm font-bold rounded-2xl text-slate-500 hover:bg-slate-50 transition-all nav-item">
                            <i data-feather="layers" class="w-4 h-4"></i> Kelola Soal
                        </button>
                        <button onclick="adminNav('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3.5 text-sm font-bold rounded-2xl text-slate-500 hover:bg-slate-50 transition-all nav-item">
                            <i data-feather="settings" class="w-4 h-4"></i> Pengaturan
                        </button>
                    </nav>
                    <div class="p-6 border-t border-slate-50">
                        <button onclick="logoutAdmin()" class="w-full flex items-center justify-center gap-2 px-4 py-3 text-sm font-bold text-red-500 bg-red-50 rounded-2xl hover:bg-red-100 hover:text-red-600 transition">
                            <i data-feather="log-out" class="w-4 h-4"></i> Keluar
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <div class="flex-grow bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden flex flex-col">
                    
                    <!-- Content: Dashboard Hasil -->
                    <div id="admin-panel-dashboard" class="admin-panel h-full flex flex-col">
                        <div class="px-8 py-6 border-b border-slate-50 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-xl text-slate-800">Data Hasil Ujian</h3>
                                <p class="text-xs text-slate-400 mt-1 font-medium">Real-time data dari Google Spreadsheet</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="fetchAdminData()" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-100 transition flex items-center gap-2"><i data-feather="refresh-cw" class="w-3 h-3"></i> Refresh</button>
                                <button onclick="downloadExcel()" class="px-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl text-xs font-bold hover:bg-emerald-100 transition flex items-center gap-2"><i data-feather="download" class="w-3 h-3"></i> Excel</button>
                            </div>
                        </div>
                        <div class="flex-grow overflow-auto custom-scrollbar p-0">
                            <table class="w-full text-left modern-table">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr><th>Waktu</th><th>Nama</th><th>Kelas</th><th>Mapel</th><th>Skor</th><th>Nilai</th><th>Status</th></tr>
                                </thead>
                                <tbody id="table-results-body" class="bg-white text-sm font-medium"></tbody>
                            </table>
                            <div id="loading-state" class="hidden p-12 text-center text-slate-400 flex flex-col items-center justify-center h-full">
                                <div class="spinner mb-4"></div> Memuat data...
                            </div>
                        </div>
                    </div>

                    <!-- Content: Kelola Soal -->
                    <div id="admin-panel-questions" class="admin-panel h-full flex flex-col hidden-view">
                        <div class="px-8 py-6 border-b border-slate-50 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-xl text-slate-800">Manajemen Bank Soal</h3>
                                <p class="text-xs text-slate-400 mt-1 font-medium">Buat & Edit Token Mata Pelajaran</p>
                            </div>
                            <button onclick="openAddSubject()" class="px-5 py-2.5 gradient-header text-white rounded-xl text-sm font-bold hover:opacity-90 transition shadow-lg shadow-indigo-100">+ Mapel Baru</button>
                        </div>
                        <div class="flex-grow flex overflow-hidden">
                            <!-- List Mapel -->
                            <div class="w-80 border-r border-slate-50 overflow-y-auto custom-scrollbar p-6 space-y-3 bg-slate-50/50" id="mapel-list">
                                <!-- JS Injected -->
                            </div>
                            <!-- List Soal -->
                            <div class="flex-grow flex flex-col bg-white">
                                <div id="empty-soal-state" class="flex-grow flex flex-col items-center justify-center text-slate-300">
                                    <i data-feather="layers" class="w-16 h-16 mb-4 opacity-50"></i>
                                    <p class="text-sm font-bold">Pilih Mata Pelajaran</p>
                                    <p class="text-xs mt-1">Klik salah satu mapel di sidebar kiri</p>
                                </div>
                                <div id="soal-editor-wrapper" class="hidden flex-col h-full">
                                    <div class="px-8 py-4 flex justify-between items-center bg-white border-b border-slate-50 shadow-sm z-10">
                                        <div>
                                            <h4 class="font-bold text-indigo-700 text-lg" id="active-mapel-name">Mapel</h4>
                                            <p class="text-xs text-slate-400 font-mono mt-0.5" id="active-mapel-token">TOKEN</p>
                                        </div>
                                        <div class="flex gap-3">
                                            <button onclick="deleteCurrentSubject()" class="text-red-500 text-xs font-bold hover:bg-red-50 px-3 py-1.5 rounded-lg transition">Hapus Mapel</button>
                                            <button onclick="openAddQuestion()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-900 shadow-md transition">+ Tambah Soal</button>
                                        </div>
                                    </div>
                                    <div id="soal-list" class="flex-grow overflow-y-auto p-8 space-y-4 custom-scrollbar bg-slate-50/30"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Settings -->
                    <div id="admin-panel-settings" class="admin-panel h-full p-12 hidden-view bg-slate-50/30">
                        <div class="max-w-2xl">
                            <h3 class="font-bold text-2xl text-slate-800 mb-2">Pengaturan Sekolah</h3>
                            <p class="text-slate-500 text-sm mb-8">Sesuaikan identitas aplikasi ujian Anda.</p>
                            
                            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">URL Logo Sekolah</label>
                                <div class="flex gap-3 mb-6">
                                    <input type="text" id="setting-logo-url" class="flex-grow border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 outline-none transition font-medium text-slate-700" placeholder="https://sekolah.sch.id/logo.png">
                                    <button onclick="saveLogoSettings()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-100">Simpan</button>
                                </div>
                                
                                <div class="p-6 rounded-2xl bg-slate-50 border border-dashed border-slate-200 flex items-center gap-6">
                                    <div class="h-20 w-20 bg-white rounded-xl border border-slate-100 flex items-center justify-center shadow-sm overflow-hidden">
                                        <img id="setting-logo-preview" src="" alt="Preview" class="h-16 w-16 object-contain">
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-700 text-sm">Pratinjau Logo</h4>
                                        <p class="text-xs text-slate-400 mt-1 max-w-xs leading-relaxed">Pastikan logo menggunakan format PNG/JPG dengan background transparan untuk hasil terbaik.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 4. FINISHED / DISQUALIFIED VIEW -->
            <div id="view-result-card" class="glass-card w-full max-w-lg rounded-3xl p-10 hidden-view fade-in text-center">
                <div id="res-icon-container" class="mb-6 flex justify-center"></div>
                <h2 id="res-title" class="text-3xl font-extrabold text-slate-800 mb-2">Status</h2>
                <div class="bg-slate-50 rounded-2xl p-5 mb-8 border border-slate-100">
                    <p id="final-name" class="font-bold text-xl text-slate-800"></p>
                    <p id="final-info" class="text-sm text-slate-500 font-medium mt-1"></p>
                </div>
                <div class="text-6xl font-black text-indigo-600 mb-2 tracking-tight" id="final-score">0</div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-8">Nilai Akhir</p>
                
                <p id="final-message" class="text-sm font-medium text-slate-600 mb-8 bg-white p-3 rounded-lg border border-slate-100 shadow-sm"></p>
                
                <button onclick="location.reload()" class="w-full bg-slate-800 text-white px-6 py-4 rounded-2xl font-bold shadow-xl hover:bg-slate-900 transition transform active:scale-[0.98]">Kembali ke Login</button>
            </div>

        </main>
    </div>

    <!-- MODALS (Modern) -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden-view transition-opacity">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl transform scale-100">
            <div class="text-center mb-6">
                <div class="bg-indigo-50 p-3 rounded-2xl inline-block mb-4">
                    <i data-feather="shield" class="w-6 h-6 text-indigo-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Akses Admin</h3>
            </div>
            <input type="password" id="pin-input" class="w-full text-center text-3xl font-bold tracking-[0.5em] border-b-2 border-slate-200 py-4 focus:border-indigo-500 outline-none mb-8 transition text-slate-700 placeholder:tracking-normal placeholder:text-lg placeholder:font-normal" placeholder="Masukkan PIN" maxlength="4">
            <div class="flex gap-3">
                <button onclick="document.getElementById('modal-login').classList.add('hidden-view')" class="flex-1 py-3.5 font-bold text-slate-500 hover:bg-slate-50 rounded-xl transition">Batal</button>
                <button onclick="checkAdminPin()" class="flex-1 py-3.5 font-bold text-white gradient-header rounded-xl shadow-lg hover:opacity-90 transition">Masuk</button>
            </div>
        </div>
    </div>

    <div id="modal-subject" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden-view">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg text-slate-800 mb-6">Mapel Baru</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Kode Token</label>
                    <input id="new-token" class="w-full border border-slate-200 p-3 rounded-xl text-sm font-mono uppercase font-bold focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="CTH: MTK01">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nama Mata Pelajaran</label>
                    <input id="new-mapel" class="w-full border border-slate-200 p-3 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Matematika Wajib">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="document.getElementById('modal-subject').classList.add('hidden-view')" class="px-5 py-2.5 text-sm font-bold text-slate-500 hover:bg-slate-50 rounded-xl">Batal</button>
                <button onclick="saveNewSubject()" class="px-5 py-2.5 text-sm font-bold bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-question" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden-view">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl">
            <h3 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2"><i data-feather="edit-3" class="w-4 h-4"></i> Editor Soal</h3>
            <div class="flex-grow overflow-y-auto space-y-5 pr-2 custom-scrollbar">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Pertanyaan</label>
                    <textarea id="editor-q" class="w-full border border-slate-200 p-4 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition" rows="3" placeholder="Tulis pertanyaan disini..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Bobot Poin</label>
                    <input type="number" id="editor-pts" class="border border-slate-200 p-3 rounded-xl w-24 text-sm font-bold text-center focus:ring-2 focus:ring-indigo-500 outline-none" value="2.5">
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase">Opsi Jawaban</label>
                        <button onclick="addOptInput()" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 transition">+ Tambah Opsi</button>
                    </div>
                    <div id="editor-opts" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="document.getElementById('modal-question').classList.add('hidden-view')" class="px-6 py-3 font-bold text-slate-500 hover:bg-slate-50 rounded-xl transition">Batal</button>
                <button onclick="saveEditorQuestion()" class="px-6 py-3 font-bold bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg transition">Simpan Soal</button>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        // --- STATE ---
        let db = JSON.parse(localStorage.getItem('cbt_db_v1') || '{}');
        let currentQuestions = [], userAnswers = {}, currentQ = 0;
        let userData = {}, timerInterval, startTime;
        let violations = 0;
        let activeTokenAdmin = null;
        let editingQIdx = null;

        // --- LOGOUT FUNCTION (BUG FIX) ---
        function logoutAdmin() {
            // Reset state admin
            activeTokenAdmin = null;
            // Kembali ke halaman awal
            nav('welcome');
            // Opsional: Reset form login
            document.getElementById('pin-input').value = '';
        }

        async function loadAppConfig() {
            if (GOOGLE_SCRIPT_URL) {
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await res.json();
                    if (data.settings && data.settings.logoUrl) {
                        applyLogo(data.settings.logoUrl);
                        localStorage.setItem('school_logo_url', data.settings.logoUrl);
                    }
                } catch(e) {
                    const cached = localStorage.getItem('school_logo_url');
                    if(cached) applyLogo(cached);
                }
            }
        }
        
        function applyLogo(url) {
            if(!url) return;
            const img = document.getElementById('school-logo-img');
            const def = document.getElementById('default-logo');
            img.src = url;
            img.classList.remove('hidden');
            def.classList.add('hidden');
            document.getElementById('setting-logo-preview').src = url;
            document.getElementById('setting-logo-url').value = url;
        }

        loadAppConfig();

        const nav = (viewId) => {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden-view');
            const topNav = document.getElementById('top-nav-btn');
            if(viewId === 'welcome') topNav.classList.remove('hidden');
            else topNav.classList.add('hidden');
        };

        function startQuiz() {
            const nama = document.getElementById('input-nama').value.trim();
            const kelas = document.getElementById('input-kelas').value;
            const token = document.getElementById('input-token').value.trim().toUpperCase();
            
            if(!nama || !kelas || !token) return showError("Lengkapi semua data!");
            if(!db[token]) return showError("Token soal tidak ditemukan!");
            if(!db[token].questions || db[token].questions.length === 0) return showError("Soal belum tersedia.");

            userData = { nama, kelas, token, mapel: db[token].name };
            currentQuestions = shuffle(JSON.parse(JSON.stringify(db[token].questions)));
            currentQ = 0; userAnswers = {}; violations = 0;
            startTime = new Date();

            document.getElementById('play-name').textContent = nama;
            document.getElementById('avatar-initial').textContent = nama.charAt(0).toUpperCase();
            document.getElementById('play-mapel').textContent = `${db[token].name} (${kelas})`;
            document.getElementById('input-error').classList.add('hidden');
            
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
            
            nav('playing');
            renderQ();
            startTimer();
            initAntiCheat();
        }

        function renderQ() {
            const q = currentQuestions[currentQ];
            document.getElementById('q-num').textContent = currentQ + 1;
            document.getElementById('q-text').textContent = q.question;
            const pct = ((currentQ + 1) / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;

            const cont = document.getElementById('options-container');
            cont.innerHTML = '';
            q.options.forEach((opt, i) => {
                const isSel = userAnswers[currentQ] === i;
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-5 rounded-2xl border-2 transition-all flex items-start gap-4 group ${isSel ? 'border-indigo-600 bg-indigo-50/50 shadow-sm' : 'border-slate-100 hover:border-indigo-200 hover:bg-slate-50'}`;
                btn.onclick = () => { userAnswers[currentQ] = i; renderQ(); };
                btn.innerHTML = `<span class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-colors ${isSel?'bg-indigo-600 text-white':'bg-slate-100 text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600'}">${String.fromCharCode(65+i)}</span> <span class="py-1 text-sm font-medium ${isSel?'text-indigo-900':'text-slate-600'}">${opt}</span>`;
                cont.appendChild(btn);
            });

            document.getElementById('btn-prev').disabled = currentQ === 0;
            if(currentQ === currentQuestions.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-finish').classList.remove('hidden');
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-finish').classList.add('hidden');
            }
        }

        function nextQ() { if(currentQ < currentQuestions.length - 1) { currentQ++; renderQ(); }}
        function prevQ() { if(currentQ > 0) { currentQ--; renderQ(); }}

        async function finishQuiz(forced = false) {
            clearInterval(timerInterval);
            if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});

            let score = 0, totalPts = 0;
            currentQuestions.forEach((q, i) => {
                totalPts += (q.points || 1);
                if(userAnswers[i] === q.answer) score += (q.points || 1);
            });
            const final = totalPts > 0 ? Math.round((score/totalPts)*100) : 0;
            
            const diff = new Date() - startTime;
            const mins = Math.floor(diff/60000);
            const secs = Math.floor((diff%60000)/1000);
            const durStr = `${mins}m ${secs}s`;

            nav('result-card');
            const iconContainer = document.getElementById('res-icon-container');
            const title = document.getElementById('res-title');
            const msg = document.getElementById('final-message');
            
            document.getElementById('final-name').textContent = userData.nama;
            document.getElementById('final-info').textContent = `${userData.kelas} â€¢ ${userData.mapel}`;
            document.getElementById('final-score').textContent = final;

            if (forced) {
                iconContainer.innerHTML = '<div class="h-24 w-24 bg-red-50 rounded-full flex items-center justify-center text-red-500 shadow-inner"><i data-feather="alert-octagon" class="w-12 h-12"></i></div>';
                feather.replace();
                title.textContent = "DISKUALIFIKASI";
                title.className = "text-3xl font-extrabold text-red-600 mb-2";
                msg.textContent = `Ujian dihentikan otomatis karena terdeteksi ${violations}x pelanggaran keamanan. Nilai Anda tetap tersimpan di server.`;
                sendData(score, final, durStr, violations, true);
            } else {
                const passed = final >= 75;
                iconContainer.innerHTML = passed 
                    ? '<div class="h-24 w-24 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-500 shadow-inner"><i data-feather="check" class="w-12 h-12"></i></div>'
                    : '<div class="h-24 w-24 bg-amber-50 rounded-full flex items-center justify-center text-amber-500 shadow-inner"><i data-feather="x" class="w-12 h-12"></i></div>';
                feather.replace();
                title.textContent = passed ? "Kompeten" : "Belum Kompeten";
                title.className = `text-3xl font-extrabold ${passed?'text-emerald-600':'text-amber-600'} mb-2`;
                msg.textContent = passed ? "Selamat! Anda telah menyelesaikan ujian dengan hasil yang memuaskan." : "Jangan patah semangat! Silakan pelajari materi kembali dan coba lagi.";
                sendData(score, final, durStr, violations, false);
            }
        }

        async function sendData(score, final, dur, viols, isDq) {
            if(!GOOGLE_SCRIPT_URL) return;
            const payload = {
                nama: isDq ? `${userData.nama} (DQ)` : userData.nama,
                kelas: userData.kelas,
                mapel: userData.mapel,
                skor: score,
                nilaiAkhir: final,
                durasi: dur,
                pelanggaran: viols,
                action: "submit_exam"
            };
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } catch(e) { console.error(e); }
        }

        function initAntiCheat() {
            document.addEventListener('visibilitychange', () => handleViolate("Pindah Tab"));
            window.addEventListener('blur', () => handleViolate("Focus Loss"));
            window.addEventListener('resize', () => { if(window.innerWidth < screen.width * 0.9) handleViolate("Split Screen"); });
        }

        function handleViolate(type) {
            if(document.querySelector('.swal-overlay')) return; 
            violations++;
            if(violations >= MAX_VIOLATIONS) {
                finishQuiz(true);
            } else {
                alert(`PERINGATAN KEAMANAN ${violations}/${MAX_VIOLATIONS}\n\nTerdeteksi: ${type}\n\nMohon tetap di layar ujian. Pelanggaran berikutnya akan menyebabkan diskualifikasi.`);
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const diff = new Date() - startTime;
                const m = Math.floor(diff/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;
            }, 1000);
        }

        function showAdminLogin() { document.getElementById('modal-login').classList.remove('hidden-view'); document.getElementById('pin-input').value = ''; document.getElementById('pin-input').focus(); }
        
        function checkAdminPin() {
            if(document.getElementById('pin-input').value === ADMIN_PIN) {
                document.getElementById('modal-login').classList.add('hidden-view');
                nav('admin');
                renderMapelList();
                adminNav('dashboard');
                fetchAdminData();
            } else {
                alert("PIN Salah");
            }
        }

        function adminNav(tab) {
            document.querySelectorAll('.admin-panel').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`admin-panel-${tab}`).classList.remove('hidden-view');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-indigo-50', 'text-indigo-600');
                el.classList.add('text-slate-500');
            });
            const active = document.getElementById(`nav-${tab}`);
            active.classList.add('bg-indigo-50', 'text-indigo-600');
            active.classList.remove('text-slate-500');
        }

        async function fetchAdminData() {
            document.getElementById('loading-state').classList.remove('hidden');
            const tbody = document.getElementById('table-results-body');
            tbody.innerHTML = '';
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL);
                const data = await res.json();
                const results = data.students || data;
                
                if(results.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center p-12 text-slate-400 text-sm">Belum ada data ujian masuk.</td></tr>`;
                } else {
                    results.reverse().forEach(r => {
                        const tr = document.createElement('tr');
                        const isPass = r.nilaiAkhir >= 75;
                        tr.innerHTML = `
                            <td class="text-xs text-slate-500">${new Date(r.timestamp).toLocaleString()}</td>
                            <td class="font-bold text-slate-700">${r.nama}</td>
                            <td><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600 border border-slate-200">${r.kelas}</span></td>
                            <td class="text-xs font-medium text-slate-600">${r.mapel}</td>
                            <td class="font-mono text-xs text-slate-500">${r.skor}</td>
                            <td class="font-extrabold text-lg ${isPass ? 'text-emerald-600' : 'text-red-600'}">${r.nilaiAkhir}</td>
                            <td>${isPass ? '<span class="bg-emerald-50 text-emerald-600 px-2 py-1 rounded text-xs font-bold border border-emerald-100">Lulus</span>' : '<span class="bg-red-50 text-red-600 px-2 py-1 rounded text-xs font-bold border border-red-100">Remidi</span>'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { console.error(e); tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4 font-bold text-sm">Gagal memuat data. Periksa koneksi.</td></tr>`; }
            
            document.getElementById('loading-state').classList.add('hidden');
        }

        function downloadExcel() {
            alert("Fitur Download akan mengambil data dari tampilan tabel saat ini.");
        }

        async function saveLogoSettings() {
            const url = document.getElementById('setting-logo-url').value.trim();
            if(!url) return alert("URL kosong");
            localStorage.setItem('school_logo_url', url);
            applyLogo(url);
            if(GOOGLE_SCRIPT_URL) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: "save_settings", logoUrl: url })
                    });
                    alert("Logo tersimpan!");
                } catch(e) { alert("Gagal simpan ke server, tapi tersimpan di browser ini."); }
            }
        }

        function renderMapelList() {
            const list = document.getElementById('mapel-list');
            list.innerHTML = '';
            Object.keys(db).forEach(token => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border cursor-pointer hover:bg-white transition shadow-sm ${activeTokenAdmin === token ? 'border-indigo-500 bg-white ring-2 ring-indigo-100' : 'border-transparent bg-white/50 hover:border-indigo-100'}`;
                div.onclick = () => selectMapel(token);
                div.innerHTML = `<h4 class="font-bold text-sm text-slate-700 mb-1">${db[token].name}</h4><div class="flex items-center justify-between"><p class="text-[10px] text-slate-400 font-mono bg-slate-100 px-1.5 py-0.5 rounded uppercase tracking-wider">${token}</p><span class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">${db[token].questions.length} Soal</span></div>`;
                list.appendChild(div);
            });
        }

        function selectMapel(token) {
            activeTokenAdmin = token;
            renderMapelList();
            document.getElementById('empty-soal-state').classList.add('hidden');
            document.getElementById('soal-editor-wrapper').classList.remove('hidden');
            document.getElementById('soal-editor-wrapper').classList.add('flex');
            document.getElementById('active-mapel-name').textContent = db[token].name;
            document.getElementById('active-mapel-token').textContent = `TOKEN: ${token}`;
            renderSoalList();
        }

        function renderSoalList() {
            const list = document.getElementById('soal-list');
            list.innerHTML = '';
            db[activeTokenAdmin].questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white border border-slate-100 p-5 rounded-2xl shadow-sm relative group hover:border-indigo-200 transition";
                let opts = '<div class="mt-3 grid grid-cols-1 gap-2">';
                q.options.forEach((o, i) => opts += `<div class="text-xs px-3 py-2 rounded-lg border ${i===q.answer?'bg-emerald-50 border-emerald-100 text-emerald-700 font-bold':'bg-slate-50 border-transparent text-slate-500'} flex gap-2"><span>${String.fromCharCode(65+i)}.</span> ${o}</div>`);
                opts += '</div>';
                div.innerHTML = `<div class="pr-12"><div class="flex gap-2 mb-2"><span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded">No. ${idx+1}</span><span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded">${q.points} Poin</span></div><p class="text-sm font-medium text-slate-800 leading-relaxed">${q.question}</p>${opts}</div>
                <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                    <button onclick="editQ(${idx})" class="p-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition"><i data-feather="edit-2" class="w-3.5 h-3.5"></i></button>
                    <button onclick="deleteQ(${idx})" class="p-2 text-red-500 bg-red-50 hover:bg-red-100 rounded-lg transition"><i data-feather="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>`;
                list.appendChild(div);
            });
            feather.replace();
        }

        function openAddSubject() { document.getElementById('modal-subject').classList.remove('hidden-view'); }
        function saveNewSubject() {
            const token = document.getElementById('new-token').value.trim().toUpperCase();
            const name = document.getElementById('new-mapel').value.trim();
            if(!token || !name) return alert("Data kurang");
            if(db[token]) return alert("Token sudah ada");
            db[token] = { name, questions: [] };
            saveDB();
            document.getElementById('modal-subject').classList.add('hidden-view');
            renderMapelList();
        }

        function deleteCurrentSubject() {
            if(!confirm("Hapus mapel ini beserta semua soalnya?")) return;
            delete db[activeTokenAdmin];
            saveDB();
            activeTokenAdmin = null;
            renderMapelList();
            document.getElementById('soal-editor-wrapper').classList.add('hidden');
            document.getElementById('empty-soal-state').classList.remove('hidden');
        }

        function openAddQuestion() { editingQIdx = null; showQModal(); }
        function editQ(idx) { 
            editingQIdx = idx; 
            const q = db[activeTokenAdmin].questions[idx];
            document.getElementById('editor-q').value = q.question;
            document.getElementById('editor-pts').value = q.points;
            const optList = document.getElementById('editor-opts');
            optList.innerHTML = '';
            q.options.forEach((o, i) => addOptInput(o, i === q.answer));
            document.getElementById('modal-question').classList.remove('hidden-view');
        }
        function deleteQ(idx) {
            if(!confirm("Hapus soal?")) return;
            db[activeTokenAdmin].questions.splice(idx, 1);
            saveDB(); renderSoalList(); renderMapelList();
        }

        function showQModal() {
            document.getElementById('editor-q').value = '';
            document.getElementById('editor-pts').value = 2.5;
            document.getElementById('editor-opts').innerHTML = '';
            addOptInput('', true); addOptInput('');
            document.getElementById('modal-question').classList.remove('hidden-view');
        }

        function addOptInput(val = '', isCorrect = false) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100";
            div.innerHTML = `<input type="radio" name="corr_ans" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500" ${isCorrect?'checked':''}><input type="text" class="flex-grow bg-transparent text-sm outline-none opt-val text-slate-700 font-medium placeholder:text-slate-400" value="${val}" placeholder="Teks jawaban..."><button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 transition"><i data-feather="x" class="w-4 h-4"></i></button>`;
            document.getElementById('editor-opts').appendChild(div);
            feather.replace();
        }

        function saveEditorQuestion() {
            const q = document.getElementById('editor-q').value;
            const pts = parseFloat(document.getElementById('editor-pts').value);
            const opts = [], radios = document.querySelectorAll('input[name="corr_ans"]');
            let ans = -1;
            
            document.querySelectorAll('.opt-val').forEach((inp, i) => {
                if(inp.value) { opts.push(inp.value); if(radios[i].checked) ans = i; }
            });

            if(!q || opts.length < 2 || ans === -1) return alert("Data soal tidak valid (Min 2 opsi & pilih kunci)");
            const newQ = { id: Date.now(), question: q, options: opts, answer: ans, points: pts };
            
            if(editingQIdx !== null) db[activeTokenAdmin].questions[editingQIdx] = newQ;
            else db[activeTokenAdmin].questions.push(newQ);
            
            saveDB();
            document.getElementById('modal-question').classList.add('hidden-view');
            renderSoalList();
            renderMapelList();
        }

        function showError(msg) {
            const el = document.getElementById('input-error');
            document.getElementById('error-text').textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
        function saveDB() { localStorage.setItem('cbt_db_v1', JSON.stringify(db)); }

        if(Object.keys(db).length === 0) {
            db = {
                "DEMO": {
                    name: "Ujian Demo Teknologi",
                    questions: [
                        {id:1, question:"Singkatan dari CPU?", options:["Central Processing Unit","Central Power Unit","Computer Personal Unit"], answer:0, points:10},
                        {id:2, question:"Port standar HTTP?", options:["21","80","443"], answer:1, points:10}
                    ]
                }
            };
            saveDB();
        }
    </script>
</body>
</html>
