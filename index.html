<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Pro - Ujian Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tiny.cloud/1/9z14k6t62t6o0y47e90lljhixhkauppy9wuvw4fzp964g856/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
       <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #2563eb; }
        
        /* Glassmorphism & Utils */
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-card-login { background: rgba(255, 255, 255, 1); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .modern-table th { background: #f8fafc; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 12px; border-bottom: 2px solid #e2e8f0; }
        .modern-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.875rem; vertical-align: middle; }
        .modern-table tr:hover { background: #f1f5f9; }
        
        /* Navigation Styles (Blue Border Effect) */
        .nav-item, .settings-nav-item { border-left: 4px solid transparent; transition: all 0.2s ease-in-out; }
        
        /* Main Menu Active */
        .nav-item.active-nav { 
            background-color: #eff6ff; 
            color: #2563eb; 
            border-left-color: #2563eb; /* Blue Border */
        }

        /* Settings Menu Active */
        .settings-nav-item.active { 
            background: linear-gradient(90deg, #eff6ff 0%, #ffffff 100%);
            color: #2563eb; 
            border-left-color: #2563eb; /* Blue Border */
            font-weight: 700;
        }
        
        .settings-nav-item:hover:not(.active), .nav-item:hover:not(.active-nav) { 
            background-color: #f8fafc; 
            border-left-color: #cbd5e1; 
        }

        /* Sub-tab Button */
        .sub-tab-btn { border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .sub-tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 700; }
        .sub-tab-btn:hover:not(.active) { color: #334155; border-bottom-color: #cbd5e1; }

        /* Dash Card */
        .dash-stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s; }
        .dash-stat-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transform: translateY(-2px); }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
        
        #admin-sidebar { transition: width 0.3s ease; }
        .sidebar-collapsed { width: 5rem !important; }
        .sidebar-collapsed .nav-text, .sidebar-collapsed .nav-header, .sidebar-collapsed #sidebar-logo { display: none; }
        .sidebar-collapsed #sidebar-icon-only { display: flex !important; }

        /* TinyMCE Z-Index Fix for Modals */
        .tox-tinymce-aux { z-index: 99999 !important; }
        .tox-tinymce { border-radius: 0.75rem !important; border-color: #e2e8f0 !important; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col bg-blue-600">

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9g4AUZ14a0_vbAXwJob9a4lSh7bwYwUDB9ISCaiScU2PNwTOyzGNtQ8Nlt9kqayQ/exec"; 
        const ADMIN_PIN = "2025"; 
        const MAX_VIOLATIONS = 3;
        var tokenInterval;
    </script>

    <!-- BACKGROUND -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-600 to-indigo-700"></div>
        <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-white opacity-10 blur-3xl"></div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col h-full overflow-hidden relative z-10">
        
        <!-- STUDENT HEADER -->
        <div id="student-header" class="w-full max-w-7xl mx-auto px-6 py-4 flex justify-between items-center transition-all duration-300">
            <div class="flex items-center gap-3 group cursor-default">
                <img id="school-logo-img" src="" alt="Logo" class="h-12 w-auto object-contain hidden bg-white rounded p-1 shadow-sm">
                <div id="default-logo" class="h-10 w-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i data-feather="box" class="w-6 h-6"></i>
                </div>
                <div><h1 class="font-bold text-xl leading-none text-white tracking-tight" id="school-name-display">CBT ONLINE</h1><p class="text-[11px] font-medium text-blue-100 uppercase tracking-wider mt-0.5">Secure Exam System</p></div>
            </div>
            <button onclick="showAdminLogin()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-md border border-white/10 transition flex items-center gap-2 shadow-sm"><i data-feather="lock" class="w-4 h-4"></i> Admin</button>
        </div>

        <!-- MAIN CONTENT -->
        <main class="flex-grow flex items-center justify-center p-4 overflow-hidden">

            <!-- 1. WELCOME VIEW -->
            <div id="view-welcome" class="glass-card-login w-full max-w-md p-10 fade-in relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <div class="text-center mb-8"><h2 class="text-3xl font-extrabold text-slate-800 mb-1">Login Peserta</h2><p class="text-slate-400 text-sm">Silakan masuk untuk memulai ujian</p></div>
                <div class="space-y-5">
                    <div><label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Nama Lengkap</label><div class="relative group"><i data-feather="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i><input type="text" id="input-nama" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-semibold text-slate-700" placeholder="Ketik nama Anda..."></div></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Kelas</label><div class="relative group"><select id="input-kelas" class="w-full pl-3 pr-8 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-bold text-slate-700 cursor-pointer appearance-none text-sm"></select><i data-feather="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                        <div><label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Jurusan</label><div class="relative group"><select id="input-jurusan" class="w-full pl-3 pr-8 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-bold text-slate-700 cursor-pointer appearance-none text-sm"></select><i data-feather="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                    </div>
                    <div id="token-input-group"><label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Token Soal</label><div class="relative group"><i data-feather="key" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i><input type="text" id="input-token" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-bold text-blue-600 text-center tracking-[0.2em] uppercase" placeholder="TOKEN"></div></div>
                </div>
                <div id="input-error" class="mt-4 hidden bg-red-50 border border-red-100 text-red-600 text-xs font-bold p-3 rounded-xl flex items-center animate-pulse"><i data-feather="alert-circle" class="w-4 h-4 mr-2 shrink-0"></i> <span id="error-text">Error</span></div>
                <button onclick="startQuiz()" class="w-full mt-8 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2 text-sm">Mulai Mengerjakan <i data-feather="arrow-right" class="w-4 h-4"></i></button>
            </div>

            <!-- 2. PLAYING VIEW -->
            <div id="view-playing" class="w-full max-w-5xl h-full flex flex-col hidden-view fade-in bg-slate-50 rounded-2xl overflow-hidden shadow-2xl">
                 <div class="bg-white border-b px-6 py-4 flex justify-between items-center">
                    <div class="flex gap-4 items-center"><div class="h-10 w-10 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold shadow-sm" id="avatar-initial">U</div><div><h3 class="font-bold text-slate-800 text-sm" id="play-name">User</h3><p class="text-xs text-slate-500 font-medium" id="play-info">Info</p></div></div>
                    <div class="flex items-center gap-3"><span class="text-xs font-bold text-slate-400 uppercase hidden sm:inline">Sisa Waktu</span><div class="font-mono text-xl font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg border border-blue-100" id="timer-display">--:--</div></div>
                 </div>
                 <div class="w-full h-1 bg-slate-200"><div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div></div>
                 <div class="flex-grow overflow-y-auto p-6 md:p-10 custom-scrollbar bg-slate-50">
                    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div class="mb-6 flex justify-between items-center"><span class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm shadow-blue-200">SOAL NO <span id="q-num">1</span></span><span id="q-type-badge" class="text-xs font-bold text-slate-400 uppercase">Pilihan Ganda</span></div>
                        <div id="q-media" class="mb-6 hidden rounded-xl overflow-hidden border border-slate-100"></div>
                        <div id="q-text" class="prose max-w-none text-slate-800 mb-8 leading-relaxed">Pertanyaan...</div>
                        <div id="options-container" class="space-y-3"></div>
                    </div>
                 </div>
                 <div class="p-5 border-t bg-white flex justify-between items-center">
                    <button id="btn-prev" onclick="prevQ()" class="px-5 py-2.5 rounded-xl border-2 border-slate-100 text-slate-500 font-bold text-sm hover:bg-slate-50 transition">Sebelumnya</button>
                    <button id="btn-next" onclick="nextQ()" class="px-6 py-2.5 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition flex items-center gap-2">Selanjutnya <i data-feather="arrow-right" class="w-4 h-4"></i></button>
                    <button id="btn-finish" onclick="finishQuiz()" class="hidden px-6 py-2.5 rounded-xl bg-emerald-500 text-white text-sm font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition">Selesai & Kumpulkan</button>
                 </div>
            </div>

            <!-- 3. ADMIN DASHBOARD -->
            <div id="view-admin" class="w-full h-full hidden-view fade-in flex overflow-hidden bg-slate-100">
                <aside id="admin-sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 transition-all duration-300 z-20">
                    <div class="h-16 flex items-center px-6 border-b border-slate-100">
                        <div id="sidebar-logo" class="flex items-center gap-3 font-bold text-lg text-slate-800"><div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-200"><i data-feather="command" class="w-5 h-5"></i></div><span>Admin<span class="text-blue-600">Panel</span></span></div>
                        <div id="sidebar-icon-only" class="hidden w-full justify-center"><div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i data-feather="command" class="w-5 h-5"></i></div></div>
                    </div>
                    <nav class="flex-grow p-4 space-y-1 overflow-y-auto custom-scrollbar">
                        <p class="nav-header px-4 text-[10px] font-extrabold text-slate-400 uppercase mb-2 mt-2 tracking-wider">Menu Utama</p>
                        <button onclick="adminNav('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 active-nav"><i data-feather="grid" class="w-5 h-5"></i> <span class="nav-text">Dashboard</span></button>
                        <button onclick="adminNav('students')" id="nav-students" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="users" class="w-5 h-5"></i> <span class="nav-text">Data Peserta</span></button>
                        <button onclick="adminNav('questions')" id="nav-questions" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="file-text" class="w-5 h-5"></i> <span class="nav-text">Bank Soal</span></button>
                        <button onclick="adminNav('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="settings" class="w-5 h-5"></i> <span class="nav-text">Pengaturan</span></button>
                    </nav>
                    <div class="p-4 border-t"><button onclick="logoutAdmin()" class="w-full py-2 text-sm font-bold text-red-500 bg-red-50 rounded-lg hover:bg-red-100">Logout</button></div>
                </aside>

                <div class="flex-grow flex flex-col h-full overflow-hidden relative">
                    <header class="bg-white h-16 border-b border-slate-200 px-4 flex justify-between items-center z-10 shrink-0">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i data-feather="menu" class="w-5 h-5"></i></button>
                            <div class="relative hidden md:block group"><i data-feather="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition"></i><input type="text" placeholder="Cari ujian..." class="pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition w-64"></div>
                        </div>
                        <div class="flex items-center gap-3 md:gap-5">
                            <div id="digital-clock" class="hidden md:block font-mono font-bold text-slate-600 text-sm bg-slate-50 px-3 py-1 rounded-md border border-slate-200">00:00:00 AM</div>
                            <button onclick="toggleFullScreen()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i data-feather="maximize" class="w-5 h-5"></i></button>
                            <div class="relative">
                                <button onclick="toggleProfileMenu()" class="flex items-center gap-3 hover:bg-slate-50 p-1.5 pr-3 rounded-lg transition border border-transparent hover:border-slate-200"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-8 w-8 rounded-full bg-blue-100 border border-blue-200"><div class="text-left hidden sm:block"><p class="text-xs font-bold text-slate-700">Administrator</p><p class="text-[10px] text-slate-400 font-medium">Super Admin</p></div><i data-feather="chevron-down" class="w-4 h-4 text-slate-400 ml-1"></i></button>
                                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 z-50">
                                    <a href="#" onclick="adminNav('settings'); switchSettingsTab('profile'); toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Profil Saya</a>
                                    <a href="#" onclick="adminNav('settings'); switchSettingsTab('about'); toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Tentang</a>
                                    <div class="border-t border-slate-50 my-1"></div>
                                    <button onclick="logoutAdmin()" class="w-full text-left px-4 py-2 text-sm text-red-500 font-bold hover:bg-red-50">Keluar</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div class="flex-grow overflow-y-auto custom-scrollbar p-6 md:p-8 bg-slate-50/50">
                        <!-- PANEL: DASHBOARD -->
                        <div id="admin-panel-dashboard" class="admin-panel space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="dash-stat-card col-span-2 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-feather="activity" class="w-24 h-24 text-blue-600"></i></div>
                                    <div class="flex justify-between items-start mb-6 relative z-10"><div><h3 class="font-bold text-slate-700 text-lg">Trafik Monitor</h3><p class="text-xs text-slate-400">Statistik koneksi real-time</p></div><button onclick="resetTrafficStats()" class="text-xs border border-slate-200 rounded-lg px-3 py-1.5 bg-white text-slate-500 hover:bg-slate-50 hover:text-red-500 font-bold shadow-sm">Reset Data</button></div>
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-8 relative z-10"><div class="pr-8 border-r border-slate-100"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">SOCKET</p><p class="text-4xl font-black text-blue-600" id="stat-socket">860</p></div><div><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">HTTP REQUESTS</p><div class="flex items-baseline gap-2"><p class="text-4xl font-black text-indigo-600" id="stat-http">11,268</p><span class="text-xs text-slate-400 font-medium">Total Hits</span></div></div></div>
                                </div>
                                <div class="dash-stat-card flex flex-col justify-between relative overflow-hidden">
                                    <div><div class="flex justify-between items-start"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">TOKEN UJIAN</p><div class="w-6 h-6 rounded-full border-2 border-blue-100 border-t-blue-500 animate-spin"></div></div><h3 class="text-4xl font-black text-slate-800 tracking-wider mt-2 mb-1 font-mono" id="dash-token">D5YNRG</h3><p class="text-xs text-slate-500 font-medium">Masa aktif <span class="text-blue-600 font-bold" id="token-timer-display">--:--</span></p></div>
                                    <button onclick="generateNewToken()" class="mt-6 w-full bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-3 rounded-xl shadow-lg shadow-emerald-100 flex items-center justify-center gap-2"><i data-feather="refresh-cw" class="w-4 h-4"></i> Perbaharui Token</button>
                                </div>
                            </div>

                            <!-- Row 2: Stat Cards (Updated Logic) -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700">954</p><p class="text-xs text-slate-400 mt-1">Total Koneksi</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> 1 terhubung</div></div>
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700" id="stat-total-students">0</p><p class="text-xs text-slate-400 mt-1">Total Peserta</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> Online</div></div>
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700">1</p><p class="text-xs text-slate-400 mt-1">Total Pengawas</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> Online</div></div>
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700">4</p><p class="text-xs text-slate-400 mt-1">Total Pengelola</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> Online</div></div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="dash-stat-card"><p class="text-2xl font-bold text-slate-700" id="stat-total-classes">0</p><p class="text-xs text-slate-400">Total Kelas</p></div>
                                <div class="dash-stat-card"><p class="text-2xl font-bold text-slate-700" id="stat-total-majors">0</p><p class="text-xs text-slate-400">Total Jurusan</p></div>
                                <div class="dash-stat-card"><p class="text-2xl font-bold text-slate-700" id="stat-total-exams">0</p><p class="text-xs text-slate-400">Total Ujian <span class="text-emerald-500 font-bold">[Aktif]</span></p></div>
                            </div>
                        </div>

                        <!-- PANEL: SETTINGS -->
                        <div id="admin-panel-settings" class="admin-panel hidden-view h-full">
                            <h3 class="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2"><i data-feather="settings" class="text-slate-400"></i> Pengaturan Aplikasi</h3>
                            
                            <div class="flex flex-col lg:flex-row gap-6 h-[calc(100%-4rem)]">
                                <div class="w-full lg:w-64 bg-white rounded-2xl border border-slate-200 h-fit lg:h-full overflow-y-auto shadow-sm shrink-0">
                                    <nav class="p-3 space-y-1">
                                        <button onclick="switchSettingsTab('profile')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition active" id="set-nav-profile"><i data-feather="user" class="w-4 h-4"></i> Profil Saya</button>
                                        <button onclick="switchSettingsTab('token')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-token"><i data-feather="key" class="w-4 h-4"></i> Token</button>
                                        <button onclick="switchSettingsTab('access')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-access"><i data-feather="shield" class="w-4 h-4"></i> Kelola Akses</button>
                                        <button onclick="switchSettingsTab('license')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-license"><i data-feather="file-minus" class="w-4 h-4"></i> Lisensi</button>
                                        <button onclick="switchSettingsTab('others')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-others"><i data-feather="sliders" class="w-4 h-4"></i> Lainnya</button>
                                        <button onclick="switchSettingsTab('about')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-about"><i data-feather="info" class="w-4 h-4"></i> Tentang</button>
                                    </nav>
                                </div>

                                <div class="flex-grow bg-white rounded-2xl border border-slate-200 shadow-sm p-8 overflow-y-auto">
                                    <!-- 1. PROFIL -->
                                    <div id="set-content-profile" class="settings-content">
                                        <div class="flex flex-col items-center mb-8"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-24 w-24 rounded-full bg-slate-100 border-4 border-white shadow-lg mb-4"><h2 class="text-2xl font-bold text-slate-800">Administrator</h2><p class="text-sm text-slate-500">administrator</p></div>
                                        <div class="col-span-2"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-slate-700">Riwayat Login:</h4><button onclick="clearLoginHistory()" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">Bersihkan Riwayat!</button></div><table class="w-full text-left text-sm border rounded-lg overflow-hidden"><thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold"><tr><th class="p-3">Berhasil Login</th><th class="p-3">IP</th><th class="p-3">OS</th><th class="p-3">Browser</th></tr></thead><tbody class="text-slate-600" id="login-history-body"><tr class="border-b"><td class="p-3">sejam yang lalu</td><td class="p-3">::1</td><td class="p-3">Windows 10</td><td class="p-3">Firefox 145.0</td></tr><tr class="border-b"><td class="p-3">14 jam yang lalu</td><td class="p-3">::1</td><td class="p-3">Windows 10</td><td class="p-3">Chrome 142.0.0.0</td></tr></tbody></table></div>
                                    </div>
                                    <!-- 2. TOKEN -->
                                    <div id="set-content-token" class="settings-content hidden-view">
                                        <div class="mb-8"><h3 class="text-4xl font-black text-slate-800 tracking-wider mb-1 font-mono" id="setting-token-display">NOFDTI</h3><p class="text-sm text-slate-500 font-medium">Masa hidup token <span class="text-blue-600 font-bold" id="token-timer-settings">--:--</span></p><button onclick="generateNewToken()" class="mt-4 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow-md">Perbaharui Token!</button></div>
                                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-6"><p class="text-sm text-slate-600 mb-6">Token digunakan untuk melakukan konfirmasi peserta terhadap pengelola ujian.</p><div class="flex items-center justify-between mb-6"><label class="text-sm font-bold text-slate-700">Gunakan Token?</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" id="toggle-token" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 checked:border-blue-600"/><label for="toggle-token" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between mb-6"><label class="text-sm font-bold text-slate-700">Masa Hidup (menit)</label><input type="number" id="token-duration" class="w-24 border border-slate-300 rounded-lg p-2 text-center text-sm font-bold outline-none" value="60"></div><div class="text-right"><button onclick="saveTokenSettings()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700">Simpan</button></div></div>
                                    </div>
                                    <!-- 3. LISENSI -->
                                    <div id="set-content-license" class="settings-content hidden-view">
                                        <h4 class="text-lg font-bold text-slate-800 border-b border-slate-100 pb-4 mb-6">Lisensi Aplikasi</h4>
                                        <div class="space-y-4 max-w-3xl">
                                            <div class="flex flex-col sm:flex-row gap-4 items-center bg-slate-50 p-4 rounded-lg border border-slate-100"><span class="text-sm font-bold text-slate-500 w-48">Nomor Serial</span><code class="bg-white border p-2 rounded text-xs font-mono text-slate-600 break-all flex-grow text-center sm:text-left">aaf2-1383-55dd-3da8-b0a3-e6f6-33f4-c4da</code></div>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-8 p-2">
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Nama Instansi</span><p class="text-sm font-medium text-slate-700 mt-1">[demo] - Utama</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">E-Mail</span><p class="text-sm font-medium text-slate-700 mt-1">bebiiigital@gmail.com</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Diterbitkan</span><p class="text-sm font-medium text-slate-700 mt-1">28 November 2025, 9:03 AM</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Versi</span><p class="text-sm font-medium text-slate-700 mt-1">1.20.9</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Masa Aktif</span><p class="text-sm font-bold text-emerald-600 mt-1">Unlimited</p></div>
                                            </div>
                                            <div class="pt-6 text-right border-t border-slate-100 mt-6"><button onclick="document.getElementById('modal-license-update').classList.remove('hidden-view')" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold text-sm hover:bg-blue-700 shadow-lg shadow-blue-200 transition">Update Serial Number</button></div>
                                        </div>
                                    </div>
                                    <!-- 4. LAINNYA (SPLIT SUB-TABS) -->
                                    <div id="set-content-others" class="settings-content hidden-view">
                                        <div class="flex space-x-4 border-b border-slate-200 mb-6">
                                            <button onclick="showSubTab('logo')" class="sub-tab-btn active pb-2 text-sm font-medium">Logo</button>
                                            <button onclick="showSubTab('school')" class="sub-tab-btn pb-2 text-sm font-medium">Info Sekolah</button>
                                            <button onclick="showSubTab('rules')" class="sub-tab-btn pb-2 text-sm font-medium">Panduan</button>
                                        </div>
                                        <div id="sub-logo" class="sub-tab-content">
                                            <h4 class="text-lg font-bold text-slate-800 mb-4">Logo Aplikasi</h4>
                                            <div class="flex gap-6 items-start"><div class="h-20 w-20 bg-white border rounded-xl flex items-center justify-center overflow-hidden shadow-sm"><img id="preview-logo-upload" src="" class="h-full w-full object-contain hidden"><i data-feather="image" class="text-slate-300" id="preview-logo-placeholder"></i></div><div class="flex-grow"><div class="flex border rounded-lg overflow-hidden mb-2"><label class="bg-slate-50 border-r px-4 py-2 text-sm font-bold text-slate-600 cursor-pointer hover:bg-slate-100">Upload <input type="file" class="hidden" accept="image/*" onchange="handleLogoUpload(this)"></label><input class="flex-grow px-4 text-sm text-slate-500 bg-white" placeholder="No file" id="filename-logo" readonly></div><div class="flex gap-2"><button onclick="saveLogoLocal()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs font-bold">Simpan Logo</button><button onclick="resetLogo()" class="bg-red-100 text-red-600 px-4 py-1.5 rounded text-xs font-bold">Reset</button></div></div></div>
                                        </div>
                                        <!-- UPDATED SCHOOL INFO TAB -->
                                        <div id="sub-school" class="sub-tab-content hidden">
                                            <h4 class="text-lg font-bold text-slate-800 mb-4">Informasi Sekolah</h4>
                                            <div class="space-y-4 max-w-2xl">
                                                <!-- Nama Sekolah -->
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Sekolah</label>
                                                    <input id="sch-name" class="w-full border p-2 rounded-lg text-sm" value="SMA NEGERI">
                                                </div>
                                                
                                                <!-- Jenjang Sekolah (NEW) -->
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenjang Sekolah</label>
                                                    <div class="relative">
                                                        <select id="sch-level" class="w-full border p-2 rounded-lg text-sm appearance-none bg-white">
                                                            <option value="">Pilih Jenjang</option>
                                                            <option value="SD/MI">Setingkat SD/MI</option>
                                                            <option value="SMP/Mts">Setingkat SMP/Mts</option>
                                                            <option value="SMA/SMK/MA">Setingkat SMA/SMK/MA</option>
                                                        </select>
                                                        <i data-feather="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                                    </div>
                                                </div>

                                                <!-- Alamat -->
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Alamat Sekolah</label>
                                                    <textarea id="sch-addr" class="w-full border p-2 rounded-lg text-sm" rows="2"></textarea>
                                                </div>

                                                <!-- Email -->
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email Sekolah</label>
                                                    <input id="sch-email" class="w-full border p-2 rounded-lg text-sm">
                                                </div>

                                                <!-- Website -->
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Website Sekolah</label>
                                                    <input id="sch-web" class="w-full border p-2 rounded-lg text-sm">
                                                </div>

                                                <button onclick="saveSchoolInfo()" class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold">Simpan Info</button>
                                            </div>
                                        </div>
                                        <!-- END UPDATED SCHOOL INFO TAB -->
                                        
                                        <div id="sub-rules" class="sub-tab-content hidden">
                                            <h4 class="text-lg font-bold text-slate-800 mb-4">Panduan & Tata Tertib</h4>
                                            <div class="flex items-center gap-3 mb-4"><label class="text-sm font-bold text-slate-600">Tampilkan?</label><div class="relative inline-block w-10 mr-2 align-middle select-none"><input type="checkbox" id="toggle-rules" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 checked:border-blue-600"/><label for="toggle-rules" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label></div></div>
                                            <!-- TinyMCE Applied here via ID -->
                                            <textarea id="rules-content" class="w-full border rounded-xl p-4 text-sm h-64" placeholder="Tulis panduan..."></textarea>
                                            <button onclick="saveRules()" class="mt-4 bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold">Simpan Panduan</button>
                                        </div>
                                    </div>
                                    <!-- 5. TENTANG & PLACEHOLDERS -->
                                    <div id="set-content-about" class="settings-content hidden-view text-center py-10">...</div>
                                    <div id="set-content-access" class="settings-content hidden-view text-center text-slate-400 py-20">Manajemen Akses User.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- OTHER ADMIN PANELS (Students, Questions) -->
                        <div id="admin-panel-students" class="admin-panel hidden-view"><div class="flex justify-between bg-white p-6 rounded-xl shadow-sm border mb-4"><h3 class="font-bold text-lg text-slate-700">Daftar Peserta</h3><button onclick="openStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Tambah</button></div><div class="bg-white rounded-xl border border-slate-200 overflow-hidden"><table class="w-full text-left"><thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b"><tr><th class="px-6 py-3">Foto</th><th class="px-6 py-3">Nama</th><th class="px-6 py-3">Kelas</th><th class="px-6 py-3 text-right">Aksi</th></tr></thead><tbody id="table-students-body"></tbody></table></div></div>
                        <div id="admin-panel-questions" class="admin-panel hidden-view"><div class="bg-white p-6 rounded-xl border border-slate-200 h-full flex flex-col shadow-sm"><div class="flex justify-between items-center mb-6"><div><h3 class="font-bold text-xl text-slate-800">Bank Soal</h3></div><div class="flex gap-2"><button onclick="downloadTemplateWord()" class="border px-4 py-2 rounded-lg text-xs font-bold">Template Word</button><button onclick="openAddSubject()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold">+ Mapel</button></div></div><div class="flex-grow flex gap-4 overflow-hidden"><div class="w-64 bg-slate-50 border rounded-xl p-4 overflow-y-auto custom-scrollbar" id="mapel-list"></div><div class="flex-grow border rounded-xl flex flex-col overflow-hidden relative"><div id="soal-header" class="p-4 border-b flex justify-between items-center bg-white hidden z-10 shadow-sm"><h4 class="font-bold text-blue-700 text-lg" id="active-mapel-title">Mapel</h4><button onclick="openAddQuestion()" class="text-xs bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold">+ Soal</button></div><div id="soal-list" class="flex-grow overflow-y-auto p-6 space-y-4 bg-slate-50/30 custom-scrollbar relative"></div></div></div></div></div>
                    </div>
                </div>
            </div>

            <!-- RESULT VIEW -->
            <div id="view-result-card" class="hidden-view glass-card w-full max-w-md p-8 text-center m-auto fade-in bg-white rounded-2xl shadow-2xl"><h2 class="text-2xl font-bold mb-2 text-slate-800" id="res-title">Selesai</h2><p class="text-sm text-slate-500 mb-6" id="res-msg"></p><div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100"><div class="text-5xl font-black text-blue-600" id="res-score">0</div></div><button onclick="location.reload()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold hover:bg-slate-900">Keluar</button></div>

        </main>
    </div>

    <!-- MODALS (Login, License, Student, Question, Subject) -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 hidden-view backdrop-blur-sm"><div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center"><h3 class="font-bold text-lg mb-6">Admin Login</h3><input type="password" id="pin-input" class="w-full text-center text-3xl font-bold tracking-widest border-b-2 py-2 outline-none mb-8" maxlength="4"><div class="flex gap-2"><button onclick="document.getElementById('modal-login').classList.add('hidden-view')" class="flex-1 py-2 bg-slate-100 rounded font-bold text-slate-500">Batal</button><button onclick="checkAdminPin()" class="flex-1 py-2 bg-blue-600 text-white rounded font-bold">Masuk</button></div></div></div>
    <div id="modal-license-update" class="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 hidden-view backdrop-blur-sm"><div class="bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl text-slate-800">Update Serial Number</h3><button onclick="document.getElementById('modal-license-update').classList.add('hidden-view')" class="text-slate-400 hover:text-red-500"><i data-feather="x"></i></button></div><div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6"><p class="text-center font-bold text-slate-600 mb-2">Application Key!</p><textarea readonly class="w-full bg-white border border-slate-200 rounded p-2 text-xs font-mono text-slate-500 h-24 resize-none outline-none">U2FsdGVkX1...</textarea></div><div class="mb-6"><textarea id="input-serial" class="w-full border border-slate-300 rounded-lg p-3 text-sm h-24 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukan serial number!"></textarea></div><div class="flex justify-end gap-2"><button onclick="document.getElementById('modal-license-update').classList.add('hidden-view')" class="px-4 py-2 bg-slate-100 text-slate-600 font-bold rounded-lg hover:bg-slate-200">Tutup</button><button onclick="alert('Serial Number Berhasil Diupdate!')" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Update dan Verifikasi</button></div></div></div>
    <div id="modal-student" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view"><div class="bg-white p-6 rounded-xl w-96"><h3 class="font-bold mb-4" id="student-modal-title">Peserta</h3><div class="space-y-3"><input id="std-name" class="w-full border p-2 rounded" placeholder="Nama"><select id="std-class" class="w-full border p-2 rounded"></select><select id="std-major" class="w-full border p-2 rounded"></select><input id="std-score" type="number" class="w-full border p-2 rounded" placeholder="Nilai"></div><div class="mt-4 flex justify-end gap-2"><button onclick="closeStudentModal()" class="px-4 py-2 text-slate-500">Batal</button><button onclick="saveStudent()" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button></div></div></div>
    
    <!-- QUESTION MODAL (UPDATED FOR TINYMCE) -->
    <div id="modal-question" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view">
        <div class="bg-white p-6 rounded-xl w-[900px] h-[90vh] flex flex-col">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Editor Soal</h3>
            <!-- TinyMCE Applied here via ID ed-q -->
            <textarea id="ed-q" class="w-full border p-3 rounded-xl h-64 mb-3 text-sm" placeholder="Pertanyaan"></textarea>
            
            <div id="ed-opts-container" class="flex-grow overflow-y-auto space-y-2 mt-4 p-2 border-t"></div>
            <button onclick="addEditorOpt()" class="text-blue-600 text-sm font-bold mt-2 mb-4">+ Opsi</button>
            <input id="ed-type" type="hidden"><input id="ed-media" type="hidden">
            <div class="pt-4 border-t flex justify-end gap-2">
                <button onclick="document.getElementById('modal-question').classList.add('hidden-view')" class="px-4 py-2 text-slate-500 font-bold">Batal</button>
                <button onclick="saveQuestion()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Simpan</button>
            </div>
        </div>
    </div>
    
    <div id="modal-subject" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view"><div class="bg-white p-6 rounded w-80"><input id="new-token" class="w-full border p-2 mb-2 uppercase" placeholder="TOKEN"><input id="new-mapel" class="w-full border p-2 mb-4" placeholder="Mapel"><button onclick="saveNewSubject()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Simpan</button><button onclick="document.getElementById('modal-subject').classList.add('hidden-view')" class="w-full mt-2 text-slate-500">Batal</button></div></div>

    <script>
        feather.replace();
        let db = JSON.parse(localStorage.getItem('cbt_db_v4') || '{}');
        let config = { logo: "", classes: ["X", "XI", "XII"], majors: ["FARMASI 1", "FARMASI 2", "KEPERAWATAN 1", "KEPERAWATAN 2", "TJKT 1", "TJKT 2", "TBSM 1", "TBSM 2", "TKR"], tokenDuration: 105 };
        let adminDataCache = [], editingStudentIdx = null, activeTokenAdmin = null, editingQIdx = null;
        
        function init() {
            updateDropdowns();
            const savedToken = localStorage.getItem('cbt_token_dash');
            if(savedToken) document.getElementById('dash-token').textContent = savedToken;
            if(document.getElementById('setting-token-display')) document.getElementById('setting-token-display').textContent = savedToken || "NOFDTI";

            const tokenDur = localStorage.getItem('cbt_token_duration');
            const useTok = localStorage.getItem('cbt_token_active');
            if(tokenDur) { config.tokenDuration = parseInt(tokenDur); document.getElementById('token-duration').value = config.tokenDuration; }
            if(useTok !== null) document.getElementById('toggle-token').checked = (useTok === 'true');

            startTokenTimer();
            const savedLogo = localStorage.getItem('school_logo_url_base64');
            if(savedLogo) applyLogo(savedLogo);
            setInterval(() => { const now = new Date(); if(document.getElementById('digital-clock')) document.getElementById('digital-clock').textContent = now.toLocaleTimeString(); }, 1000);
            
            // UPDATED SCHOOL INFO LOADER
            if(localStorage.getItem('school_info')) { 
                const si = JSON.parse(localStorage.getItem('school_info')); 
                if(document.getElementById('sch-name')) document.getElementById('sch-name').value = si.name || ''; 
                if(document.getElementById('sch-level')) document.getElementById('sch-level').value = si.level || ''; 
                if(document.getElementById('sch-addr')) document.getElementById('sch-addr').value = si.addr || ''; 
                if(document.getElementById('sch-email')) document.getElementById('sch-email').value = si.email || ''; 
                if(document.getElementById('sch-web')) document.getElementById('sch-web').value = si.web || ''; 
                // Update Header
                if(document.getElementById('school-name-display')) document.getElementById('school-name-display').textContent = si.name || 'CBT ONLINE';
            }
            
            // Auto Load Admin Stats on Init if data exists
            if(localStorage.getItem('cbt_admin_cache')) {
                adminDataCache = JSON.parse(localStorage.getItem('cbt_admin_cache'));
                updateDashboardStats();
            }

            // INIT TINYMCE
            tinymce.init({
                selector: '#rules-content, #ed-q',
                height: 300,
                menubar: 'edit view insert format table',
                plugins: 'link image code table lists',
                toolbar: 'fullscreen | fontfamily fontsize | bold italic underline strikethrough | alignleft aligncenter alignright | bullist numlist | link image | table',
                dropdown_container_body: true,
                promotion: false, // Hide upgrade button
                branding: false   // Hide branding
            });
        }
        init();

        function updateDashboardStats() { 
            // Update real stats
            document.getElementById('stat-total-students').textContent = adminDataCache.length; 
            document.getElementById('stat-total-exams').textContent = Object.keys(db).length;
            document.getElementById('stat-total-classes').textContent = config.classes.length;
            document.getElementById('stat-total-majors').textContent = config.majors.length;
        }

        function startTokenTimer() {
            const totalSecs = config.tokenDuration * 60;
            let elapsed = 0;
            if (tokenInterval) clearInterval(tokenInterval);
            tokenInterval = setInterval(() => {
                elapsed++;
                const remaining = totalSecs - elapsed;
                if(remaining <= 0) {
                     const expText = "Expired";
                     if(document.getElementById('token-timer-display')) document.getElementById('token-timer-display').textContent = expText;
                     if(document.getElementById('token-timer-settings')) document.getElementById('token-timer-settings').textContent = expText;
                     return;
                }
                const h = Math.floor(remaining / 3600);
                const m = Math.floor((remaining % 3600) / 60);
                const s = remaining % 60;
                const timeStr = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(document.getElementById('token-timer-display')) document.getElementById('token-timer-display').textContent = timeStr;
                if(document.getElementById('token-timer-settings')) document.getElementById('token-timer-settings').textContent = timeStr;
            }, 1000);
        }

        function saveTokenSettings() {
            const dur = document.getElementById('token-duration').value;
            const isActive = document.getElementById('toggle-token').checked;
            localStorage.setItem('cbt_token_duration', dur);
            localStorage.setItem('cbt_token_active', isActive);
            config.tokenDuration = parseInt(dur);
            alert("Pengaturan Token Disimpan!");
            startTokenTimer();
        }

        function clearLoginHistory() {
             document.getElementById('login-history-body').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">Riwayat login telah dibersihkan.</td></tr>';
             alert("Riwayat berhasil dihapus.");
        }

        function updateDropdowns() {
            const optsC = '<option value="">Pilih</option>' + config.classes.map(c => `<option>${c}</option>`).join('');
            const optsM = '<option value="">Pilih</option>' + config.majors.map(m => `<option>${m}</option>`).join('');
            ['input-kelas', 'std-class'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = optsC; });
            ['input-jurusan', 'std-major'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = optsM; });
        }

        function showSubTab(subName) {
            document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`sub-${subName}`).classList.remove('hidden');
            document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        function switchSettingsTab(tabName) {
            document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`set-content-${tabName}`).classList.remove('hidden-view');
            document.querySelectorAll('.settings-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`set-nav-${tabName}`).classList.add('active');
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-logo-upload').src = e.target.result;
                    document.getElementById('preview-logo-upload').classList.remove('hidden');
                    document.getElementById('preview-logo-placeholder').classList.add('hidden');
                    document.getElementById('filename-logo').value = input.files[0].name;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveLogoLocal() {
            const img = document.getElementById('preview-logo-upload').src;
            if(!img || img.includes(window.location.href)) return alert("Pilih gambar logo terlebih dahulu.");
            localStorage.setItem('school_logo_url_base64', img);
            applyLogo(img);
            alert("Logo berhasil disimpan!");
        }

        function resetLogo() { localStorage.removeItem('school_logo_url_base64'); location.reload(); }
        function applyLogo(src) {
            const logoImg = document.getElementById('school-logo-img');
            if(logoImg) {
                logoImg.src = src;
                logoImg.classList.remove('hidden');
                document.getElementById('default-logo').classList.add('hidden');
            }
        }
        
        function saveSchoolInfo() {
            const info = { 
                name: document.getElementById('sch-name').value, 
                level: document.getElementById('sch-level').value, 
                addr: document.getElementById('sch-addr').value,
                email: document.getElementById('sch-email').value,
                web: document.getElementById('sch-web').value
            };
            localStorage.setItem('school_info', JSON.stringify(info));
            if(document.getElementById('school-name-display')) document.getElementById('school-name-display').textContent = info.name || 'CBT ONLINE';
            alert("Informasi Sekolah Tersimpan!");
        }
        
        // UPDATED SAVE RULES (Use TinyMCE)
        function saveRules() { 
            const content = tinymce.get('rules-content').getContent();
            // console.log("Rules Saved:", content);
            alert("Panduan tersimpan (Visual Editor)!"); 
        }

        // --- NAVIGATION ---
        const nav = (id) => {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden-view'));
            document.getElementById(`view-${id}`).classList.remove('hidden-view');
            document.getElementById('student-header').style.display = id === 'welcome' ? 'flex' : 'none';
        };

        function toggleSidebar() { const sb = document.getElementById('admin-sidebar'); sb.classList.toggle('w-64'); sb.classList.toggle('w-0'); sb.classList.toggle('px-0'); sb.classList.toggle('overflow-hidden'); }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else if (document.exitFullscreen) document.exitFullscreen(); }
        function toggleProfileMenu() { document.getElementById('profile-menu').classList.toggle('hidden'); }

        // --- ADMIN ---
        function showAdminLogin() { document.getElementById('modal-login').classList.remove('hidden-view'); }
        function checkAdminPin() {
            if(document.getElementById('pin-input').value === ADMIN_PIN) {
                document.getElementById('modal-login').classList.add('hidden-view');
                nav('admin'); adminNav('dashboard'); fetchAdminData();
            } else alert("PIN Salah");
        }
        function logoutAdmin() { nav('welcome'); document.getElementById('pin-input').value = ''; document.getElementById('profile-menu').classList.add('hidden'); }
        function adminNav(tab) {
            document.querySelectorAll('.admin-panel').forEach(e => e.classList.add('hidden-view'));
            document.getElementById(`admin-panel-${tab}`).classList.remove('hidden-view');
            document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('active-nav'); });
            document.getElementById(`nav-${tab}`).classList.add('active-nav');
            if(tab === 'questions') renderMapelList();
            if(tab === 'settings') switchSettingsTab('profile'); 
        }

        function generateNewToken() { 
            const chars = "ABCDEF0123456789"; 
            let result = ""; for(let i=0; i<6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); 
            document.getElementById('dash-token').textContent = result; 
            if(document.getElementById('setting-token-display')) document.getElementById('setting-token-display').textContent = result; 
            localStorage.setItem('cbt_token_dash', result); 
            startTokenTimer(); 
        }
        function resetTrafficStats() { 
            document.getElementById('stat-socket').textContent='0'; document.getElementById('stat-http').textContent='0'; 
            document.getElementById('stat-socket').classList.add('animate-pulse');
            setTimeout(() => document.getElementById('stat-socket').classList.remove('animate-pulse'), 500);
        }

        // --- DATA ---
        async function fetchAdminData() {
            const btn = document.getElementById('btn-refresh'); const icon = btn ? btn.querySelector('i') : null; if(icon) icon.classList.add('animate-spin');
            if(GOOGLE_SCRIPT_URL) { 
                try { 
                    const res = await fetch(GOOGLE_SCRIPT_URL); 
                    const data = await res.json(); 
                    if(data.students) {
                        adminDataCache = data.students;
                        localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache)); // Cache for stats
                    } 
                } catch(e) {} 
            }
            renderAdminTables(); updateDashboardStats(); if(icon) icon.classList.remove('animate-spin');
        }
        function renderAdminTables() {
            const dashRows = adminDataCache.slice(0, 10).map(s => `<tr><td class="px-6 py-3">${new Date(s.timestamp).toLocaleTimeString()}</td><td class="px-6 py-3 font-bold">${s.nama}</td><td class="px-6 py-3 text-xs">${s.kelas} ${s.jurusan}</td><td class="px-6 py-3">${s.mapel}</td><td class="px-6 py-3 font-bold text-blue-600">${s.nilaiAkhir}</td><td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${s.nilaiAkhir>=75?'bg-emerald-100 text-emerald-600':'bg-red-100 text-red-600'}">${s.nilaiAkhir>=75?'Lulus':'Remidi'}</span></td></tr>`).join('');
            if(document.getElementById('table-results-body')) document.getElementById('table-results-body').innerHTML = dashRows;
            const studRows = adminDataCache.map((s, i) => `<tr><td class="px-6 py-3"><div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs">${s.nama[0]}</div></td><td class="px-6 py-3 font-medium">${s.nama}</td><td class="px-6 py-3 text-slate-500">${s.kelas}</td><td class="px-6 py-3 text-slate-500">${s.jurusan}</td><td class="px-6 py-3 text-right"><button onclick="editStudent(${i})" class="text-blue-500 mr-2 hover:underline">Edit</button><button onclick="deleteStudent(${i})" class="text-red-500 hover:underline">Hapus</button></td></tr>`).join('');
            document.getElementById('table-students-body').innerHTML = studRows;
        }
        function downloadExcel() { if(adminDataCache.length === 0) return alert("Tidak ada data."); const exportData = adminDataCache.map(s => ({ "Waktu": new Date(s.timestamp).toLocaleString(), "Nama": s.nama, "Kelas": s.kelas, "Jurusan": s.jurusan, "Mapel": s.mapel, "Nilai": s.nilaiAkhir })); const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(exportData); XLSX.utils.book_append_sheet(wb, ws, "Hasil Ujian"); XLSX.writeFile(wb, "Rekap_Nilai.xlsx"); }

        // --- EXAM ---
        function startQuiz() {
            const name = document.getElementById('input-nama').value; const cls = document.getElementById('input-kelas').value; const mjr = document.getElementById('input-jurusan').value; const token = document.getElementById('input-token').value.toUpperCase();
            if(!name || !cls || !mjr || !token) return alert("Lengkapi Data!");
            
            // Token Check Fixed
            const useToken = localStorage.getItem('cbt_token_active') !== 'false'; 
            if(useToken) {
                if(!db[token]) return alert("Token Soal Salah!");
            } else {
                if(!db[token]) return alert("Token tidak ditemukan di database (Diperlukan untuk memuat soal)");
            }

            userData = { name, cls, mjr, mapel: db[token].name };
            currentQuestions = JSON.parse(JSON.stringify(db[token].questions)).sort(() => Math.random() - 0.5);
            currentQ=0; userAnswers={}; violations=0; startTime=new Date();
            document.getElementById('play-name').textContent = name; document.getElementById('avatar-initial').textContent = name[0]; document.getElementById('play-info').textContent = `${cls}  ${mjr}`;
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
            nav('playing'); renderQ(); startTimer();
        }
        function renderQ() {
            const q = currentQuestions[currentQ]; const type = q.type || 'pg';
            document.getElementById('q-num').textContent = currentQ+1; 
            
            // Render HTML content for question text since we use TinyMCE
            document.getElementById('q-text').innerHTML = q.question; 
            
            document.getElementById('q-type-badge').textContent = type === 'pg' ? 'Pilihan Ganda' : 'Essay';
            document.getElementById('progress-bar').style.width = `${((currentQ+1)/currentQuestions.length)*100}%`;
            const cont = document.getElementById('options-container'); cont.innerHTML = '';
            if (type === 'essay') { cont.innerHTML = `<textarea class="w-full border p-3 rounded-xl" rows="5" placeholder="Jawab..." onchange="userAnswers[currentQ]=this.value">${userAnswers[currentQ] || ''}</textarea>`; } 
            else { q.options.forEach((opt, i) => { const isSel = userAnswers[currentQ] === i; const btn = document.createElement('button'); btn.className = `w-full text-left p-4 rounded-xl border transition flex gap-3 items-center ${isSel ? 'border-blue-600 bg-blue-50 text-blue-800' : 'hover:bg-slate-50'}`; btn.onclick = () => { userAnswers[currentQ] = i; renderQ(); }; btn.innerHTML = `<span class="font-bold text-sm ${isSel?'text-blue-600':'text-slate-400'}">${String.fromCharCode(65+i)}.</span> <span>${opt}</span>`; cont.appendChild(btn); }); }
            document.getElementById('btn-prev').disabled = currentQ===0;
            const isLast = currentQ===currentQuestions.length-1;
            document.getElementById('btn-next').classList.toggle('hidden', isLast);
            document.getElementById('btn-finish').classList.toggle('hidden', !isLast);
        }
        function nextQ() { if(currentQ<currentQuestions.length-1){currentQ++; renderQ();} }
        function prevQ() { if(currentQ>0){currentQ--; renderQ();} }
        async function finishQuiz() {
            clearInterval(timer); if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});
            let score = 0, maxScore = 0;
            currentQuestions.forEach((q, i) => { maxScore+=(parseFloat(q.points)||1); if(userAnswers[i]==q.answer) score+=(parseFloat(q.points)||1); });
            const final = maxScore > 0 ? Math.round((score/maxScore)*100) : 0;
            nav('result-card'); document.getElementById('res-score').textContent = final;
        }
        function startTimer() { timer = setInterval(() => { const diff = new Date() - startTime; const m = Math.floor(diff/60000).toString().padStart(2,'0'); const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0'); document.getElementById('timer-display').textContent = `${m}:${s}`; }, 1000); }
        
        // Local CRUD
        function openStudentModal(idx=null) { editingStudentIdx = idx; document.getElementById('modal-student').classList.remove('hidden-view'); if(idx !== null) { const s = adminDataCache[idx]; document.getElementById('std-name').value=s.nama; } else { document.getElementById('std-name').value=''; } }
        function closeStudentModal() { document.getElementById('modal-student').classList.add('hidden-view'); }
        function saveStudent() { closeStudentModal(); renderAdminTables(); }
        function deleteStudent(idx) { adminDataCache.splice(idx,1); renderAdminTables(); }
        function renderMapelList() { const l = document.getElementById('mapel-list'); l.innerHTML = ''; Object.keys(db).forEach(k => { const d = document.createElement('div'); d.className = "p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2"; d.innerHTML = `<b>${db[k].name}</b> <span class="text-xs text-slate-400">${k}</span>`; d.onclick = () => { activeTokenAdmin=k; renderSoalList(); }; l.appendChild(d); }); }
        function openAddSubject() { document.getElementById('modal-subject').classList.remove('hidden-view'); }
        function saveNewSubject() { const t = document.getElementById('new-token').value.toUpperCase(); const n = document.getElementById('new-mapel').value; if(t&&n) { db[t] = {name:n, questions:[]}; localStorage.setItem('cbt_db_v4', JSON.stringify(db)); document.getElementById('modal-subject').classList.add('hidden-view'); renderMapelList(); } }
        function renderSoalList() { const l = document.getElementById('soal-list'); l.innerHTML = ''; if(activeTokenAdmin && db[activeTokenAdmin]) { db[activeTokenAdmin].questions.forEach((q, i) => { const d = document.createElement('div'); d.className = "p-3 border rounded mb-2 bg-white"; d.innerHTML = `<div class="text-sm font-bold truncate">${q.question.replace(/<[^>]*>?/gm, '')}</div><div class="text-right text-xs mt-2"><button onclick="editQ(${i})" class="text-blue-500 mr-2">Edit</button><button onclick="delQ(${i})" class="text-red-500">Hapus</button></div>`; l.appendChild(d); }); } }
        
        function openAddQuestion() { 
            editingQIdx=null; 
            document.getElementById('modal-question').classList.remove('hidden-view'); 
            // Reset TinyMCE
            if(tinymce.get('ed-q')) tinymce.get('ed-q').setContent('');
            renderAnswerInput(); 
        }
        
        function editQ(i) { 
            editingQIdx=i; 
            document.getElementById('modal-question').classList.remove('hidden-view'); 
            const questionData = db[activeTokenAdmin].questions[i];
            // Set TinyMCE Content
            if(tinymce.get('ed-q')) tinymce.get('ed-q').setContent(questionData.question);
            renderAnswerInput(questionData); 
        }
        
        function delQ(i) { db[activeTokenAdmin].questions.splice(i,1); localStorage.setItem('cbt_db_v4', JSON.stringify(db)); renderSoalList(); }
        function renderAnswerInput(data=null) { const c = document.getElementById('ed-opts-container'); c.innerHTML = ''; const opts = data ? data.options : ['', '', '', '']; opts.forEach((o, i) => { const d = document.createElement('div'); d.className = "flex gap-2 mb-1"; d.innerHTML = `<input type="radio" name="ans" ${data && data.answer==i?'checked':''}><input class="border p-2 w-full rounded opt-val text-sm" value="${o}">`; c.appendChild(d); }); }
        function addEditorOpt() { const d = document.createElement('div'); d.className = "flex gap-2 mb-1"; d.innerHTML = `<input type="radio" name="ans"><input class="border p-2 w-full rounded opt-val text-sm">`; document.getElementById('ed-opts-container').appendChild(d); }
        
        // UPDATED SAVE QUESTION (Use TinyMCE)
        function saveQuestion() { 
            const q = tinymce.get('ed-q').getContent(); // Get content from TinyMCE
            const opts = []; let ans = -1; 
            document.querySelectorAll('.opt-val').forEach((el, i) => { opts.push(el.value); if(document.querySelectorAll('input[name="ans"]')[i].checked) ans = i; }); 
            if(!q || ans === -1) return alert("Lengkapi soal (Pastikan soal dan kunci jawaban terisi)"); 
            
            const newQ = { id: Date.now(), type:'pg', question:q, options:opts, answer:ans, points:2.5 }; 
            if(editingQIdx!==null) db[activeTokenAdmin].questions[editingQIdx] = newQ; else db[activeTokenAdmin].questions.push(newQ); 
            localStorage.setItem('cbt_db_v4', JSON.stringify(db)); 
            document.getElementById('modal-question').classList.add('hidden-view'); 
            renderSoalList(); 
        }
        
        function downloadTemplateWord() { alert("Template downloaded"); }
    </script>
</body>
</html>
