<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Pro - Dashboard Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        
        .glass-card { 
            background: rgba(255, 255, 255, 1); 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden-view { display: none !important; }

        /* Dashboard Specific Styles */
        .dash-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #334155; }
        .stat-label { font-size: 0.875rem; color: #64748b; margin-top: 4px; }
        .live-dot { width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .live-text { font-size: 0.75rem; color: #64748b; display: flex; align-items: center; margin-top: 12px; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9g4AUZ14a0_vbAXwJob9a4lSh7bwYwUDB9ISCaiScU2PNwTOyzGNtQ8Nlt9kqayQ/exec"; 
        const ADMIN_PIN = "2025"; 
        const MAX_VIOLATIONS = 3;
    </script>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col h-full overflow-hidden relative z-10">
        
        <!-- HEADER (Tetap sama, disederhanakan untuk admin view) -->
        <div class="w-full bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center z-20 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-indigo-600 rounded flex items-center justify-center text-white">
                    <i data-feather="grid" class="w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-lg text-slate-800">CBT Dashboard</h1>
            </div>
            <div id="top-nav-btn">
                <button onclick="logoutAdmin()" class="text-slate-500 hover:text-red-600 text-sm font-bold flex items-center gap-2">
                    <i data-feather="log-out" class="w-4 h-4"></i> Keluar
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main class="flex-grow flex overflow-hidden">

            <!-- 1. VIEW: WELCOME (Login Peserta) -->
            <div id="view-welcome" class="flex-grow flex items-center justify-center p-4 overflow-y-auto custom-scrollbar bg-blue-600">
                <div class="glass-card w-full max-w-md p-8 fade-in bg-white">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-extrabold text-slate-800">Login Peserta</h2>
                        <p class="text-slate-400 text-sm mt-1">Masukkan identitas untuk memulai ujian</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Nama Lengkap</label>
                            <input type="text" id="input-nama" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700" placeholder="Nama Anda...">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Kelas</label>
                                <select id="input-kelas" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700 cursor-pointer"></select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Jurusan</label>
                                <select id="input-jurusan" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700 cursor-pointer"></select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Token Soal</label>
                            <input type="text" id="input-token" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-600 text-center tracking-widest uppercase placeholder:text-slate-300 placeholder:font-normal placeholder:tracking-normal" placeholder="TOKEN">
                        </div>
                    </div>

                    <button onclick="startQuiz()" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2">
                        Mulai Mengerjakan <i data-feather="arrow-right" class="w-4 h-4"></i>
                    </button>
                    
                    <div class="mt-6 text-center">
                         <button onclick="showAdminLogin()" class="text-xs font-bold text-slate-400 hover:text-slate-600">Login Admin</button>
                    </div>
                </div>
            </div>

            <!-- 2. VIEW: PLAYING (Sama seperti sebelumnya) -->
            <div id="view-playing" class="w-full h-full flex flex-col hidden-view fade-in bg-white">
                 <!-- ... (Konten Playing sama, disederhanakan untuk fokus ke Admin) ... -->
                 <div class="bg-white border-b p-4 flex justify-between items-center">
                    <div class="flex gap-3 items-center">
                        <div class="h-10 w-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold" id="avatar-initial">U</div>
                        <div><h3 class="font-bold text-sm" id="play-name">User</h3><p class="text-xs text-slate-500" id="play-info">Info</p></div>
                    </div>
                    <div class="font-mono text-xl font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded" id="timer-display">--:--</div>
                 </div>
                 <div class="flex-grow overflow-y-auto p-8 custom-scrollbar">
                    <div class="max-w-3xl mx-auto">
                        <div class="mb-6 flex justify-between">
                            <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">SOAL NO <span id="q-num">1</span></span>
                        </div>
                        <div id="q-media" class="mb-4 hidden"></div>
                        <h2 id="q-text" class="text-xl font-medium text-slate-800 mb-8">Pertanyaan...</h2>
                        <div id="options-container" class="space-y-3"></div>
                    </div>
                 </div>
                 <div class="p-4 border-t flex justify-between max-w-3xl mx-auto w-full">
                    <button id="btn-prev" onclick="prevQ()" class="px-4 py-2 rounded border text-sm font-bold text-slate-600">Sebelumnya</button>
                    <button id="btn-next" onclick="nextQ()" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-bold">Selanjutnya</button>
                    <button id="btn-finish" onclick="finishQuiz()" class="hidden px-4 py-2 rounded bg-emerald-500 text-white text-sm font-bold">Selesai</button>
                 </div>
            </div>

            <!-- 3. VIEW: ADMIN DASHBOARD (NEW LAYOUT) -->
            <div id="view-admin" class="w-full h-full hidden-view fade-in flex overflow-hidden bg-slate-50">
                
                <!-- Sidebar -->
                <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
                    <nav class="flex-grow p-4 space-y-1">
                        <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2 mt-2">Menu Utama</p>
                        <button onclick="adminNav('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition nav-item active-nav bg-slate-100 text-indigo-600">
                            <i data-feather="grid" class="w-4 h-4"></i> Dashboard
                        </button>
                        <button onclick="adminNav('students')" id="nav-students" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition nav-item">
                            <i data-feather="users" class="w-4 h-4"></i> Data Peserta
                        </button>
                        <button onclick="adminNav('questions')" id="nav-questions" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition nav-item">
                            <i data-feather="file-text" class="w-4 h-4"></i> Bank Soal
                        </button>
                        
                        <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2 mt-6">Sistem</p>
                        <button onclick="adminNav('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-50 transition nav-item">
                            <i data-feather="settings" class="w-4 h-4"></i> Pengaturan
                        </button>
                    </nav>
                </aside>

                <!-- Content Area -->
                <div class="flex-grow overflow-y-auto custom-scrollbar p-8">
                    
                    <!-- PANEL: DASHBOARD (NEW LAYOUT) -->
                    <div id="admin-panel-dashboard" class="admin-panel space-y-6">
                        <div class="flex justify-between items-end mb-2">
                            <h2 class="text-2xl font-bold text-slate-800">Dashboard</h2>
                            <p class="text-xs text-slate-500">Overview Realtime</p>
                        </div>

                        <!-- TOP ROW: TRAFFIC & TOKEN -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Trafik Monitor -->
                            <div class="dash-card col-span-2">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-slate-700">Trafik Monitor</h3>
                                    <select class="text-xs border rounded px-2 py-1 bg-slate-50 text-slate-500 outline-none">
                                        <option>Reset</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-8">
                                    <div class="border-r pr-8 border-slate-100">
                                        <p class="text-xs font-bold text-slate-400 uppercase">SOCKET</p>
                                        <p class="text-3xl font-bold text-emerald-500 mt-1">860</p>
                                        <p class="text-xs text-slate-400 mt-1">Trafik Realtime</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase">HTTP</p>
                                        <div class="flex items-baseline gap-2 mt-1">
                                            <p class="text-3xl font-bold text-emerald-500">11,268</p>
                                            <span class="text-xs text-slate-400">Total</span>
                                        </div>
                                        <div class="flex gap-4 mt-2 text-xs font-medium text-slate-600">
                                            <span><strong class="text-slate-800">5</strong> Peserta</span>
                                            <span><strong class="text-slate-800">1,999</strong> Pengelola</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Token Card -->
                            <div class="dash-card flex flex-col justify-between relative overflow-hidden">
                                <div>
                                    <h3 class="text-3xl font-bold text-slate-800 tracking-wider" id="dash-token">D5YNRG</h3>
                                    <p class="text-xs text-slate-500 mt-1">Masa hidup token <span class="font-mono font-bold">1:12:10</span></p>
                                </div>
                                <div class="absolute top-4 right-4">
                                    <div class="w-8 h-8 rounded-full border-4 border-blue-100 border-t-blue-500 animate-spin"></div>
                                </div>
                                <button onclick="generateNewToken()" class="mt-4 w-full bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 rounded transition">
                                    Perbaharui Token!
                                </button>
                            </div>
                        </div>

                        <!-- MIDDLE ROW: STATS -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="dash-card">
                                <p class="stat-value">954</p>
                                <p class="stat-label">Total Koneksi Terekam</p>
                                <div class="live-text"><span class="live-dot"></span> 1 perangkat terhubung</div>
                            </div>
                            <div class="dash-card">
                                <p class="stat-value" id="stat-total-students">0</p>
                                <p class="stat-label">Total Peserta</p>
                                <div class="live-text"><span class="live-dot"></span> 0 peserta terhubung</div>
                            </div>
                            <div class="dash-card">
                                <p class="stat-value">1</p>
                                <p class="stat-label">Total Pengawas</p>
                                <div class="live-text"><span class="live-dot"></span> 0 pengawas terhubung</div>
                            </div>
                            <div class="dash-card">
                                <p class="stat-value">4</p>
                                <p class="stat-label">Total Pengelola</p>
                                <div class="live-text"><span class="live-dot"></span> 1 pengelola terhubung</div>
                            </div>
                        </div>

                        <!-- BOTTOM ROW: SUMMARY -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div class="dash-card">
                                <p class="stat-value" id="stat-total-classes">0</p>
                                <p class="stat-label">Total Kelas</p>
                            </div>
                            <div class="dash-card">
                                <p class="stat-value" id="stat-total-majors">0</p>
                                <p class="stat-label">Total Jurusan</p>
                            </div>
                            <div class="dash-card">
                                <p class="stat-value" id="stat-total-exams">0</p>
                                <p class="stat-label">Total Ujian <span class="text-emerald-500 text-xs font-bold ml-1">[Aktif]</span></p>
                            </div>
                        </div>
                        
                        <!-- DATA TABLE SECTION (EXISTING) -->
                        <div class="mt-8">
                            <h3 class="font-bold text-lg text-slate-700 mb-4">Data Nilai Masuk</h3>
                            <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b">
                                        <tr>
                                            <th class="px-6 py-3">Waktu</th>
                                            <th class="px-6 py-3">Nama</th>
                                            <th class="px-6 py-3">Kelas/Jurusan</th>
                                            <th class="px-6 py-3">Mapel</th>
                                            <th class="px-6 py-3">Nilai</th>
                                            <th class="px-6 py-3">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-results-body" class="text-sm text-slate-600 divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- PANEL: DATA PESERTA -->
                    <div id="admin-panel-students" class="admin-panel hidden-view space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-xl">Daftar Peserta</h3>
                            <button onclick="openStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Tambah Peserta</button>
                        </div>
                        <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b">
                                    <tr><th class="px-6 py-3">Foto</th><th class="px-6 py-3">Nama</th><th class="px-6 py-3">Kelas</th><th class="px-6 py-3">Jurusan</th><th class="px-6 py-3 text-right">Aksi</th></tr>
                                </thead>
                                <tbody id="table-students-body" class="text-sm text-slate-600 divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- PANEL: SOAL & SETTINGS (Simplified placeholder for brevity as focus was dashboard) -->
                    <div id="admin-panel-questions" class="admin-panel hidden-view">
                         <h3 class="font-bold text-xl mb-4">Bank Soal</h3>
                         <div class="flex gap-4 h-[500px]">
                             <div class="w-64 bg-white border rounded-lg p-4" id="mapel-list"></div>
                             <div class="flex-grow bg-white border rounded-lg p-4 overflow-y-auto" id="soal-list">
                                 <div class="text-center text-slate-400 mt-20">Pilih Mapel untuk edit soal</div>
                             </div>
                         </div>
                         <div class="mt-4 flex gap-2">
                             <button onclick="openAddSubject()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm">+ Mapel</button>
                             <button onclick="downloadTemplateWord()" class="border px-4 py-2 rounded text-sm">Template Word</button>
                         </div>
                    </div>

                    <div id="admin-panel-settings" class="admin-panel hidden-view">
                        <h3 class="font-bold text-xl mb-4">Pengaturan</h3>
                        <div class="bg-white p-6 rounded-lg border max-w-lg">
                             <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Logo URL</label>
                             <div class="flex gap-2"><input id="setting-logo" class="flex-grow border p-2 rounded"><button onclick="saveSettings()" class="bg-blue-600 text-white px-4 rounded">Simpan</button></div>
                             <div class="mt-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Daftar Kelas</label><textarea id="setting-kelas" class="w-full border p-2 rounded"></textarea></div>
                             <div class="mt-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Daftar Jurusan</label><textarea id="setting-jurusan" class="w-full border p-2 rounded"></textarea><button onclick="saveLists()" class="mt-2 bg-slate-800 text-white w-full py-2 rounded">Update</button></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 4. RESULT VIEW (Hidden) -->
            <div id="view-result-card" class="hidden-view glass-card w-full max-w-md p-8 text-center m-auto">
                <h2 class="text-2xl font-bold mb-2" id="res-title">Selesai</h2>
                <p class="text-4xl font-black text-blue-600 my-4" id="res-score">0</p>
                <button onclick="location.reload()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Keluar</button>
            </div>

        </main>
    </div>

    <!-- MODALS -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center">
            <h3 class="font-bold text-lg mb-6">Admin Login</h3>
            <input type="password" id="pin-input" class="w-full text-center text-3xl font-bold tracking-widest border-b-2 py-2 outline-none mb-8" maxlength="4">
            <div class="flex gap-2"><button onclick="document.getElementById('modal-login').classList.add('hidden-view')" class="flex-1 py-2 bg-slate-100 rounded">Batal</button><button onclick="checkAdminPin()" class="flex-1 py-2 bg-blue-600 text-white rounded">Masuk</button></div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="modal-student" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view">
        <div class="bg-white p-6 rounded-xl w-96">
            <h3 class="font-bold mb-4" id="student-modal-title">Peserta</h3>
            <div class="space-y-3">
                <input id="std-name" class="w-full border p-2 rounded" placeholder="Nama">
                <select id="std-class" class="w-full border p-2 rounded"></select>
                <select id="std-major" class="w-full border p-2 rounded"></select>
                <input id="std-score" type="number" class="w-full border p-2 rounded" placeholder="Nilai (Opsional)">
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeStudentModal()" class="px-4 py-2 text-slate-500">Batal</button>
                <button onclick="saveStudent()" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Subject & Question Modals (Existing logic placeholders) -->
    <div id="modal-subject" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view"><div class="bg-white p-6 rounded w-80"><input id="new-token" class="w-full border p-2 mb-2" placeholder="TOKEN"><input id="new-mapel" class="w-full border p-2 mb-4" placeholder="Mapel"><button onclick="saveNewSubject()" class="w-full bg-blue-600 text-white py-2 rounded">Simpan</button><button onclick="document.getElementById('modal-subject').classList.add('hidden-view')" class="w-full mt-2 text-slate-500">Batal</button></div></div>
    <div id="modal-question" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view"><div class="bg-white p-6 rounded w-[600px] h-[80vh] flex flex-col"><textarea id="ed-q" class="w-full border p-2 h-24 mb-2" placeholder="Pertanyaan"></textarea><div id="ed-opts-container" class="flex-grow overflow-y-auto"></div><button onclick="addEditorOpt()" class="text-blue-600 text-sm mb-4">+ Opsi</button><input id="ed-type" type="hidden"><input id="ed-media" type="hidden"><button onclick="saveQuestion()" class="w-full bg-blue-600 text-white py-2 rounded">Simpan</button><button onclick="document.getElementById('modal-question').classList.add('hidden-view')" class="w-full mt-2 text-slate-500">Batal</button></div></div>

    <script>
        feather.replace();
        let db = JSON.parse(localStorage.getItem('cbt_db_v4') || '{}');
        let config = { logo: "", classes: ["X", "XI", "XII"], majors: ["FARMASI 1", "FARMASI 2", "KEPERAWATAN 1", "KEPERAWATAN 2", "TJKT 1", "TJKT 2", "TBSM 1", "TBSM 2", "TKR"] };
        let adminDataCache = [], editingStudentIdx = null, activeTokenAdmin = null, editingQIdx = null;
        
        // --- INITIALIZATION ---
        function init() {
            updateDropdowns();
            if(localStorage.getItem('cbt_token_dash')) document.getElementById('dash-token').textContent = localStorage.getItem('cbt_token_dash');
        }
        init();

        function updateDropdowns() {
            const optsC = '<option value="">Pilih</option>' + config.classes.map(c => `<option>${c}</option>`).join('');
            const optsM = '<option value="">Pilih</option>' + config.majors.map(m => `<option>${m}</option>`).join('');
            ['input-kelas', 'std-class'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = optsC; });
            ['input-jurusan', 'std-major'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = optsM; });
            document.getElementById('setting-kelas').value = config.classes.join(', ');
            document.getElementById('setting-jurusan').value = config.majors.join(', ');
        }

        // --- NAVIGATION ---
        const nav = (id) => {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden-view'));
            document.getElementById(`view-${id}`).classList.remove('hidden-view');
            document.getElementById('top-nav-btn').style.display = id === 'welcome' ? 'block' : 'none';
        };

        // --- ADMIN LOGIC ---
        function showAdminLogin() { document.getElementById('modal-login').classList.remove('hidden-view'); }
        function checkAdminPin() {
            if(document.getElementById('pin-input').value === ADMIN_PIN) {
                document.getElementById('modal-login').classList.add('hidden-view');
                nav('admin'); adminNav('dashboard'); fetchAdminData(); updateDashboardStats();
            } else alert("PIN Salah");
        }
        function logoutAdmin() { nav('welcome'); document.getElementById('pin-input').value = ''; }

        function adminNav(tab) {
            document.querySelectorAll('.admin-panel').forEach(e => e.classList.add('hidden-view'));
            document.getElementById(`admin-panel-${tab}`).classList.remove('hidden-view');
            document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('bg-slate-100', 'text-indigo-600'); });
            document.getElementById(`nav-${tab}`).classList.add('bg-slate-100', 'text-indigo-600');
            if(tab === 'questions') renderMapelList();
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboardStats() {
            // Calculate stats from DB and Cache
            document.getElementById('stat-total-classes').textContent = config.classes.length;
            document.getElementById('stat-total-majors').textContent = config.majors.length;
            document.getElementById('stat-total-exams').textContent = Object.keys(db).length;
            document.getElementById('stat-total-students').textContent = adminDataCache.length;
        }

        function generateNewToken() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = "";
            for(let i=0; i<6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('dash-token').textContent = result;
            localStorage.setItem('cbt_token_dash', result);
        }

        // --- DATA HANDLING ---
        async function fetchAdminData() {
            if(GOOGLE_SCRIPT_URL) {
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await res.json();
                    if(data.students) adminDataCache = data.students;
                    if(data.config) { config.classes = data.config.classList; config.majors = data.config.majorList; updateDropdowns(); }
                } catch(e) {}
            }
            renderAdminTables();
            updateDashboardStats();
        }

        function renderAdminTables() {
            const dashRows = adminDataCache.slice(0, 10).map(s => `<tr><td class="px-6 py-3">${new Date(s.timestamp).toLocaleTimeString()}</td><td class="px-6 py-3 font-bold">${s.nama}</td><td class="px-6 py-3 text-xs">${s.kelas} ${s.jurusan}</td><td class="px-6 py-3">${s.mapel}</td><td class="px-6 py-3 font-bold text-blue-600">${s.nilaiAkhir}</td><td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${s.nilaiAkhir>=75?'bg-emerald-100 text-emerald-600':'bg-red-100 text-red-600'}">${s.nilaiAkhir>=75?'Lulus':'Remidi'}</span></td></tr>`).join('');
            document.getElementById('table-results-body').innerHTML = dashRows;

            const studRows = adminDataCache.map((s, i) => `<tr><td class="px-6 py-3"><div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs">${s.nama[0]}</div></td><td class="px-6 py-3 font-medium">${s.nama}</td><td class="px-6 py-3 text-slate-500">${s.kelas}</td><td class="px-6 py-3 text-slate-500">${s.jurusan}</td><td class="px-6 py-3 text-right"><button onclick="editStudent(${i})" class="text-blue-500 mr-2 hover:underline">Edit</button><button onclick="deleteStudent(${i})" class="text-red-500 hover:underline">Hapus</button></td></tr>`).join('');
            document.getElementById('table-students-body').innerHTML = studRows;
        }

        // --- CRUD STUDENT ---
        function openStudentModal(idx=null) {
            editingStudentIdx = idx;
            document.getElementById('modal-student').classList.remove('hidden-view');
            if(idx !== null) {
                const s = adminDataCache[idx];
                document.getElementById('std-name').value = s.nama;
                document.getElementById('std-class').value = s.kelas;
                document.getElementById('std-major').value = s.jurusan;
                document.getElementById('std-score').value = s.nilaiAkhir;
            } else {
                document.getElementById('std-name').value = '';
                document.getElementById('std-score').value = '';
            }
        }
        function closeStudentModal() { document.getElementById('modal-student').classList.add('hidden-view'); }
        function saveStudent() {
            const name = document.getElementById('std-name').value;
            const cls = document.getElementById('std-class').value;
            const mjr = document.getElementById('std-major').value;
            const score = document.getElementById('std-score').value || 0;
            if(!name) return alert("Nama wajib");
            
            const newItem = { timestamp: new Date().toISOString(), nama: name, kelas: cls, jurusan: mjr, mapel: "-", skor: 0, nilaiAkhir: score, durasi: "-", pelanggaran: 0, essay: "" };
            
            if(editingStudentIdx !== null) adminDataCache[editingStudentIdx] = { ...adminDataCache[editingStudentIdx], nama: name, kelas: cls, jurusan: mjr, nilaiAkhir: score };
            else adminDataCache.unshift(newItem);
            
            closeStudentModal(); renderAdminTables(); updateDashboardStats();
        }
        function deleteStudent(idx) { if(confirm("Hapus?")) { adminDataCache.splice(idx, 1); renderAdminTables(); updateDashboardStats(); }}

        // --- EXAM LOGIC (Minimal for placeholder) ---
        function startQuiz() { nav('playing'); }
        function finishQuiz() { nav('result-card'); }

        // --- SETTINGS ---
        function saveLists() {
            config.classes = document.getElementById('setting-kelas').value.split(',').map(s=>s.trim());
            config.majors = document.getElementById('setting-jurusan').value.split(',').map(s=>s.trim());
            updateDropdowns();
            alert("Daftar diperbarui!");
            if(GOOGLE_SCRIPT_URL) fetch(GOOGLE_SCRIPT_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'save_config', classList:config.classes, majorList:config.majors})});
        }

        // --- QUESTION MANAGEMENT (Simplified) ---
        function renderMapelList() {
            const l = document.getElementById('mapel-list'); l.innerHTML = '';
            Object.keys(db).forEach(k => {
                const d = document.createElement('div'); d.className = "p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2";
                d.innerHTML = `<b>${db[k].name}</b> <span class="text-xs text-slate-400">${k}</span>`;
                d.onclick = () => { activeTokenAdmin=k; renderSoalList(); };
                l.appendChild(d);
            });
        }
        function openAddSubject() { document.getElementById('modal-subject').classList.remove('hidden-view'); }
        function saveNewSubject() {
            const t = document.getElementById('new-token').value.toUpperCase();
            const n = document.getElementById('new-mapel').value;
            if(t&&n) { db[t] = {name:n, questions:[]}; localStorage.setItem('cbt_db_v4', JSON.stringify(db)); document.getElementById('modal-subject').classList.add('hidden-view'); renderMapelList(); }
        }
        function renderSoalList() {
            const l = document.getElementById('soal-list'); l.innerHTML = '';
            if(activeTokenAdmin && db[activeTokenAdmin]) {
                db[activeTokenAdmin].questions.forEach((q, i) => {
                    const d = document.createElement('div'); d.className = "p-3 border rounded mb-2 bg-white";
                    d.innerHTML = `<p class="text-sm font-bold">${q.question}</p><div class="text-right text-xs mt-2"><button onclick="editQ(${i})" class="text-blue-500 mr-2">Edit</button><button onclick="delQ(${i})" class="text-red-500">Hapus</button></div>`;
                    l.appendChild(d);
                });
            }
        }
        function openAddQuestion() { editingQIdx=null; document.getElementById('modal-question').classList.remove('hidden-view'); renderAnswerInput(); }
        function editQ(i) { editingQIdx=i; document.getElementById('modal-question').classList.remove('hidden-view'); document.getElementById('ed-q').value=db[activeTokenAdmin].questions[i].question; renderAnswerInput(db[activeTokenAdmin].questions[i]); }
        function delQ(i) { db[activeTokenAdmin].questions.splice(i,1); localStorage.setItem('cbt_db_v4', JSON.stringify(db)); renderSoalList(); }
        function renderAnswerInput(data=null) { 
            const c = document.getElementById('ed-opts-container'); c.innerHTML = ''; 
            const opts = data ? data.options : ['', '', '', ''];
            opts.forEach((o, i) => {
                const d = document.createElement('div'); d.className = "flex gap-2 mb-1";
                d.innerHTML = `<input type="radio" name="ans" ${data && data.answer==i?'checked':''}><input class="border p-1 w-full opt-val" value="${o}">`;
                c.appendChild(d);
            });
        }
        function addEditorOpt() { 
            const d = document.createElement('div'); d.className = "flex gap-2 mb-1";
            d.innerHTML = `<input type="radio" name="ans"><input class="border p-1 w-full opt-val">`;
            document.getElementById('ed-opts-container').appendChild(d);
        }
        function saveQuestion() {
            const q = document.getElementById('ed-q').value;
            const opts = []; let ans = -1;
            document.querySelectorAll('.opt-val').forEach((el, i) => { opts.push(el.value); if(document.querySelectorAll('input[name="ans"]')[i].checked) ans = i; });
            if(!q || ans === -1) return alert("Lengkapi soal");
            const newQ = { id: Date.now(), type:'pg', question:q, options:opts, answer:ans, points:2.5 };
            if(editingQIdx!==null) db[activeTokenAdmin].questions[editingQIdx] = newQ;
            else db[activeTokenAdmin].questions.push(newQ);
            localStorage.setItem('cbt_db_v4', JSON.stringify(db));
            document.getElementById('modal-question').classList.add('hidden-view'); renderSoalList();
        }
        function downloadTemplateWord() {
             const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Template Soal</title></head><body>";
            const footer = "</body></html>";
            const content = `<h2>Template Soal Ujian</h2><p>Silakan isi tabel di bawah ini.</p><table border="1" style="width: 100%;"><thead><tr style="background-color: #f0f0f0;"><th>Pertanyaan</th><th>Tipe</th><th>Opsi A</th><th>Opsi B</th><th>Opsi C</th><th>Opsi D</th><th>Opsi E</th><th>Kunci</th></tr></thead><tbody><tr><td>Contoh Soal</td><td>pg</td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>0</td></tr></tbody></table>`;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + footer);
            const link = document.createElement("a"); link.href = source; link.download = 'Template_Soal.doc'; link.click();
        }
    </script>
</body>
</html>
