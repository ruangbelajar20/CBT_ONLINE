<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Modern - Secure Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        
        /* Modern Table */
        .modern-table th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; padding: 1rem; }
        .modern-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .modern-table tr:last-child td { border-bottom: none; }
        .modern-table tr:hover { background: #f8fafc; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <script>
        // GANTI URL INI DENGAN HASIL DEPLOY TERBARU ANDA
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9g4AUZ14a0_vbAXwJob9a4lSh7bwYwUDB9ISCaiScU2PNwTOyzGNtQ8Nlt9kqayQ/exec"; 
        const ADMIN_PIN = "2025"; 
        const MAX_VIOLATIONS = 3;
    </script>

    <!-- BACKGROUND -->
    <div class="fixed inset-0 -z-10 bg-slate-50">
        <div class="absolute top-0 left-0 w-full h-96 gradient-bg clip-path-slant"></div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col h-full overflow-hidden">
        
        <!-- HEADER LOGO (Dynamic) -->
        <div class="w-full max-w-7xl mx-auto px-6 py-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <img id="school-logo-img" src="" alt="Logo" class="h-12 w-auto object-contain hidden bg-white rounded-lg p-1 shadow-sm">
                <div id="default-logo" class="h-10 w-10 bg-white/20 backdrop-blur rounded-lg flex items-center justify-center text-white">
                    <i data-feather="box"></i>
                </div>
                <div class="text-white">
                    <h1 class="font-bold text-lg leading-tight" id="school-name-display">CBT ONLINE</h1>
                    <p class="text-xs text-indigo-100 opacity-80">Secure Examination System</p>
                </div>
            </div>
            <div id="top-nav-btn">
                <button onclick="showAdminLogin()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-semibold backdrop-blur-sm transition flex items-center gap-2">
                    <i data-feather="settings" class="w-4 h-4"></i> Admin
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-grow flex items-center justify-center p-4 overflow-y-auto custom-scrollbar">

            <!-- 1. WELCOME VIEW -->
            <div id="view-welcome" class="glass-panel bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 fade-in relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-t-2xl"></div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Login Peserta</h2>
                
                <div class="space-y-4">
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
                        <div class="relative">
                            <i data-feather="user" class="absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <input type="text" id="input-nama" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition bg-slate-50 focus:bg-white" placeholder="Ketik nama Anda...">
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label>
                        <div class="relative">
                            <i data-feather="users" class="absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <select id="input-kelas" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition bg-slate-50 appearance-none">
                                <option value="">Pilih Kelas</option>
                                <option value="X TKJ 1">X TKJ 1</option><option value="X TKJ 2">X TKJ 2</option>
                                <option value="XI TKJ 1">XI TKJ 1</option><option value="XI TKJ 2">XI TKJ 2</option>
                                <option value="XII TKJ 1">XII TKJ 1</option><option value="XII TKJ 2">XII TKJ 2</option>
                                <option value="X RPL 1">X RPL 1</option><option value="X RPL 2">X RPL 2</option>
                                <option value="XI RPL 1">XI RPL 1</option><option value="XI RPL 2">XI RPL 2</option>
                            </select>
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Token Soal</label>
                        <div class="relative">
                            <i data-feather="key" class="absolute left-3 top-3 w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <input type="text" id="input-token" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition bg-slate-50 font-mono uppercase tracking-widest text-center font-bold text-indigo-600" placeholder="TOKEN">
                        </div>
                    </div>
                </div>

                <div id="input-error" class="mt-4 hidden bg-red-50 text-red-600 text-xs font-bold p-3 rounded-lg flex items-center">
                    <i data-feather="alert-circle" class="w-4 h-4 mr-2"></i> <span id="error-text">Error message</span>
                </div>

                <button onclick="startQuiz()" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-indigo-500/30 transition transform active:scale-95 flex justify-center items-center gap-2">
                    Mulai Mengerjakan <i data-feather="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- 2. PLAYING VIEW -->
            <div id="view-playing" class="w-full max-w-5xl h-full flex flex-col hidden-view fade-in">
                <!-- Top Info Bar -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4 flex justify-between items-center border border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold" id="avatar-initial">U</div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm" id="play-name">User</h3>
                            <p class="text-xs text-slate-500" id="play-mapel">Mapel</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden md:block">
                            <p class="text-xs text-slate-400 font-bold uppercase">Sisa Waktu</p>
                            <p class="font-mono text-lg font-bold text-indigo-600" id="timer-display">--:--</p>
                        </div>
                        <div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2" id="status-badge">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Aman
                        </div>
                    </div>
                </div>

                <!-- Main Question Area -->
                <div class="flex-grow flex gap-4 overflow-hidden">
                    <!-- Question Card -->
                    <div class="flex-grow bg-white rounded-2xl shadow-lg border border-slate-100 flex flex-col overflow-hidden">
                        <div class="h-1 w-full bg-slate-100">
                            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        
                        <div class="p-6 md:p-8 flex-grow overflow-y-auto custom-scrollbar">
                            <span class="inline-block bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded mb-4">Soal No. <span id="q-num">1</span></span>
                            <h2 id="q-text" class="text-lg md:text-xl font-medium text-slate-800 mb-8 leading-relaxed">Pertanyaan...</h2>
                            
                            <div id="options-container" class="space-y-3">
                                <!-- Options Injected Here -->
                            </div>
                        </div>

                        <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                            <button id="btn-prev" onclick="prevQ()" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-100 transition">Sebelumnya</button>
                            
                            <button id="btn-next" onclick="nextQ()" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700 shadow-md transition">Selanjutnya</button>
                            
                            <button id="btn-finish" onclick="finishQuiz()" class="hidden px-6 py-2 rounded-lg bg-emerald-500 text-white font-bold text-sm hover:bg-emerald-600 shadow-md transition">Selesai</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ADMIN DASHBOARD VIEW (Updated Layout) -->
            <div id="view-admin" class="w-full max-w-7xl h-full hidden-view fade-in flex gap-6 overflow-hidden">
                
                <!-- Sidebar -->
                <aside class="w-64 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden shrink-0">
                    <div class="p-6 border-b border-slate-100">
                        <h2 class="font-bold text-slate-800 flex items-center gap-2">
                            <i data-feather="command" class="text-indigo-600"></i> Admin Panel
                        </h2>
                    </div>
                    <nav class="flex-grow p-4 space-y-1 overflow-y-auto custom-scrollbar">
                        <button onclick="adminNav('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-slate-600 hover:bg-slate-50 transition nav-item active-nav">
                            <i data-feather="grid" class="w-4 h-4"></i> Dashboard Hasil
                        </button>
                        <button onclick="adminNav('questions')" id="nav-questions" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-slate-600 hover:bg-slate-50 transition nav-item">
                            <i data-feather="file-text" class="w-4 h-4"></i> Kelola Soal
                        </button>
                        <button onclick="adminNav('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-slate-600 hover:bg-slate-50 transition nav-item">
                            <i data-feather="settings" class="w-4 h-4"></i> Pengaturan Sekolah
                        </button>
                    </nav>
                    <div class="p-4 border-t border-slate-100">
                        <button onclick="logoutAdmin()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-bold text-red-600 bg-red-50 rounded-xl hover:bg-red-100 transition">
                            <i data-feather="log-out" class="w-4 h-4"></i> Logout
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <div class="flex-grow bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">
                    
                    <!-- Content: Dashboard Hasil -->
                    <div id="admin-panel-dashboard" class="admin-panel h-full flex flex-col">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-slate-800">Data Hasil Ujian</h3>
                            <div class="flex gap-2">
                                <button onclick="fetchAdminData()" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition flex items-center gap-1"><i data-feather="refresh-cw" class="w-3 h-3"></i> Refresh</button>
                                <button onclick="downloadExcel()" class="px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg text-xs font-bold hover:bg-emerald-100 transition flex items-center gap-1"><i data-feather="download" class="w-3 h-3"></i> Excel</button>
                            </div>
                        </div>
                        <div class="flex-grow overflow-auto custom-scrollbar p-0">
                            <table class="w-full text-left modern-table">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr><th>Waktu</th><th>Nama</th><th>Kelas</th><th>Mapel</th><th>Skor</th><th>Nilai</th><th>Status</th></tr>
                                </thead>
                                <tbody id="table-results-body" class="bg-white text-sm"></tbody>
                            </table>
                            <div id="loading-state" class="hidden p-8 text-center text-slate-400">Loading data...</div>
                        </div>
                    </div>

                    <!-- Content: Kelola Soal -->
                    <div id="admin-panel-questions" class="admin-panel h-full flex flex-col hidden-view">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-slate-800">Manajemen Bank Soal</h3>
                                <p class="text-xs text-slate-500">Buat Token Mata Pelajaran dan Soal</p>
                            </div>
                            <button onclick="openAddSubject()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition">+ Mapel Baru</button>
                        </div>
                        <div class="flex-grow flex overflow-hidden">
                            <!-- List Mapel -->
                            <div class="w-1/3 border-r border-slate-100 overflow-y-auto custom-scrollbar p-4 space-y-2" id="mapel-list">
                                <!-- JS Injected -->
                            </div>
                            <!-- List Soal -->
                            <div class="w-2/3 flex flex-col bg-slate-50">
                                <div id="empty-soal-state" class="flex-grow flex flex-col items-center justify-center text-slate-400">
                                    <i data-feather="arrow-left" class="w-8 h-8 mb-2"></i>
                                    <p class="text-sm">Pilih Mapel di kiri untuk edit soal</p>
                                </div>
                                <div id="soal-editor-wrapper" class="hidden flex-col h-full">
                                    <div class="p-4 flex justify-between items-center bg-white border-b border-slate-200">
                                        <h4 class="font-bold text-indigo-700" id="active-mapel-name">Mapel</h4>
                                        <div class="flex gap-2">
                                            <button onclick="deleteCurrentSubject()" class="text-red-500 text-xs hover:underline">Hapus Mapel</button>
                                            <button onclick="openAddQuestion()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700">+ Soal</button>
                                        </div>
                                    </div>
                                    <div id="soal-list" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Settings (Logo) -->
                    <div id="admin-panel-settings" class="admin-panel h-full p-8 hidden-view">
                        <h3 class="font-bold text-xl text-slate-800 mb-6">Pengaturan Sekolah</h3>
                        <div class="max-w-lg">
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-slate-600 mb-2">URL Logo Sekolah</label>
                                <p class="text-xs text-slate-400 mb-2">Masukkan Direct Link gambar (png/jpg) agar logo muncul di semua perangkat siswa.</p>
                                <div class="flex gap-2">
                                    <input type="text" id="setting-logo-url" class="flex-grow border border-slate-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="https://sekolah.sch.id/logo.png">
                                    <button onclick="saveLogoSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition">Simpan</button>
                                </div>
                            </div>
                            <div class="border p-4 rounded-xl bg-slate-50 flex items-center gap-4">
                                <div class="text-xs font-bold text-slate-500">Preview:</div>
                                <img id="setting-logo-preview" src="" alt="Preview" class="h-16 w-auto object-contain bg-white p-1 rounded shadow-sm border">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 4. FINISHED / DISQUALIFIED VIEW (Shared logic container for simplicity in this comprehensive file) -->
            <div id="view-result-card" class="glass-panel bg-white w-full max-w-lg rounded-2xl shadow-2xl p-8 hidden-view fade-in text-center">
                <div id="res-icon-container" class="mb-4 flex justify-center"></div>
                <h2 id="res-title" class="text-2xl font-bold text-slate-800 mb-2">Status</h2>
                <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100">
                    <p id="final-name" class="font-bold text-lg text-slate-700"></p>
                    <p id="final-info" class="text-sm text-slate-500"></p>
                </div>
                <div class="text-4xl font-extrabold text-indigo-600 mb-2" id="final-score">0</div>
                <p class="text-sm font-bold text-slate-400 uppercase tracking-wide mb-6">Nilai Akhir</p>
                
                <p id="final-message" class="text-sm text-slate-600 mb-6"></p>
                
                <button onclick="location.reload()" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-900 transition">Kembali ke Login</button>
            </div>

        </main>
    </div>

    <!-- MODALS (Hidden) -->
    <!-- Admin Login -->
    <div id="modal-login" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden-view">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">Akses Admin</h3>
            <input type="password" id="pin-input" class="w-full text-center text-2xl font-bold tracking-[0.5em] border-2 border-slate-200 rounded-xl py-3 focus:border-indigo-500 outline-none mb-4 transition" placeholder="••••" maxlength="4">
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-login').classList.add('hidden-view')" class="flex-1 py-3 font-bold text-slate-500 hover:bg-slate-100 rounded-xl transition">Batal</button>
                <button onclick="checkAdminPin()" class="flex-1 py-3 font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg transition">Masuk</button>
            </div>
        </div>
    </div>

    <!-- Add Subject -->
    <div id="modal-subject" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <h3 class="font-bold mb-4">Mapel Baru</h3>
            <input id="new-token" class="w-full border p-2 rounded mb-2 uppercase font-mono" placeholder="KODE TOKEN (Cth: MTK01)">
            <input id="new-mapel" class="w-full border p-2 rounded mb-4" placeholder="Nama Mata Pelajaran">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modal-subject').classList.add('hidden-view')" class="px-4 py-2 text-sm font-bold text-slate-500">Batal</button>
                <button onclick="saveNewSubject()" class="px-4 py-2 text-sm font-bold bg-indigo-600 text-white rounded">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Add Question -->
    <div id="modal-question" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden-view">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl h-[80vh] flex flex-col">
            <h3 class="font-bold mb-4">Editor Soal</h3>
            <div class="flex-grow overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                <div><label class="text-xs font-bold text-slate-500">Pertanyaan</label><textarea id="editor-q" class="w-full border p-2 rounded" rows="3"></textarea></div>
                <div><label class="text-xs font-bold text-slate-500">Poin</label><input type="number" id="editor-pts" class="border p-2 rounded w-20" value="2.5"></div>
                <div>
                    <label class="text-xs font-bold text-slate-500">Opsi Jawaban (Pilih Radio untuk Kunci)</label>
                    <div id="editor-opts" class="space-y-2 mt-1"></div>
                    <button onclick="addOptInput()" class="text-xs text-indigo-600 font-bold mt-2">+ Tambah Opsi</button>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t flex justify-end gap-2">
                <button onclick="document.getElementById('modal-question').classList.add('hidden-view')" class="px-4 py-2 font-bold text-slate-500">Batal</button>
                <button onclick="saveEditorQuestion()" class="px-4 py-2 font-bold bg-indigo-600 text-white rounded">Simpan Soal</button>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        // --- STATE & DATA ---
        let db = JSON.parse(localStorage.getItem('cbt_db_v1') || '{}');
        let currentQuestions = [], userAnswers = {}, currentQ = 0;
        let userData = {}, timerInterval, startTime;
        let violations = 0;
        let activeTokenAdmin = null; // For admin editing
        let editingQIdx = null;

        // Load School Logo on Startup
        async function loadAppConfig() {
            // First check local, then try fetch
            if (GOOGLE_SCRIPT_URL) {
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await res.json();
                    if (data.settings && data.settings.logoUrl) {
                        applyLogo(data.settings.logoUrl);
                        localStorage.setItem('school_logo_url', data.settings.logoUrl);
                    }
                } catch(e) {
                    console.log("Offline or fetch failed, using cached logo");
                    const cached = localStorage.getItem('school_logo_url');
                    if(cached) applyLogo(cached);
                }
            }
        }
        
        function applyLogo(url) {
            if(!url) return;
            const img = document.getElementById('school-logo-img');
            const def = document.getElementById('default-logo');
            img.src = url;
            img.classList.remove('hidden');
            def.classList.add('hidden');
            document.getElementById('setting-logo-preview').src = url;
            document.getElementById('setting-logo-url').value = url;
        }

        loadAppConfig();

        // --- NAVIGATION ---
        const nav = (viewId) => {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden-view');
            
            // Special UI tweak for dashboard
            const topNav = document.getElementById('top-nav-btn');
            if(viewId === 'welcome') topNav.classList.remove('hidden');
            else topNav.classList.add('hidden');
        };

        // --- STUDENT FUNCTIONS ---
        function startQuiz() {
            const nama = document.getElementById('input-nama').value.trim();
            const kelas = document.getElementById('input-kelas').value;
            const token = document.getElementById('input-token').value.trim().toUpperCase();
            
            if(!nama || !kelas || !token) return showError("Lengkapi semua data!");
            
            if(!db[token]) return showError("Token soal tidak ditemukan!");
            if(!db[token].questions || db[token].questions.length === 0) return showError("Soal belum tersedia untuk mapel ini.");

            userData = { nama, kelas, token, mapel: db[token].name };
            currentQuestions = shuffle(JSON.parse(JSON.stringify(db[token].questions)));
            currentQ = 0; userAnswers = {}; violations = 0;
            startTime = new Date();

            // UI Setup
            document.getElementById('play-name').textContent = nama;
            document.getElementById('avatar-initial').textContent = nama.charAt(0).toUpperCase();
            document.getElementById('play-mapel').textContent = `${db[token].name} (${kelas})`;
            
            document.getElementById('input-error').classList.add('hidden');
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
            
            nav('playing');
            renderQ();
            startTimer();
            initAntiCheat();
        }

        function renderQ() {
            const q = currentQuestions[currentQ];
            document.getElementById('q-num').textContent = currentQ + 1;
            document.getElementById('q-text').textContent = q.question;
            const pct = ((currentQ + 1) / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;

            const cont = document.getElementById('options-container');
            cont.innerHTML = '';
            q.options.forEach((opt, i) => {
                const isSel = userAnswers[currentQ] === i;
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-4 rounded-xl border transition flex items-start gap-3 ${isSel ? 'border-indigo-600 bg-indigo-50 text-indigo-900' : 'border-slate-200 hover:bg-slate-50 text-slate-700'}`;
                btn.onclick = () => { userAnswers[currentQ] = i; renderQ(); };
                btn.innerHTML = `<span class="font-bold ${isSel?'text-indigo-600':'text-slate-400'}">${String.fromCharCode(65+i)}.</span> <span>${opt}</span>`;
                cont.appendChild(btn);
            });

            document.getElementById('btn-prev').disabled = currentQ === 0;
            if(currentQ === currentQuestions.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-finish').classList.remove('hidden');
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-finish').classList.add('hidden');
            }
        }

        function nextQ() { if(currentQ < currentQuestions.length - 1) { currentQ++; renderQ(); }}
        function prevQ() { if(currentQ > 0) { currentQ--; renderQ(); }}

        async function finishQuiz(forced = false) {
            clearInterval(timerInterval);
            if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});

            // Calc
            let score = 0, totalPts = 0;
            currentQuestions.forEach((q, i) => {
                totalPts += (q.points || 1);
                if(userAnswers[i] === q.answer) score += (q.points || 1);
            });
            const final = totalPts > 0 ? Math.round((score/totalPts)*100) : 0;
            
            // Duration
            const diff = new Date() - startTime;
            const mins = Math.floor(diff/60000);
            const secs = Math.floor((diff%60000)/1000);
            const durStr = `${mins}m ${secs}s`;

            // Display
            nav('result-card');
            const iconContainer = document.getElementById('res-icon-container');
            const title = document.getElementById('res-title');
            const msg = document.getElementById('final-message');
            
            document.getElementById('final-name').textContent = userData.nama;
            document.getElementById('final-info').textContent = `${userData.kelas} • ${userData.mapel}`;
            document.getElementById('final-score').textContent = final;

            if (forced) {
                // Diskualifikasi
                iconContainer.innerHTML = '<div class="h-20 w-20 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i data-feather="alert-octagon" class="w-10 h-10"></i></div>';
                feather.replace();
                title.textContent = "DISKUALIFIKASI";
                title.className = "text-2xl font-bold text-red-600 mb-2";
                msg.textContent = `Ujian dihentikan karena ${violations}x pelanggaran. Nilai tetap tercatat.`;
                sendData(score, final, durStr, violations, true);
            } else {
                // Normal Finish
                const passed = final >= 75;
                iconContainer.innerHTML = passed 
                    ? '<div class="h-20 w-20 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"><i data-feather="check" class="w-10 h-10"></i></div>'
                    : '<div class="h-20 w-20 bg-amber-100 rounded-full flex items-center justify-center text-amber-600"><i data-feather="x" class="w-10 h-10"></i></div>';
                feather.replace();
                title.textContent = passed ? "Kompeten" : "Belum Kompeten";
                title.className = `text-2xl font-bold ${passed?'text-emerald-600':'text-amber-600'} mb-2`;
                msg.textContent = passed ? "Selamat! Anda lulus ujian ini." : "Silakan belajar lagi dan coba kembali.";
                sendData(score, final, durStr, violations, false);
            }
        }

        async function sendData(score, final, dur, viols, isDq) {
            if(!GOOGLE_SCRIPT_URL) return;
            const payload = {
                nama: isDq ? `${userData.nama} (DQ)` : userData.nama,
                kelas: userData.kelas,
                mapel: userData.mapel,
                skor: score,
                nilaiAkhir: final,
                durasi: dur,
                pelanggaran: viols,
                action: "submit_exam" // For standard submission
            };
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } catch(e) { console.error(e); }
        }

        // --- ANTI CHEAT ---
        function initAntiCheat() {
            document.addEventListener('visibilitychange', () => handleViolate("Pindah Tab"));
            window.addEventListener('blur', () => handleViolate("Blur/Focus Loss"));
            window.addEventListener('resize', () => {
                if(window.innerWidth < screen.width * 0.9) handleViolate("Split Screen");
            });
        }

        function handleViolate(type) {
            // Simple logic: if alert open, ignore extra triggers
            if(document.querySelector('.swal-overlay')) return; 
            
            // Using browser alert for simplicity in this logic flow to block thread
            violations++;
            if(violations >= MAX_VIOLATIONS) {
                finishQuiz(true);
            } else {
                alert(`PERINGATAN ${violations}/${MAX_VIOLATIONS}\nTerdeteksi: ${type}\nJangan keluar dari layar ujian!`);
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const diff = new Date() - startTime;
                const m = Math.floor(diff/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;
            }, 1000);
        }

        // --- ADMIN FUNCTIONS ---
        function showAdminLogin() { document.getElementById('modal-login').classList.remove('hidden-view'); document.getElementById('pin-input').value = ''; document.getElementById('pin-input').focus(); }
        
        function checkAdminPin() {
            if(document.getElementById('pin-input').value === ADMIN_PIN) {
                document.getElementById('modal-login').classList.add('hidden-view');
                nav('admin');
                renderMapelList();
                adminNav('dashboard');
                fetchAdminData();
            } else {
                alert("PIN Salah");
            }
        }

        function adminNav(tab) {
            document.querySelectorAll('.admin-panel').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`admin-panel-${tab}`).classList.remove('hidden-view');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-indigo-50', 'text-indigo-600'));
            document.getElementById(`nav-${tab}`).classList.add('bg-indigo-50', 'text-indigo-600');
        }

        // --- ADMIN: DATA & EXCEL ---
        async function fetchAdminData() {
            document.getElementById('loading-state').classList.remove('hidden');
            const tbody = document.getElementById('table-results-body');
            tbody.innerHTML = '';
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL);
                const data = await res.json();
                const results = data.students || data; // Handle both structures
                
                if(results.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-400">Belum ada data</td></tr>`;
                } else {
                    results.reverse().forEach(r => {
                        const tr = document.createElement('tr');
                        const isPass = r.nilaiAkhir >= 75;
                        tr.innerHTML = `
                            <td>${new Date(r.timestamp).toLocaleString()}</td>
                            <td class="font-bold">${r.nama}</td>
                            <td><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">${r.kelas}</span></td>
                            <td>${r.mapel}</td>
                            <td class="font-mono text-xs">${r.skor}</td>
                            <td class="font-bold text-lg ${isPass ? 'text-emerald-600' : 'text-red-600'}">${r.nilaiAkhir}</td>
                            <td>${isPass ? '<span class="text-emerald-600 text-xs font-bold">Lulus</span>' : '<span class="text-red-600 text-xs font-bold">Remidi</span>'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { console.error(e); tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4">Gagal memuat data</td></tr>`; }
            
            document.getElementById('loading-state').classList.add('hidden');
        }

        function downloadExcel() {
            // Simplified CSV download logic reading from table would be better, but re-fetching ensures clean data
            alert("Fitur Download akan mengambil data dari tampilan tabel saat ini.");
            // Implementation skipped for brevity, rely on standard CSV export logic usually
        }

        // --- ADMIN: SETTINGS (LOGO) ---
        async function saveLogoSettings() {
            const url = document.getElementById('setting-logo-url').value.trim();
            if(!url) return alert("URL kosong");
            
            // Save locally immediately
            localStorage.setItem('school_logo_url', url);
            applyLogo(url);

            // Save to Server
            if(GOOGLE_SCRIPT_URL) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: "save_settings", logoUrl: url })
                    });
                    alert("Logo tersimpan! Akan muncul di semua perangkat siswa.");
                } catch(e) { alert("Gagal simpan ke server, tapi tersimpan di browser ini."); }
            }
        }

        // --- ADMIN: QUESTION MANAGEMENT ---
        function renderMapelList() {
            const list = document.getElementById('mapel-list');
            list.innerHTML = '';
            Object.keys(db).forEach(token => {
                const div = document.createElement('div');
                div.className = `p-3 rounded border cursor-pointer hover:bg-indigo-50 transition ${activeTokenAdmin === token ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100 bg-white'}`;
                div.onclick = () => selectMapel(token);
                div.innerHTML = `<h4 class="font-bold text-sm text-slate-700">${db[token].name}</h4><p class="text-xs text-indigo-500 font-mono font-bold mt-1">${token} • ${db[token].questions.length} Soal</p>`;
                list.appendChild(div);
            });
        }

        function selectMapel(token) {
            activeTokenAdmin = token;
            renderMapelList();
            document.getElementById('empty-soal-state').classList.add('hidden');
            document.getElementById('soal-editor-wrapper').classList.remove('hidden');
            document.getElementById('soal-editor-wrapper').classList.add('flex');
            document.getElementById('active-mapel-name').textContent = db[token].name;
            renderSoalList();
        }

        function renderSoalList() {
            const list = document.getElementById('soal-list');
            list.innerHTML = '';
            db[activeTokenAdmin].questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white border border-slate-200 p-4 rounded-lg relative group";
                let opts = '<ul class="mt-2 space-y-1">';
                q.options.forEach((o, i) => opts += `<li class="text-xs ${i===q.answer?'text-green-600 font-bold':'text-slate-500'} flex gap-2"><span>${String.fromCharCode(65+i)}.</span> ${o}</li>`);
                opts += '</ul>';
                div.innerHTML = `<div class="pr-12"><p class="text-sm font-medium text-slate-800">${q.question}</p>${opts}</div>
                <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                    <button onclick="editQ(${idx})" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="deleteQ(${idx})" class="p-1.5 text-red-500 hover:bg-red-50 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>`;
                list.appendChild(div);
            });
            feather.replace();
        }

        function openAddSubject() { document.getElementById('modal-subject').classList.remove('hidden-view'); }
        function saveNewSubject() {
            const token = document.getElementById('new-token').value.trim().toUpperCase();
            const name = document.getElementById('new-mapel').value.trim();
            if(!token || !name) return alert("Data kurang");
            if(db[token]) return alert("Token sudah ada");
            db[token] = { name, questions: [] };
            saveDB();
            document.getElementById('modal-subject').classList.add('hidden-view');
            renderMapelList();
        }

        function deleteCurrentSubject() {
            if(!confirm("Hapus mapel ini beserta semua soalnya?")) return;
            delete db[activeTokenAdmin];
            saveDB();
            activeTokenAdmin = null;
            renderMapelList();
            document.getElementById('soal-editor-wrapper').classList.add('hidden');
            document.getElementById('empty-soal-state').classList.remove('hidden');
        }

        function openAddQuestion() { editingQIdx = null; showQModal(); }
        function editQ(idx) { 
            editingQIdx = idx; 
            const q = db[activeTokenAdmin].questions[idx];
            document.getElementById('editor-q').value = q.question;
            document.getElementById('editor-pts').value = q.points;
            const optList = document.getElementById('editor-opts');
            optList.innerHTML = '';
            q.options.forEach((o, i) => addOptInput(o, i === q.answer));
            document.getElementById('modal-question').classList.remove('hidden-view');
        }
        function deleteQ(idx) {
            if(!confirm("Hapus soal?")) return;
            db[activeTokenAdmin].questions.splice(idx, 1);
            saveDB(); renderSoalList(); renderMapelList();
        }

        function showQModal() {
            document.getElementById('editor-q').value = '';
            document.getElementById('editor-pts').value = 2.5;
            document.getElementById('editor-opts').innerHTML = '';
            addOptInput('', true); addOptInput('');
            document.getElementById('modal-question').classList.remove('hidden-view');
        }

        function addOptInput(val = '', isCorrect = false) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2";
            div.innerHTML = `<input type="radio" name="corr_ans" ${isCorrect?'checked':''}><input type="text" class="border p-1.5 rounded text-sm w-full opt-val" value="${val}"><button onclick="this.parentElement.remove()" class="text-red-500">x</button>`;
            document.getElementById('editor-opts').appendChild(div);
        }

        function saveEditorQuestion() {
            const q = document.getElementById('editor-q').value;
            const pts = parseFloat(document.getElementById('editor-pts').value);
            const opts = [], radios = document.querySelectorAll('input[name="corr_ans"]');
            let ans = -1;
            
            document.querySelectorAll('.opt-val').forEach((inp, i) => {
                if(inp.value) { opts.push(inp.value); if(radios[i].checked) ans = i; }
            });

            if(!q || opts.length < 2 || ans === -1) return alert("Data soal tidak valid");
            const newQ = { id: Date.now(), question: q, options: opts, answer: ans, points: pts };
            
            if(editingQIdx !== null) db[activeTokenAdmin].questions[editingQIdx] = newQ;
            else db[activeTokenAdmin].questions.push(newQ);
            
            saveDB();
            document.getElementById('modal-question').classList.add('hidden-view');
            renderSoalList();
            renderMapelList();
        }

        // Utils
        function showError(msg) {
            const el = document.getElementById('input-error');
            document.getElementById('error-text').textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
        function saveDB() { localStorage.setItem('cbt_db_v1', JSON.stringify(db)); }

        // Setup Default DB if Empty
        if(Object.keys(db).length === 0) {
            db = {
                "DEMO": {
                    name: "Ujian Demo Teknologi",
                    questions: [
                        {id:1, question:"Singkatan dari CPU?", options:["Central Processing Unit","Central Power Unit","Computer Personal Unit"], answer:0, points:10},
                        {id:2, question:"Port standar HTTP?", options:["21","80","443"], answer:1, points:10}
                    ]
                }
            };
            saveDB();
        }
    </script>
</body>
</html>
