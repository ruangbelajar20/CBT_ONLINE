<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Pro - Ujian Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #2563eb; }
        
        /* Glassmorphism & Utils */
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-card-login { background: rgba(255, 255, 255, 1); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        
        /* Table Styles */
        .modern-table th { background: #f8fafc; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 12px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .modern-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.875rem; vertical-align: middle; white-space: nowrap; }
        .modern-table tr:hover { background: #f1f5f9; }
        
        /* Global Dropdown */
        #global-dropdown { position: fixed; z-index: 9999; background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; width: 180px; display: none; }
        #global-dropdown button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: #334155; transition: background 0.2s; }
        #global-dropdown button:hover { background-color: #f1f5f9; color: #2563eb; }

        /* Navigation Styles */
        .nav-item, .settings-nav-item { border-left: 4px solid transparent; transition: all 0.2s ease-in-out; cursor: pointer; }
        .nav-item.active-nav { background-color: #eff6ff; color: #2563eb; border-left-color: #2563eb; }
        .settings-nav-item.active { background: linear-gradient(90deg, #eff6ff 0%, #ffffff 100%); color: #2563eb; border-left-color: #2563eb; font-weight: 700; }
        .settings-nav-item:hover:not(.active), .nav-item:hover:not(.active-nav) { background-color: #f8fafc; border-left-color: #cbd5e1; }

        /* Sub-tab Button */
        .sub-tab-btn { border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .sub-tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 700; }
        .sub-tab-btn:hover:not(.active) { color: #334155; border-bottom-color: #cbd5e1; }

        /* Dash Card */
        .dash-stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s; }
        .dash-stat-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transform: translateY(-2px); }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
        
        #admin-sidebar { transition: width 0.3s ease; }
        .sidebar-collapsed { width: 5rem !important; }
        .sidebar-collapsed .nav-text, .sidebar-collapsed .nav-header, .sidebar-collapsed #sidebar-logo { display: none; }
        .sidebar-collapsed #sidebar-icon-only { display: flex !important; }

        /* Custom Editor Styles */
        .editor-content-area ul { list-style-type: disc; margin-left: 1.5rem; }
        .editor-content-area ol { list-style-type: decimal; margin-left: 1.5rem; }
        .editor-content-area b { font-weight: bold; }
        .editor-content-area i { font-style: italic; }
        .editor-content-area u { text-decoration: underline; }
        .editor-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }

        /* --- EXAM CARD ID SIZE (6cm x 4cm) --- */
        .exam-card { 
            width: 6cm; 
            height: 4cm; 
            border: 1px solid #000; 
            padding: 3px; 
            background: white; 
            font-family: 'Times New Roman', serif; 
            margin-bottom: 10px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 10px 10px;
            font-size: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        .exam-card-header { 
            display: flex; 
            border-bottom: 1px double #000; 
            padding-bottom: 2px; 
            margin-bottom: 3px; 
            align-items: center; 
            justify-content: center;
        }
        .exam-card-logo { width: 24px; height: 24px; object-fit: contain; margin-right: 3px; }
        .exam-card-header-text { flex: 1; text-align: center; line-height: 1; overflow: hidden; }
        .exam-card-h1 { font-size: 10px; font-weight: bold; margin-bottom: 1px; white-space: nowrap; }
        .exam-card-h2 { font-size: 10px; font-weight: bold; margin-bottom: 1px; white-space: nowrap; }
        .exam-card-h3 { font-size: 8px; white-space: nowrap; }
        
        .exam-card-body { display: flex; gap: 4px; }
        .exam-card-photo-box { width: 1.5cm; height: 1.8cm; background: #eee; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .exam-card-photo-img { width: 100%; height: 100%; object-fit: cover; }
        .exam-card-info { flex: 1; overflow: hidden; }

        .exam-card-title { font-weight: bold; font-size: 10px; text-align: center; margin-bottom: 1px; text-transform: uppercase; text-decoration: underline; }
        .exam-card-subtitle { font-weight: bold; font-size: 8px; text-align: center; margin-bottom: 2px; text-transform: uppercase; }
        
        .exam-card-row { display: flex; margin-bottom: 1px; font-size: 7px; line-height: 1.1; }
        .exam-card-label { width: 40px; font-weight: bold; }
        .exam-card-val { flex: 1; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* --- PRINT OPTIMIZATION (3 Cols x 6 Rows - CENTERED & SAFE) --- */
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 0; 
            }
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; }
            body * { visibility: hidden; }
            
            #card-preview-area, #card-preview-area * { visibility: visible; }
            
            #card-preview-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 210mm; 
                min-height: 297mm;
                
                display: grid;
                grid-template-columns: repeat(3, 6cm); 
                grid-auto-rows: 4cm;
                
                column-gap: 5mm; 
                row-gap: 5mm;
                
                justify-content: center;
                align-content: start;
                
                padding-top: 1mm; 
            }
            
            .exam-card { 
                visibility: visible;
                margin: 0; 
                border: 1px solid #000; 
                width: 6cm;
                height: 4cm;
                page-break-inside: avoid;
                break-inside: avoid;
                background-image: none !important;
                box-shadow: none !important;
            }
            
            button, input, textarea, select, .no-print, #global-dropdown, #admin-sidebar, header { display: none !important; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col bg-blue-600" onclick="closeGlobalDropdown(event)">

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9g4AUZ14a0_vbAXwJob9a4lSh7bwYwUDB9ISCaiScU2PNwTOyzGNtQ8Nlt9kqayQ/exec"; 
        const ADMIN_PIN = "2025"; 
        const MAX_VIOLATIONS = 3;
        var tokenInterval;
    </script>

    <!-- GLOBAL DROPDOWN -->
    <div id="global-dropdown">
        <button onclick="alert('Daftarkan ke ujian...')">Daftarkan ke Ujian</button>
        <button onclick="editStudentAction()">Edit Peserta</button>
        <button onclick="moveClassAction()">Pindah Kelas</button>
        <button onclick="moveRoomAction()">Pindah Ruangan</button>
        <button onclick="moveSessionAction()">Pindah Sesi</button>
    </div>

    <!-- BACKGROUND -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-600 to-indigo-700"></div>
        <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-white opacity-10 blur-3xl"></div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col h-full overflow-hidden relative z-10">
        
        <!-- STUDENT HEADER -->
        <div id="student-header" class="w-full max-w-7xl mx-auto px-6 py-4 flex justify-between items-center transition-all duration-300">
            <div class="flex items-center gap-3 group cursor-default">
                <img id="school-logo-img" src="" alt="Logo" class="h-12 w-auto object-contain hidden bg-white rounded p-1 shadow-sm">
                <div id="default-logo" class="h-10 w-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i data-feather="box" class="w-6 h-6"></i>
                </div>
                <div><h1 class="font-bold text-xl leading-none text-white tracking-tight" id="school-name-display">CBT ONLINE</h1><p class="text-[11px] font-medium text-blue-100 uppercase tracking-wider mt-0.5">Secure Exam System</p></div>
            </div>
            <button onclick="showAdminLogin()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-md border border-white/10 transition flex items-center gap-2 shadow-sm"><i data-feather="lock" class="w-4 h-4"></i> Admin</button>
        </div>

        <!-- MAIN CONTENT -->
        <main class="flex-grow flex items-center justify-center p-4 overflow-hidden">

            <!-- 1. WELCOME VIEW (LOGIN PESERTA) -->
            <div id="view-welcome" class="glass-card-login w-full max-w-md p-10 fade-in relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <div class="text-center mb-8"><h2 class="text-3xl font-extrabold text-slate-800 mb-1">Login Peserta</h2><p class="text-slate-400 text-sm">Silakan masuk untuk memulai ujian</p></div>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Username</label>
                        <div class="relative group">
                            <i data-feather="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i>
                            <input type="text" id="login-username" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-semibold text-slate-700" placeholder="Username Peserta">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Password</label>
                        <div class="relative group">
                            <i data-feather="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i>
                            <input type="password" id="login-password" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-semibold text-slate-700" placeholder="Password">
                        </div>
                    </div>
                    <div id="token-input-group">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 pl-1">Token Soal</label>
                        <div class="relative group">
                            <i data-feather="key" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition"></i>
                            <input type="text" id="input-token" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all font-bold text-blue-600 text-center tracking-[0.2em] uppercase" placeholder="TOKEN">
                        </div>
                    </div>
                </div>
                <div id="input-error" class="mt-4 hidden bg-red-50 border border-red-100 text-red-600 text-xs font-bold p-3 rounded-xl flex items-center animate-pulse"><i data-feather="alert-circle" class="w-4 h-4 mr-2 shrink-0"></i> <span id="error-text">Error</span></div>
                <button onclick="startQuiz()" class="w-full mt-8 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2 text-sm">Mulai Mengerjakan <i data-feather="arrow-right" class="w-4 h-4"></i></button>
            </div>

            <!-- 2. PLAYING VIEW -->
            <div id="view-playing" class="w-full max-w-5xl h-full flex flex-col hidden-view fade-in bg-slate-50 rounded-2xl overflow-hidden shadow-2xl">
                 <div class="bg-white border-b px-6 py-4 flex justify-between items-center">
                    <div class="flex gap-4 items-center"><div class="h-10 w-10 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold shadow-sm" id="avatar-initial">U</div><div><h3 class="font-bold text-slate-800 text-sm" id="play-name">User</h3><p class="text-xs text-slate-500 font-medium" id="play-info">Info</p></div></div>
                    <div class="flex items-center gap-3"><span class="text-xs font-bold text-slate-400 uppercase hidden sm:inline">Sisa Waktu</span><div class="font-mono text-xl font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg border border-blue-100" id="timer-display">--:--</div></div>
                 </div>
                 <div class="w-full h-1 bg-slate-200"><div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div></div>
                 <div class="flex-grow overflow-y-auto p-6 md:p-10 custom-scrollbar bg-slate-50">
                    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div class="mb-6 flex justify-between items-center"><span class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm shadow-blue-200">SOAL NO <span id="q-num">1</span></span><span id="q-type-badge" class="text-xs font-bold text-slate-400 uppercase">Pilihan Ganda</span></div>
                        <div id="q-media" class="mb-6 hidden rounded-xl overflow-hidden border border-slate-100"></div>
                        <div id="q-text" class="prose max-w-none text-slate-800 mb-8 leading-relaxed editor-content-area">Pertanyaan...</div>
                        <div id="options-container" class="space-y-3"></div>
                    </div>
                 </div>
                 <div class="p-5 border-t bg-white flex justify-between items-center">
                    <button id="btn-prev" onclick="prevQ()" class="px-5 py-2.5 rounded-xl border-2 border-slate-100 text-slate-500 font-bold text-sm hover:bg-slate-50 transition">Sebelumnya</button>
                    <button id="btn-next" onclick="nextQ()" class="px-6 py-2.5 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition flex items-center gap-2">Selanjutnya <i data-feather="arrow-right" class="w-4 h-4"></i></button>
                    <button id="btn-finish" onclick="finishQuiz()" class="hidden px-6 py-2.5 rounded-xl bg-emerald-500 text-white text-sm font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition">Selesai & Kumpulkan</button>
                 </div>
            </div>

            <!-- 3. ADMIN DASHBOARD -->
            <div id="view-admin" class="w-full h-full hidden-view fade-in flex overflow-hidden bg-slate-100">
                <aside id="admin-sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 transition-all duration-300 z-20">
                    <div class="h-16 flex items-center px-6 border-b border-slate-100">
                        <div id="sidebar-logo" class="flex items-center gap-3 font-bold text-lg text-slate-800"><div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-200"><i data-feather="command" class="w-5 h-5"></i></div><span>Admin<span class="text-blue-600">Panel</span></span></div>
                        <div id="sidebar-icon-only" class="hidden w-full justify-center"><div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i data-feather="command" class="w-5 h-5"></i></div></div>
                    </div>
                    <nav class="flex-grow p-4 space-y-1 overflow-y-auto custom-scrollbar">
                        <p class="nav-header px-4 text-[10px] font-extrabold text-slate-400 uppercase mb-2 mt-2 tracking-wider">Menu Utama</p>
                        <button onclick="adminNav('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 active-nav"><i data-feather="grid" class="w-5 h-5"></i> <span class="nav-text">Dashboard</span></button>
                        <button onclick="adminNav('students')" id="nav-students" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="users" class="w-5 h-5"></i> <span class="nav-text">Data Peserta</span></button>
                        <button onclick="adminNav('questions')" id="nav-questions" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="file-text" class="w-5 h-5"></i> <span class="nav-text">Bank Soal</span></button>
                        <button onclick="adminNav('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-slate-600"><i data-feather="settings" class="w-5 h-5"></i> <span class="nav-text">Pengaturan</span></button>
                    </nav>
                    <div class="p-4 border-t"><button onclick="logoutAdmin()" class="w-full py-2 text-sm font-bold text-red-500 bg-red-50 rounded-lg hover:bg-red-100">Logout</button></div>
                </aside>

                <div class="flex-grow flex flex-col h-full overflow-hidden relative">
                    <header class="bg-white h-16 border-b border-slate-200 px-4 flex justify-between items-center z-10 shrink-0">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i data-feather="menu" class="w-5 h-5"></i></button>
                            <div class="relative hidden md:block group"><i data-feather="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition"></i><input type="text" placeholder="Cari ujian..." class="pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition w-64"></div>
                        </div>
                        <div class="flex items-center gap-3 md:gap-5">
                            <div id="digital-clock" class="hidden md:block font-mono font-bold text-slate-600 text-sm bg-slate-50 px-3 py-1 rounded-md border border-slate-200">00:00:00 AM</div>
                            <button onclick="toggleFullScreen()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition"><i data-feather="maximize" class="w-5 h-5"></i></button>
                            <div class="relative">
                                <button onclick="toggleProfileMenu()" class="flex items-center gap-3 hover:bg-slate-50 p-1.5 pr-3 rounded-lg transition border border-transparent hover:border-slate-200"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-8 w-8 rounded-full bg-blue-100 border border-blue-200"><div class="text-left hidden sm:block"><p class="text-xs font-bold text-slate-700">Administrator</p><p class="text-[10px] text-slate-400 font-medium">Super Admin</p></div><i data-feather="chevron-down" class="w-4 h-4 text-slate-400 ml-1"></i></button>
                                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 z-50">
                                    <a href="#" onclick="adminNav('settings'); switchSettingsTab('profile'); toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Profil Saya</a>
                                    <a href="#" onclick="adminNav('settings'); switchSettingsTab('about'); toggleProfileMenu()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Tentang</a>
                                    <div class="border-t border-slate-50 my-1"></div>
                                    <button onclick="logoutAdmin()" class="w-full text-left px-4 py-2 text-sm text-red-500 font-bold hover:bg-red-50">Keluar</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div class="flex-grow overflow-y-auto custom-scrollbar p-6 md:p-8 bg-slate-50/50">
                        <!-- PANEL: DASHBOARD -->
                        <div id="admin-panel-dashboard" class="admin-panel space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="dash-stat-card col-span-2 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-feather="activity" class="w-24 h-24 text-blue-600"></i></div>
                                    <div class="flex justify-between items-start mb-6 relative z-10"><div><h3 class="font-bold text-slate-700 text-lg">Trafik Monitor</h3><p class="text-xs text-slate-400">Statistik koneksi real-time</p></div><button onclick="resetTrafficStats()" class="text-xs border border-slate-200 rounded-lg px-3 py-1.5 bg-white text-slate-500 hover:bg-slate-50 hover:text-red-500 font-bold shadow-sm">Reset Data</button></div>
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-8 relative z-10"><div class="pr-8 border-r border-slate-100"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">SOCKET</p><p class="text-4xl font-black text-blue-600" id="stat-socket">860</p></div><div><p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">HTTP REQUESTS</p><div class="flex items-baseline gap-2"><p class="text-4xl font-black text-indigo-600" id="stat-http">11,268</p><span class="text-xs text-slate-400 font-medium">Total Hits</span></div></div></div>
                                </div>
                                <div class="dash-stat-card flex flex-col justify-between relative overflow-hidden">
                                    <div><div class="flex justify-between items-start"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">TOKEN UJIAN</p><div class="w-6 h-6 rounded-full border-2 border-blue-100 border-t-blue-500 animate-spin"></div></div><h3 class="text-4xl font-black text-slate-800 tracking-wider mt-2 mb-1 font-mono" id="dash-token">D5YNRG</h3><p class="text-xs text-slate-500 font-medium">Masa aktif <span class="text-blue-600 font-bold" id="token-timer-display">--:--</span></p></div>
                                    <button onclick="generateNewToken()" class="mt-6 w-full bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-3 rounded-xl shadow-lg shadow-emerald-100 flex items-center justify-center gap-2"><i data-feather="refresh-cw" class="w-4 h-4"></i> Perbaharui Token</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700">954</p><p class="text-xs text-slate-400 mt-1">Total Koneksi</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> 1 terhubung</div></div>
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700" id="stat-total-students">0</p><p class="text-xs text-slate-400 mt-1">Total Peserta</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> Online</div></div>
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700">1</p><p class="text-xs text-slate-400 mt-1">Total Pengawas</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> Online</div></div>
                                <div class="dash-stat-card"><p class="text-3xl font-bold text-slate-700">4</p><p class="text-xs text-slate-400 mt-1">Total Pengelola</p><div class="text-xs text-emerald-500 font-bold mt-2 flex items-center gap-1"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> Online</div></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="dash-stat-card"><p class="text-2xl font-bold text-slate-700" id="stat-total-classes">0</p><p class="text-xs text-slate-400">Total Kelas</p></div>
                                <div class="dash-stat-card"><p class="text-2xl font-bold text-slate-700" id="stat-total-majors">0</p><p class="text-xs text-slate-400">Total Jurusan</p></div>
                                <div class="dash-stat-card"><p class="text-2xl font-bold text-slate-700" id="stat-total-exams">0</p><p class="text-xs text-slate-400">Total Ujian <span class="text-emerald-500 font-bold">[Aktif]</span></p></div>
                            </div>
                        </div>

                        <!-- PANEL: DAFTAR PESERTA -->
                        <div id="admin-panel-students" class="admin-panel hidden-view h-full">
                            <div class="bg-white p-6 rounded-xl shadow-sm border mb-4 h-full flex flex-col">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-lg text-slate-800">Daftar Peserta Ujian</h3>
                                    <div class="flex gap-2">
                                        <button onclick="showAddStudent()" class="p-2 bg-slate-100 rounded hover:bg-slate-200 border border-slate-300 text-slate-600" title="Tambah Peserta"><i data-feather="plus" class="w-4 h-4"></i></button>
                                        <button onclick="triggerZipUpload()" class="p-2 bg-slate-100 rounded hover:bg-slate-200 border border-slate-300 text-slate-600" title="Upload Foto Massal (ZIP)"><i data-feather="image" class="w-4 h-4"></i></button>
                                        <input type="file" id="zip-upload-input" class="hidden" accept=".zip" onchange="handleZipUpload(this)">
                                        <button onclick="alert('Import feature placeholder')" class="p-2 bg-slate-100 rounded hover:bg-slate-200 border border-slate-300 text-slate-600"><i data-feather="upload" class="w-4 h-4"></i></button>
                                        <button onclick="downloadStudentTemplateWord()" class="p-2 bg-slate-100 rounded hover:bg-slate-200 border border-slate-300 text-slate-600" title="Download Template Word"><i data-feather="file" class="w-4 h-4"></i></button>
                                        <button onclick="downloadExcel()" class="p-2 bg-slate-100 rounded hover:bg-slate-200 border border-slate-300 text-slate-600"><i data-feather="download" class="w-4 h-4"></i></button>
                                        <button onclick="showStudentCard()" class="p-2 bg-slate-100 rounded hover:bg-slate-200 border border-slate-300 text-slate-600" title="Cetak Kartu"><i data-feather="credit-card" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <!-- Filters -->
                                <div class="flex gap-4 mb-4 items-center flex-wrap">
                                    <div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-600">Kelas</span><select id="filter-class" class="border p-2 rounded text-sm w-32"><option>Semua</option></select></div>
                                    <div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-600">Ruangan</span><select id="filter-room" class="border p-2 rounded text-sm w-32"><option>Semua</option><option>R.1</option><option>R.2</option></select></div>
                                    <div class="flex-grow"></div>
                                    <div class="flex items-center gap-2"><span class="text-sm text-slate-500">Search:</span><input type="text" class="border p-1 rounded text-sm"></div>
                                </div>
                                <div class="flex-grow overflow-auto border rounded-lg h-[500px]">
                                    <table class="w-full text-left modern-table relative">
                                        <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b sticky top-0 z-20">
                                            <tr>
                                                <!-- FIX: Add Select All Checkbox -->
                                                <th class="px-4 py-3"><input type="checkbox" id="select-all-students" onclick="toggleAllCheckboxes(this)"></th>
                                                <th class="px-4 py-3 text-center">Aksi</th>
                                                <th class="px-4 py-3">#</th>
                                                <th class="px-4 py-3">Username</th>
                                                <th class="px-4 py-3">Password</th>
                                                <th class="px-4 py-3">Nama</th>
                                                <th class="px-4 py-3">ID Peserta</th>
                                                <th class="px-4 py-3">Kelas</th>
                                                <th class="px-4 py-3">Ruangan</th>
                                                <th class="px-4 py-3">Sesi</th>
                                                <th class="px-4 py-3">Sekolah</th>
                                                <th class="px-4 py-3">Agama</th>
                                                <th class="px-4 py-3">Catatan</th>
                                            </tr>
                                        </thead>
                                        <tbody id="table-students-body" class="bg-white"></tbody>
                                    </table>
                                </div>
                                <div class="mt-4 flex justify-between items-center text-xs text-slate-500">
                                    <span>Showing All entries</span>
                                    <div class="flex gap-1"><button class="px-3 py-1 border rounded hover:bg-slate-50">Previous</button><button class="px-3 py-1 border rounded hover:bg-slate-50">Next</button></div>
                                </div>
                            </div>
                        </div>

                        <!-- PANEL: TAMBAH PESERTA -->
                        <div id="view-admin-add-student" class="admin-panel hidden-view h-full bg-white p-8 rounded-xl border border-slate-200 overflow-y-auto">
                            <!-- ... (Add Student Form Same as Before) ... -->
                            <div class="flex justify-between items-center mb-8 pb-4 border-b">
                                <h3 class="font-bold text-xl text-slate-800" id="add-student-title">Tambah Peserta</h3>
                                <div class="text-sm text-slate-400">Dashboard / Tambah Peserta</div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="bg-white border rounded-xl p-6 shadow-sm">
                                    <h4 class="font-bold text-center text-slate-700 mb-2">Akun Peserta</h4>
                                    <div class="space-y-4">
                                        <div><label class="block text-xs font-bold text-red-500 mb-1">Nama Peserta*</label><input id="add-name" class="w-full border p-2 rounded text-sm" placeholder="Nama Peserta"></div>
                                        <div><label class="block text-xs font-bold text-red-500 mb-1">ID Peserta*</label><input id="add-id" class="w-full border p-2 rounded text-sm" placeholder="Masukan NISN/NIM/NPM/Other"></div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label class="block text-xs font-bold text-red-500 mb-1">Username*</label><input id="add-user" class="w-full border p-2 rounded text-sm" placeholder="Username"></div>
                                            <div><label class="block text-xs font-bold text-red-500 mb-1">Password*</label><input id="add-pass" class="w-full border p-2 rounded text-sm" placeholder="Password"></div>
                                        </div>
                                    </div>
                                    <div class="mt-6 border-t pt-4">
                                        <label class="block text-xs font-bold text-slate-600 mb-2">Foto Peserta</label>
                                        <div class="flex items-center gap-4">
                                            <div class="w-16 h-20 bg-slate-100 border rounded flex items-center justify-center overflow-hidden">
                                                <img id="add-photo-preview" src="https://via.placeholder.com/60" class="w-full h-full object-cover">
                                            </div>
                                            <div class="space-y-2">
                                                <input type="file" id="add-photo" class="text-xs text-slate-500" accept="image/*" onchange="previewStudentPhoto(this)">
                                                <button onclick="clearStudentPhoto()" class="text-xs text-red-500 font-bold hover:underline">Hapus Foto</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white border rounded-xl p-6 shadow-sm">
                                    <h4 class="font-bold text-center text-slate-700 mb-2">Informasi Lainnya</h4>
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label class="block text-xs font-bold text-red-500 mb-1">Sekolah*</label><input id="add-school" class="w-full border p-2 rounded text-sm" placeholder="Nama Sekolah"></div>
                                            <div><label class="block text-xs font-bold text-red-500 mb-1">Kelas/Jurusan*</label><select id="add-class" class="w-full border p-2 rounded text-sm"><option>-- Pilih Kelas --</option></select></div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label class="block text-xs font-bold text-red-500 mb-1">Ruangan*</label><select id="add-room" class="w-full border p-2 rounded text-sm"><option>-- Pilih Ruangan --</option><option>R.1</option><option>R.2</option></select></div>
                                            <div><label class="block text-xs font-bold text-red-500 mb-1">Sesi Ujian*</label><input id="add-session" class="w-full border p-2 rounded text-sm" placeholder="Sesi Ujian"></div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label class="block text-xs font-bold text-slate-600 mb-1">Agama</label><input id="add-religion" class="w-full border p-2 rounded text-sm" placeholder="Agama"></div>
                                            <div><label class="block text-xs font-bold text-slate-600 mb-1">Catatan</label><input id="add-note" class="w-full border p-2 rounded text-sm" placeholder="Tambahkan Catatan"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end gap-3">
                                <button onclick="adminNav('students')" class="px-6 py-2 bg-slate-100 text-slate-600 font-bold rounded-lg hover:bg-slate-200">Kembali</button>
                                <button onclick="saveNewStudentData()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700" id="btn-save-student">+ Tambahkan</button>
                            </div>
                        </div>

                        <!-- PANEL: KARTU PESERTA (UPDATED) -->
                        <div id="view-admin-student-card" class="admin-panel hidden-view h-full bg-white p-8 rounded-xl border border-slate-200 overflow-y-auto">
                            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                                <h3 class="font-bold text-xl text-slate-800">Kartu Peserta</h3>
                                <div class="text-sm text-slate-400">Dashboard / Kartu Peserta</div>
                            </div>
                            
                            <h4 class="font-bold text-lg text-slate-700 mb-2">Template Kartu</h4>
                            <p class="text-sm text-slate-500 mb-6">Sesuaikan tampilan kartu ujian. Anda dapat mengubah teks kop, judul, dan logo.</p>

                            <div class="flex flex-col lg:flex-row gap-8 mt-6">
                                <!-- LEFT: SETTINGS -->
                                <div class="w-full lg:w-1/3 space-y-6">
                                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                        <h5 class="font-bold text-slate-700 mb-4 text-sm">Pengaturan Kop & Judul</h5>
                                        <div class="space-y-3">
                                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Header Baris 1 (Kop)</label><input id="card-header-1" class="w-full border p-2 rounded text-sm font-bold" value="PELAKSANA UJIAN SEKOLAH" oninput="saveCardSettings(); renderCardPreview()"></div>
                                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Header Baris 2 (Nama Sekolah)</label><input id="card-header-2" class="w-full border p-2 rounded text-sm font-bold" value="SMA NEGERI CONTOH" oninput="saveCardSettings(); renderCardPreview()"></div>
                                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Header Baris 3 (Alamat)</label><textarea id="card-header-3" class="w-full border p-2 rounded text-sm font-bold" rows="2" oninput="saveCardSettings(); renderCardPreview()"></textarea></div>
                                            <hr class="border-slate-200 my-2">
                                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Judul Kartu</label><input id="card-title" class="w-full border p-2 rounded text-sm font-bold" value="KARTU PESERTA" oninput="saveCardSettings(); renderCardPreview()"></div>
                                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Sub-Judul Kartu</label><input id="card-subtitle" class="w-full border p-2 rounded text-sm" value="PENILAIAN AKHIR SEMESTER (PAS)" oninput="saveCardSettings(); renderCardPreview()"></div>
                                        </div>
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                        <h5 class="font-bold text-slate-700 mb-4 text-sm">Logo Kartu</h5>
                                        <input type="file" id="card-logo-input" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200" accept="image/*" onchange="updateCardLogo(this)">
                                    </div>
                                    <div class="pt-4 border-t">
                                        <button onclick="window.print()" class="w-full py-3 bg-slate-800 text-white font-bold rounded-lg mb-3 shadow-lg hover:bg-slate-900"><i data-feather="printer" class="inline w-4 h-4 mr-2"></i> Cetak Kartu</button>
                                        <button onclick="adminNav('students')" class="w-full py-3 bg-white border border-slate-300 text-slate-600 font-bold rounded-lg hover:bg-slate-50">Kembali</button>
                                    </div>
                                </div>
                                <!-- RIGHT: PREVIEW -->
                                <div class="w-full lg:w-2/3 flex flex-col items-center bg-slate-100 rounded-xl p-8 border border-slate-200 min-h-[500px]">
                                    <p class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Preview Kartu (A4 Portrait)</p>
                                    <div id="card-preview-area"></div>
                                </div>
                            </div>
                        </div>

                        <!-- PANEL: LIST OF EXAMS (NEW - Feature 1) -->
                        <div id="admin-panel-questions" class="admin-panel hidden-view">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 h-full flex flex-col shadow-sm">
                                <div class="flex justify-between items-center mb-6">
                                    <div><h3 class="font-bold text-xl text-slate-800">Daftar Ujian (Bank Soal)</h3></div>
                                    <div class="flex gap-2">
                                        <!-- Feature 2: New Buttons -->
                                        <button onclick="downloadTemplateWord()" class="border px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 flex items-center gap-1"><i data-feather="file-text" class="w-3 h-3"></i> Template Word</button>
                                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-green-700"><i data-feather="download" class="w-3 h-3"></i> Import Soal</button>
                                        <button class="bg-orange-500 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-orange-600"><i data-feather="upload" class="w-3 h-3"></i> Export</button>
                                        <button onclick="openAddSubject()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-slate-900"><i data-feather="plus" class="w-3 h-3"></i> Tambah Ujian</button>
                                    </div>
                                </div>
                                
                                <div class="flex-grow flex flex-col gap-4 overflow-hidden" id="exam-list-container">
                                    <!-- List of Exams will be rendered here -->
                                    <!-- Example Item Structure -->
                                    <!-- 
                                    <div class="bg-slate-50 border rounded-xl p-4 flex justify-between items-center">
                                        <div>
                                            <h4 class="font-bold text-lg text-slate-700">BAHASA INDONESIA</h4>
                                            <p class="text-xs text-slate-500">Token: BIND123 • 50 Soal • Kelas X</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="px-3 py-1.5 bg-blue-100 text-blue-600 text-xs font-bold rounded hover:bg-blue-200">Edit Soal</button>
                                            <button class="px-3 py-1.5 bg-slate-200 text-slate-600 text-xs font-bold rounded hover:bg-slate-300">Edit Peserta</button>
                                            <button class="px-3 py-1.5 bg-slate-200 text-slate-600 text-xs font-bold rounded hover:bg-slate-300">Edit Ruang</button>
                                            <button class="px-3 py-1.5 bg-red-100 text-red-600 text-xs font-bold rounded hover:bg-red-200">Hapus</button>
                                        </div>
                                    </div> 
                                    -->
                                </div>
                                
                                <!-- Hidden Detail View for specific exam questions -->
                                <div id="exam-detail-view" class="hidden h-full flex flex-col">
                                     <div class="flex items-center gap-3 mb-4 pb-2 border-b">
                                         <button onclick="closeExamDetail()" class="p-1 hover:bg-slate-100 rounded"><i data-feather="arrow-left"></i></button>
                                         <h4 class="font-bold text-lg text-blue-600" id="active-exam-title">Nama Mapel</h4>
                                         <div class="flex-grow"></div>
                                         <button onclick="openAddQuestion()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold">+ Tambah Soal Manual</button>
                                     </div>
                                     <div id="soal-list" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50/50 custom-scrollbar rounded-xl border"></div>
                                </div>
                            </div>
                        </div>

                        <!-- PANEL: SETTINGS (FIXED & COMPLETE) -->
                        <div id="admin-panel-settings" class="admin-panel hidden-view h-full">
                            <h3 class="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2"><i data-feather="settings" class="text-slate-400"></i> Pengaturan Aplikasi</h3>
                            
                            <div class="flex flex-col lg:flex-row gap-6 h-[calc(100%-4rem)]">
                                <!-- Sidebar Settings -->
                                <div class="w-full lg:w-64 bg-white rounded-2xl border border-slate-200 h-fit lg:h-full overflow-y-auto shadow-sm shrink-0">
                                    <nav class="p-3 space-y-1">
                                        <button onclick="switchSettingsTab('profile')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition active" id="set-nav-profile"><i data-feather="user" class="w-4 h-4"></i> Profil Saya</button>
                                        <button onclick="switchSettingsTab('token')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-token"><i data-feather="key" class="w-4 h-4"></i> Token</button>
                                        <button onclick="switchSettingsTab('access')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-access"><i data-feather="shield" class="w-4 h-4"></i> Kelola Akses</button>
                                        <button onclick="switchSettingsTab('license')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-license"><i data-feather="file-minus" class="w-4 h-4"></i> Lisensi</button>
                                        <button onclick="switchSettingsTab('others')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-others"><i data-feather="sliders" class="w-4 h-4"></i> Lainnya</button>
                                        <button onclick="switchSettingsTab('about')" class="settings-nav-item w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 flex items-center gap-3 transition" id="set-nav-about"><i data-feather="info" class="w-4 h-4"></i> Tentang</button>
                                    </nav>
                                </div>

                                <!-- Content Settings -->
                                <div class="flex-grow bg-white rounded-2xl border border-slate-200 shadow-sm p-8 overflow-y-auto">
                                    <!-- 1. PROFIL -->
                                    <div id="set-content-profile" class="settings-content">
                                        <div class="flex flex-col items-center mb-8"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="h-24 w-24 rounded-full bg-slate-100 border-4 border-white shadow-lg mb-4"><h2 class="text-2xl font-bold text-slate-800">Administrator</h2><p class="text-sm text-slate-500">administrator</p></div>
                                        <div class="col-span-2"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-slate-700">Riwayat Login:</h4><button onclick="clearLoginHistory()" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">Bersihkan Riwayat!</button></div><table class="w-full text-left text-sm border rounded-lg overflow-hidden"><thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold"><tr><th class="p-3">Berhasil Login</th><th class="p-3">IP</th><th class="p-3">OS</th><th class="p-3">Browser</th></tr></thead><tbody class="text-slate-600" id="login-history-body"><tr class="border-b"><td class="p-3">sejam yang lalu</td><td class="p-3">::1</td><td class="p-3">Windows 10</td><td class="p-3">Firefox 145.0</td></tr><tr class="border-b"><td class="p-3">14 jam yang lalu</td><td class="p-3">::1</td><td class="p-3">Windows 10</td><td class="p-3">Chrome 142.0.0.0</td></tr></tbody></table></div>
                                    </div>
                                    
                                    <!-- 2. TOKEN -->
                                    <div id="set-content-token" class="settings-content hidden-view">
                                        <div class="mb-8"><h3 class="text-4xl font-black text-slate-800 tracking-wider mb-1 font-mono" id="setting-token-display">NOFDTI</h3><p class="text-sm text-slate-500 font-medium">Masa hidup token <span class="text-blue-600 font-bold" id="token-timer-settings">--:--</span></p><button onclick="generateNewToken()" class="mt-4 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow-md">Perbaharui Token!</button></div>
                                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-6"><p class="text-sm text-slate-600 mb-6">Token digunakan untuk melakukan konfirmasi peserta terhadap pengelola ujian.</p><div class="flex items-center justify-between mb-6"><label class="text-sm font-bold text-slate-700">Gunakan Token?</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" id="toggle-token" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 checked:border-blue-600"/><label for="toggle-token" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between mb-6"><label class="text-sm font-bold text-slate-700">Masa Hidup (menit)</label><input type="number" id="token-duration" class="w-24 border border-slate-300 rounded-lg p-2 text-center text-sm font-bold outline-none" value="60"></div><div class="text-right"><button onclick="saveTokenSettings()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700">Simpan</button></div></div>
                                    </div>
                                    
                                    <!-- 3. AKSES -->
                                    <div id="set-content-access" class="settings-content hidden-view text-center text-slate-400 py-20">Manajemen Akses User (Coming Soon).</div>
                                    
                                    <!-- 4. LISENSI -->
                                    <div id="set-content-license" class="settings-content hidden-view">
                                         <h4 class="text-lg font-bold text-slate-800 border-b border-slate-100 pb-4 mb-6">Lisensi Aplikasi</h4>
                                        <div class="space-y-4 max-w-3xl">
                                            <div class="flex flex-col sm:flex-row gap-4 items-center bg-slate-50 p-4 rounded-lg border border-slate-100"><span class="text-sm font-bold text-slate-500 w-48">Nomor Serial</span><code class="bg-white border p-2 rounded text-xs font-mono text-slate-600 break-all flex-grow text-center sm:text-left">aaf2-1383-55dd-3da8-b0a3-e6f6-33f4-c4da</code></div>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-8 p-2">
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Nama Instansi</span><p class="text-sm font-medium text-slate-700 mt-1">[demo] - Utama</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">E-Mail</span><p class="text-sm font-medium text-slate-700 mt-1">bebiiigital@gmail.com</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Diterbitkan</span><p class="text-sm font-medium text-slate-700 mt-1">28 November 2025, 9:03 AM</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Versi</span><p class="text-sm font-medium text-slate-700 mt-1">1.20.9</p></div>
                                                <div class="flex justify-between sm:block"><span class="text-sm font-bold text-slate-500">Masa Aktif</span><p class="text-sm font-bold text-emerald-600 mt-1">Unlimited</p></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 5. LAINNYA -->
                                    <div id="set-content-others" class="settings-content hidden-view">
                                        <div class="flex space-x-4 border-b border-slate-200 mb-6">
                                            <button onclick="showSubTab('logo')" class="sub-tab-btn active pb-2 text-sm font-medium">Logo</button>
                                            <button onclick="showSubTab('school')" class="sub-tab-btn pb-2 text-sm font-medium">Info Sekolah</button>
                                            <button onclick="showSubTab('rules')" class="sub-tab-btn pb-2 text-sm font-medium">Panduan</button>
                                        </div>
                                        <div id="sub-logo" class="sub-tab-content">
                                            <h4 class="text-lg font-bold text-slate-800 mb-4">Logo Aplikasi</h4>
                                            <div class="flex gap-6 items-start"><div class="h-20 w-20 bg-white border rounded-xl flex items-center justify-center overflow-hidden shadow-sm"><img id="preview-logo-upload" src="" class="h-full w-full object-contain hidden"><i data-feather="image" class="text-slate-300" id="preview-logo-placeholder"></i></div><div class="flex-grow"><div class="flex border rounded-lg overflow-hidden mb-2"><label class="bg-slate-50 border-r px-4 py-2 text-sm font-bold text-slate-600 cursor-pointer hover:bg-slate-100">Upload <input type="file" class="hidden" accept="image/*" onchange="handleLogoUpload(this)"></label><input class="flex-grow px-4 text-sm text-slate-500 bg-white" placeholder="No file" id="filename-logo" readonly></div><div class="flex gap-2"><button onclick="saveLogoLocal()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs font-bold">Simpan Logo</button><button onclick="resetLogo()" class="bg-red-100 text-red-600 px-4 py-1.5 rounded text-xs font-bold">Reset</button></div></div></div>
                                        </div>
                                        <div id="sub-school" class="sub-tab-content hidden">
                                            <h4 class="text-lg font-bold text-slate-800 mb-4">Informasi Sekolah</h4>
                                            <div class="space-y-4 max-w-2xl">
                                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Sekolah</label><input id="sch-name" class="w-full border p-2 rounded-lg text-sm" value="SMA NEGERI"></div>
                                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenjang Sekolah</label><div class="relative"><select id="sch-level" class="w-full border p-2 rounded-lg text-sm appearance-none bg-white"><option value="">Pilih Jenjang</option><option value="SD/MI">Setingkat SD/MI</option><option value="SMP/Mts">Setingkat SMP/Mts</option><option value="SMA/SMK/MA">Setingkat SMA/SMK/MA</option></select><i data-feather="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Alamat Sekolah</label><textarea id="sch-addr" class="w-full border p-2 rounded-lg text-sm" rows="2"></textarea></div>
                                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email Sekolah</label><input id="sch-email" class="w-full border p-2 rounded-lg text-sm"></div>
                                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Website Sekolah</label><input id="sch-web" class="w-full border p-2 rounded-lg text-sm"></div>
                                                <button onclick="saveSchoolInfo()" class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold">Simpan Info</button>
                                            </div>
                                        </div>
                                        <div id="sub-rules" class="sub-tab-content hidden">
                                            <h4 class="text-lg font-bold text-slate-800 mb-4">Panduan & Tata Tertib</h4>
                                            <div class="flex items-center gap-3 mb-4"><label class="text-sm font-bold text-slate-600">Tampilkan?</label><div class="relative inline-block w-10 mr-2 align-middle select-none"><input type="checkbox" id="toggle-rules" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 checked:border-blue-600"/><label for="toggle-rules" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label></div></div>
                                            <textarea id="rules-content" class="w-full border rounded-xl p-4 text-sm h-64" placeholder="Tulis panduan..."></textarea>
                                            <button onclick="saveRules()" class="mt-4 bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold">Simpan Panduan</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 6. TENTANG -->
                                    <div id="set-content-about" class="settings-content hidden-view text-center py-10">
                                        <h4 class="font-bold text-lg mb-2">Tentang Aplikasi</h4>
                                        <p class="text-sm text-slate-500">Aplikasi CBT Pro Version 1.0.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- OTHER PANELS (QUESTIONS) -->
                        <div id="admin-panel-questions" class="admin-panel hidden-view">...</div>
                    </div>
                </div>
            </div>

            <!-- RESULT VIEW -->
            <div id="view-result-card" class="hidden-view glass-card w-full max-w-md p-8 text-center m-auto fade-in bg-white rounded-2xl shadow-2xl"><h2 class="text-2xl font-bold mb-2 text-slate-800" id="res-title">Selesai</h2><p class="text-sm text-slate-500 mb-6" id="res-msg"></p><div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100"><div class="text-5xl font-black text-blue-600" id="res-score">0</div></div><button onclick="location.reload()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold hover:bg-slate-900">Keluar</button></div>

        </main>
    </div>

    <!-- MODALS -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 hidden-view backdrop-blur-sm"><div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center"><h3 class="font-bold text-lg mb-6">Admin Login</h3><input type="password" id="pin-input" class="w-full text-center text-3xl font-bold tracking-widest border-b-2 py-2 outline-none mb-8" maxlength="4"><div class="flex gap-2"><button onclick="document.getElementById('modal-login').classList.add('hidden-view')" class="flex-1 py-2 bg-slate-100 rounded font-bold text-slate-500">Batal</button><button onclick="checkAdminPin()" class="flex-1 py-2 bg-blue-600 text-white rounded font-bold">Masuk</button></div></div></div>
    
    <!-- MOVE CLASS MODAL -->
    <div id="modal-move-class" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view">
        <div class="bg-white p-6 rounded-xl w-80">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Pindah Kelas</h3>
            <select id="move-class-select" class="w-full border p-2 rounded text-sm mb-4"></select>
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('modal-move-class').classList.add('hidden-view')" class="px-4 py-2 text-slate-500 font-bold">Batal</button><button onclick="saveMoveClass()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Simpan</button></div>
        </div>
    </div>
    <!-- MOVE ROOM MODAL -->
    <div id="modal-move-room" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view">
        <div class="bg-white p-6 rounded-xl w-80">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Pindah Ruangan</h3>
            <select id="move-room-select" class="w-full border p-2 rounded text-sm mb-4"><option>R.1</option><option>R.2</option><option>R.3</option></select>
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('modal-move-room').classList.add('hidden-view')" class="px-4 py-2 text-slate-500 font-bold">Batal</button><button onclick="saveMoveRoom()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Simpan</button></div>
        </div>
    </div>
    <!-- MOVE SESSION MODAL -->
    <div id="modal-move-session" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view">
        <div class="bg-white p-6 rounded-xl w-80">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Pindah Sesi</h3>
            <input id="move-session-input" class="w-full border p-2 rounded text-sm mb-4" placeholder="Contoh: Sesi 1">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('modal-move-session').classList.add('hidden-view')" class="px-4 py-2 text-slate-500 font-bold">Batal</button><button onclick="saveMoveSession()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Simpan</button></div>
        </div>
    </div>

    <!-- Simple Modals for Editors (Questions) -->
    <div id="modal-question" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view">
        <div class="bg-white p-6 rounded-xl w-[900px] h-[90vh] flex flex-col">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Editor Soal</h3>
            <textarea id="ed-q" class="w-full border p-3 rounded-xl h-64 mb-3 text-sm" placeholder="Pertanyaan"></textarea>
            <div id="ed-opts-container" class="flex-grow overflow-y-auto space-y-2 mt-4 p-2 border-t"></div>
            <button onclick="addEditorOpt()" class="text-blue-600 text-sm font-bold mt-2 mb-4">+ Opsi</button>
            <input id="ed-type" type="hidden"><input id="ed-media" type="hidden">
            <div class="pt-4 border-t flex justify-end gap-2">
                <button onclick="document.getElementById('modal-question').classList.add('hidden-view')" class="px-4 py-2 text-slate-500 font-bold">Batal</button>
                <button onclick="saveQuestion()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Simpan</button>
            </div>
        </div>
    </div>
    <div id="modal-subject" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden-view"><div class="bg-white p-6 rounded w-80"><input id="new-token" class="w-full border p-2 mb-2 uppercase" placeholder="TOKEN"><input id="new-mapel" class="w-full border p-2 mb-4" placeholder="Mapel"><button onclick="saveNewSubject()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Simpan</button><button onclick="document.getElementById('modal-subject').classList.add('hidden-view')" class="w-full mt-2 text-slate-500">Batal</button></div></div>

    <script>
        // 1. VARIABLE DECLARATIONS
        feather.replace();
        let db = JSON.parse(localStorage.getItem('cbt_db_v4') || '{}');
        let config = { logo: "", classes: ["X", "XI", "XII"], majors: ["FARMASI 1", "FARMASI 2", "KEPERAWATAN 1", "KEPERAWATAN 2", "TJKT 1", "TJKT 2", "TBSM 1", "TBSM 2", "TKR"], tokenDuration: 105 };
        let adminDataCache = [], editingStudentIdx = null, activeTokenAdmin = null, editingQIdx = null;
        let selectedStudentIndex = null; 
        let activeDropdownIndex = null; // Track active dropdown row

        // --- GLOBAL DROPDOWN LOGIC ---
        function showDropdown(event, index) {
            event.stopPropagation();
            activeDropdownIndex = index;
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();
            const dropdown = document.getElementById('global-dropdown');
            
            // Position near button (Fixed position relative to viewport)
            dropdown.style.top = (rect.bottom) + 'px'; // Removed scrollY because it's fixed
            dropdown.style.left = (rect.left) + 'px';
            dropdown.style.display = 'block';
        }

        function closeGlobalDropdown(event) {
            const dropdown = document.getElementById('global-dropdown');
            if (dropdown && dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            }
        }

        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        // Action Handlers for Dropdown items
        function editStudentAction() { closeGlobalDropdown(); editStudent(activeDropdownIndex); }
        function moveClassAction() { closeGlobalDropdown(); openMoveClassModal(activeDropdownIndex); }
        function moveRoomAction() { closeGlobalDropdown(); openMoveRoomModal(activeDropdownIndex); }
        function moveSessionAction() { closeGlobalDropdown(); openMoveSessionModal(activeDropdownIndex); }

        // --- PHOTO HANDLING ---
        function previewStudentPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('add-photo-preview').src = e.target.result;
                    // Store temp in input dataset for save function
                    input.dataset.base64 = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearStudentPhoto() {
            document.getElementById('add-photo').value = "";
            document.getElementById('add-photo').dataset.base64 = "";
            document.getElementById('add-photo-preview').src = "https://via.placeholder.com/60";
        }

        function saveNewStudentData() {
            const name = document.getElementById('add-name').value;
            const id = document.getElementById('add-id').value;
            const user = document.getElementById('add-user').value;
            const pass = document.getElementById('add-pass').value;
            const school = document.getElementById('add-school').value;
            const kelas = document.getElementById('add-class').value;
            const room = document.getElementById('add-room').value;
            const session = document.getElementById('add-session').value;
            const religion = document.getElementById('add-religion').value;
            const note = document.getElementById('add-note').value;
            
            // Get photo data
            const photoInput = document.getElementById('add-photo');
            const photoBase64 = photoInput.dataset.base64 || (editingStudentIdx !== null ? adminDataCache[editingStudentIdx].foto : null);

            if(!name || !id || !user || !pass || !school || !kelas) return alert("Mohon lengkapi field bertanda bintang (*)");

            const newStudent = {
                nama: name, id_peserta: id, username: user, password: pass, sekolah: school,
                kelas: kelas, ruangan: room, sesi: session, agama: religion, catatan: note, 
                foto: photoBase64, // Save photo
                timestamp: new Date().toISOString()
            };

            if(editingStudentIdx !== null) {
                adminDataCache[editingStudentIdx] = newStudent;
                alert("Data peserta diperbarui!");
            } else {
                adminDataCache.push(newStudent);
                alert("Peserta berhasil ditambahkan!");
            }
            
            localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache));
            adminNav('students');
        }

        function editStudent(idx) {
            editingStudentIdx = idx;
            const s = adminDataCache[idx];
            document.getElementById('add-student-title').textContent = "Edit Peserta";
            document.getElementById('btn-save-student').textContent = "Simpan Perubahan";
            
            document.getElementById('add-name').value = s.nama;
            document.getElementById('add-id').value = s.id_peserta;
            document.getElementById('add-user').value = s.username;
            document.getElementById('add-pass').value = s.password;
            document.getElementById('add-school').value = s.sekolah;
            document.getElementById('add-class').value = s.kelas;
            document.getElementById('add-room').value = s.ruangan;
            document.getElementById('add-session').value = s.sesi;
            document.getElementById('add-religion').value = s.agama;
            document.getElementById('add-note').value = s.catatan;
            
            // Load photo preview
            if(s.foto) {
                document.getElementById('add-photo-preview').src = s.foto;
                document.getElementById('add-photo').dataset.base64 = s.foto;
            } else {
                clearStudentPhoto();
            }

            document.querySelectorAll('.admin-panel').forEach(e => e.classList.add('hidden-view'));
            document.getElementById('view-admin-add-student').classList.remove('hidden-view');
        }

        // --- ZIP UPLOAD LOGIC ---
        function triggerZipUpload() {
            document.getElementById('zip-upload-input').click();
        }

        async function handleZipUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const zip = new JSZip();
            let count = 0;

            try {
                const contents = await zip.loadAsync(file);
                
                // Create a map for faster lookup: username -> studentIndex
                const studentMap = {};
                adminDataCache.forEach((s, i) => {
                    // Map both username and ID to the index for flexibility
                    studentMap[s.username.toLowerCase()] = i;
                    if(s.id_peserta) studentMap[s.id_peserta.toLowerCase()] = i;
                });

                const promises = [];

                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir && updateImage(relativePath)) {
                        // Check if file is image
                        const ext = relativePath.split('.').pop().toLowerCase();
                        if(['jpg','jpeg','png'].includes(ext)) {
                             // Filename without extension is the key
                             const nameKey = relativePath.split('/').pop().split('.')[0].toLowerCase();
                             
                             if (studentMap.hasOwnProperty(nameKey)) {
                                 const promise = zipEntry.async("base64").then(data => {
                                     const base64Img = "data:image/" + ext + ";base64," + data;
                                     const idx = studentMap[nameKey];
                                     adminDataCache[idx].foto = base64Img;
                                     count++;
                                 });
                                 promises.push(promise);
                             }
                        }
                    }
                });

                await Promise.all(promises);
                
                if (count > 0) {
                    localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache));
                    renderAdminTables();
                    alert(`Berhasil memperbarui ${count} foto siswa!`);
                } else {
                    alert("Tidak ada foto yang cocok. Pastikan nama file foto sama dengan Username atau ID Peserta.");
                }
                
            } catch (e) {
                alert("Gagal memproses file ZIP: " + e.message);
            }
            
            input.value = ""; // Reset
        }
        
        // helper to filter system files in zip like __MACOSX
        function updateImage(path){
            return !path.startsWith("__MACOSX") && !path.includes(".DS_Store");
        }

        function downloadStudentTemplateWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Template Peserta</title></head><body>";
            const footer = "</body></html>";
            const html = `
                <h2 style="text-align:center">TEMPLATE DATA PESERTA UJIAN</h2>
                <p>Silakan isi data peserta pada tabel di bawah ini. Jangan ubah judul kolom.</p>
                <table border="1" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background-color:#eee;">
                            <th>No</th>
                            <th>Username*</th>
                            <th>Password*</th>
                            <th>Nama Lengkap*</th>
                            <th>ID Peserta (NISN)*</th>
                            <th>Kelas/Jurusan*</th>
                            <th>Ruangan</th>
                            <th>Sesi</th>
                            <th>Sekolah</th>
                            <th>Agama</th>
                            <th>Catatan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>USER001</td>
                            <td>12345</td>
                            <td>Siswa Contoh 1</td>
                            <td>00123456</td>
                            <td>X MIPA 1</td>
                            <td>R.1</td>
                            <td>1</td>
                            <td>SMA NEGERI</td>
                            <td>Islam</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            `;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + html + footer);
            const element = document.createElement('a');
            element.setAttribute('href', source);
            element.setAttribute('download', 'Template_Data_Peserta.doc');
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // --- RENDER TABLES (Updated for Global Dropdown) ---
        function renderAdminTables() {
            const studRows = adminDataCache.map((s, i) => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="px-4 py-3"><input type="checkbox" class="student-checkbox" value="${i}"></td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="showDropdown(event, ${i})" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 hover:bg-blue-700 mx-auto">
                            Edit <i data-feather="chevron-down" class="w-3 h-3"></i>
                        </button>
                    </td>
                    <td class="px-4 py-3 font-medium">${i+1}</td>
                    <td class="px-4 py-3 font-mono text-xs">${s.username || '-'}</td>
                    <td class="px-4 py-3 font-mono text-xs">${s.password || '-'}</td>
                    <td class="px-4 py-3 font-bold text-slate-700">${s.nama}</td>
                    <td class="px-4 py-3">${s.id_peserta || '-'}</td>
                    <td class="px-4 py-3">${s.kelas || '-'}</td>
                    <td class="px-4 py-3">${s.ruangan || '-'}</td>
                    <td class="px-4 py-3">${s.sesi || '-'}</td>
                    <td class="px-4 py-3">${s.sekolah || '-'}</td>
                    <td class="px-4 py-3">${s.agama || '-'}</td>
                    <td class="px-4 py-3 text-xs italic text-slate-400">${s.catatan || '-'}</td>
                </tr>`).join('');
            
            const tbody = document.getElementById('table-students-body');
            if(tbody) {
                tbody.innerHTML = studRows || '<tr><td colspan="13" class="p-8 text-center text-slate-400">Tidak ada data peserta</td></tr>';
                feather.replace(); 
            }
        }

        // --- RENDER CARDS (Updated for Photo) ---
        function renderCardPreview() {
            const container = document.getElementById('card-preview-area');
            container.innerHTML = '';
            
            let selectedIdxs = [];
            document.querySelectorAll('.student-checkbox:checked').forEach(cb => selectedIdxs.push(parseInt(cb.value)));
            
            // If no selection, show dummy. If selection, show selected.
            const targets = selectedIdxs.length > 0 ? selectedIdxs.map(i => adminDataCache[i]) : [adminDataCache[0] || {nama:'Jack Sparrow', id_peserta:'123456', kelas:'XI IPA A', ruangan:'LAB 1', username:'USER', password:'PWD', foto:null}];
            
            const logoSrc = localStorage.getItem('school_logo_url_base64') || 'https://via.placeholder.com/60';
            const conf = JSON.parse(localStorage.getItem('cbt_card_config') || '{}');
            const si = JSON.parse(localStorage.getItem('school_info') || '{}');
            
            const txtH1 = conf.h1 || 'PELAKSANA UJIAN SEKOLAH';
            const txtH2 = conf.h2 || si.name || 'NAMA SEKOLAH';
            const txtH3 = conf.h3 || si.addr || 'Alamat Sekolah'; 
            const txtTitle = conf.title || 'KARTU PESERTA';
            const txtSubtitle = conf.subtitle || 'PENILAIAN AKHIR SEMESTER';

            targets.forEach(s => {
                // Use uploaded photo or default dicebear avatar
                const photoSrc = s.foto ? s.foto : `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.username}`;
                
                const card = document.createElement('div');
                card.className = 'exam-card shadow-lg';
                card.innerHTML = `
                    <div class="exam-card-header">
                        <img src="${logoSrc}" class="exam-card-logo">
                        <div class="exam-card-header-text">
                            <div class="exam-card-h1">${txtH1}</div>
                            <div class="exam-card-h2">${txtH2}</div>
                            <div class="exam-card-h3">${txtH3}</div>
                        </div>
                    </div>
                    <div class="exam-card-body">
                        <div class="exam-card-photo-box">
                            <img src="${photoSrc}" class="exam-card-photo-img">
                        </div>
                        <div class="exam-card-info">
                            <div class="exam-card-title">${txtTitle}</div>
                            <div class="exam-card-subtitle">${txtSubtitle}</div>
                            <div class="exam-card-row"><div class="exam-card-label">Nama</div><div class="exam-card-val">: ${s.nama}</div></div>
                            <div class="exam-card-row"><div class="exam-card-label">ID</div><div class="exam-card-val">: ${s.id_peserta || '-'}</div></div>
                            <div class="exam-card-row"><div class="exam-card-label">Kelas</div><div class="exam-card-val">: ${s.kelas || '-'}</div></div>
                            <div class="exam-card-row"><div class="exam-card-label">Ruang</div><div class="exam-card-val">: ${s.ruangan || '-'}</div></div>
                            <div class="exam-card-row"><div class="exam-card-label">User</div><div class="exam-card-val">: ${s.username || '-'}</div></div>
                            <div class="exam-card-row"><div class="exam-card-label">Pass</div><div class="exam-card-val">: ${s.password || '-'}</div></div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // ... (Keep existing updateDropdowns, updateDashboardStats, startTokenTimer, saveTokenSettings, showAddStudent logic etc.) ...
        
        // --- REST OF THE CODE (Reuse existing logic for other parts) ---
        function updateDropdowns() { const optsC = '<option value="">Pilih</option>' + config.classes.map(c => `<option>${c}</option>`).join(''); const optsM = '<option value="">Pilih</option>' + config.majors.map(m => `<option>${m}</option>`).join(''); const classSelect = document.getElementById('add-class'); if (classSelect) { let combined = '<option value="">-- Pilih Kelas --</option>'; config.classes.forEach(c => { config.majors.forEach(m => { combined += `<option value="${c} ${m}">${c} ${m}</option>`; }); }); classSelect.innerHTML = combined; const filterClass = document.getElementById('filter-class'); const moveClassSelect = document.getElementById('move-class-select'); if(filterClass) filterClass.innerHTML = '<option value="Semua">Semua</option>' + combined; if(moveClassSelect) moveClassSelect.innerHTML = combined; } const frontClass = document.getElementById('input-kelas'); const frontJur = document.getElementById('input-jurusan'); if(frontClass) frontClass.innerHTML = optsC; if(frontJur) frontJur.innerHTML = optsM; }
        function updateDashboardStats() { const statStudents = document.getElementById('stat-total-students'); if(statStudents) statStudents.textContent = adminDataCache.length; const statExams = document.getElementById('stat-total-exams'); if(statExams) statExams.textContent = Object.keys(db).length; const statClasses = document.getElementById('stat-total-classes'); if(statClasses) statClasses.textContent = config.classes.length; const statMajors = document.getElementById('stat-total-majors'); if(statMajors) statMajors.textContent = config.majors.length; }
        function startTokenTimer() { const totalSecs = config.tokenDuration * 60; let elapsed = 0; if (tokenInterval) clearInterval(tokenInterval); tokenInterval = setInterval(() => { elapsed++; const remaining = totalSecs - elapsed; if(remaining <= 0) return; const h = Math.floor(remaining / 3600); const m = Math.floor((remaining % 3600) / 60); const s = remaining % 60; const timeStr = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; if(document.getElementById('token-timer-display')) document.getElementById('token-timer-display').textContent = timeStr; if(document.getElementById('token-timer-settings')) document.getElementById('token-timer-settings').textContent = timeStr; }, 1000); }
        function saveTokenSettings() { const dur = document.getElementById('token-duration').value; const isActive = document.getElementById('toggle-token').checked; localStorage.setItem('cbt_token_duration', dur); localStorage.setItem('cbt_token_active', isActive); config.tokenDuration = parseInt(dur); alert("Pengaturan Token Disimpan!"); startTokenTimer(); }
        function clearLoginHistory() { document.getElementById('login-history-body').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">Riwayat login telah dibersihkan.</td></tr>'; alert("Riwayat berhasil dihapus."); }
        function showSubTab(subName) { document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`sub-${subName}`).classList.remove('hidden'); document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active')); if(event) event.target.classList.add('active'); }
        function switchSettingsTab(tabName) { document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden-view')); document.getElementById(`set-content-${tabName}`).classList.remove('hidden-view'); document.querySelectorAll('.settings-nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`set-nav-${tabName}`).classList.add('active'); }
        function handleLogoUpload(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('preview-logo-upload').src = e.target.result; document.getElementById('preview-logo-upload').classList.remove('hidden'); document.getElementById('preview-logo-placeholder').classList.add('hidden'); document.getElementById('filename-logo').value = input.files[0].name; }; reader.readAsDataURL(input.files[0]); } }
        function saveLogoLocal() { const img = document.getElementById('preview-logo-upload').src; if(!img || img.includes(window.location.href)) return alert("Pilih gambar logo terlebih dahulu."); localStorage.setItem('school_logo_url_base64', img); applyLogo(img); alert("Logo berhasil disimpan!"); }
        function resetLogo() { localStorage.removeItem('school_logo_url_base64'); location.reload(); }
        function applyLogo(src) { const logoImg = document.getElementById('school-logo-img'); if(logoImg) { logoImg.src = src; logoImg.classList.remove('hidden'); document.getElementById('default-logo').classList.add('hidden'); } }
        function saveSchoolInfo() { const info = { name: document.getElementById('sch-name').value, level: document.getElementById('sch-level').value, addr: document.getElementById('sch-addr').value, email: document.getElementById('sch-email').value, web: document.getElementById('sch-web').value }; localStorage.setItem('school_info', JSON.stringify(info)); if(document.getElementById('school-name-display')) document.getElementById('school-name-display').textContent = info.name || 'CBT ONLINE'; alert("Informasi Sekolah Tersimpan!"); }
        function saveRules() { alert("Panduan tersimpan!"); }
        function generateNewToken() { const chars = "ABCDEF0123456789"; let result = ""; for(let i=0; i<6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); document.getElementById('dash-token').textContent = result; if(document.getElementById('setting-token-display')) document.getElementById('setting-token-display').textContent = result; localStorage.setItem('cbt_token_dash', result); startTokenTimer(); }
        function resetTrafficStats() { document.getElementById('stat-socket').textContent='0'; document.getElementById('stat-http').textContent='0'; document.getElementById('stat-socket').classList.add('animate-pulse'); setTimeout(() => document.getElementById('stat-socket').classList.remove('animate-pulse'), 500); }
        async function fetchAdminData() { if(GOOGLE_SCRIPT_URL) { try { const res = await fetch(GOOGLE_SCRIPT_URL); const data = await res.json(); if(data.students) { adminDataCache = data.students; localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache)); } } catch(e) {} } renderAdminTables(); updateDashboardStats(); }
        function downloadExcel() { if(adminDataCache.length === 0) return alert("Tidak ada data."); const exportData = adminDataCache.map(s => ({ "Nama": s.nama, "ID": s.id_peserta, "Username":s.username, "Password":s.password, "Kelas": s.kelas })); const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(exportData); XLSX.utils.book_append_sheet(wb, ws, "Peserta"); XLSX.writeFile(wb, "Data_Peserta.xlsx"); }
        function showAddStudent() { editingStudentIdx = null; document.getElementById('add-student-title').textContent = "Tambah Peserta"; document.getElementById('btn-save-student').textContent = "+ Tambahkan"; ['add-name','add-id','add-user','add-pass','add-school','add-class','add-room','add-session','add-religion','add-note'].forEach(id => document.getElementById(id).value = ''); clearStudentPhoto(); document.querySelectorAll('.admin-panel').forEach(e => e.classList.add('hidden-view')); document.getElementById('view-admin-add-student').classList.remove('hidden-view'); }
        function openMoveClassModal(idx) { selectedStudentIndex = idx; document.getElementById('modal-move-class').classList.remove('hidden-view'); }
        function saveMoveClass() { if(selectedStudentIndex !== null) { adminDataCache[selectedStudentIndex].kelas = document.getElementById('move-class-select').value; localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache)); renderAdminTables(); document.getElementById('modal-move-class').classList.add('hidden-view'); } }
        function openMoveRoomModal(idx) { selectedStudentIndex = idx; document.getElementById('modal-move-room').classList.remove('hidden-view'); }
        function saveMoveRoom() { if(selectedStudentIndex !== null) { adminDataCache[selectedStudentIndex].ruangan = document.getElementById('move-room-select').value; localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache)); renderAdminTables(); document.getElementById('modal-move-room').classList.add('hidden-view'); } }
        function openMoveSessionModal(idx) { selectedStudentIndex = idx; document.getElementById('modal-move-session').classList.remove('hidden-view'); }
        function saveMoveSession() { if(selectedStudentIndex !== null) { adminDataCache[selectedStudentIndex].sesi = document.getElementById('move-session-input').value; localStorage.setItem('cbt_admin_cache', JSON.stringify(adminDataCache)); renderAdminTables(); document.getElementById('modal-move-session').classList.add('hidden-view'); } }
        function showStudentCard() { document.querySelectorAll('.admin-panel').forEach(e => e.classList.add('hidden-view')); document.getElementById('view-admin-student-card').classList.remove('hidden-view'); const conf = JSON.parse(localStorage.getItem('cbt_card_config') || '{}'); document.getElementById('card-header-1').value = conf.h1 || 'PELAKSANA UJIAN SEKOLAH'; if(localStorage.getItem('school_info')) { const si = JSON.parse(localStorage.getItem('school_info')); document.getElementById('card-header-2').value = conf.h2 || si.name || 'NAMA SEKOLAH'; document.getElementById('card-header-3').value = conf.h3 || si.addr || 'Alamat Sekolah'; } else { document.getElementById('card-header-2').value = conf.h2 || 'NAMA SEKOLAH'; document.getElementById('card-header-3').value = conf.h3 || 'Alamat Sekolah'; } document.getElementById('card-title').value = conf.title || 'KARTU PESERTA'; document.getElementById('card-subtitle').value = conf.subtitle || 'PENILAIAN AKHIR SEMESTER'; renderCardPreview(); }
        function saveCardSettings() { const config = { h1: document.getElementById('card-header-1').value, h2: document.getElementById('card-header-2').value, h3: document.getElementById('card-header-3').value, title: document.getElementById('card-title').value, subtitle: document.getElementById('card-subtitle').value }; localStorage.setItem('cbt_card_config', JSON.stringify(config)); }
        function updateCardLogo(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { localStorage.setItem('school_logo_url_base64', e.target.result); renderCardPreview(); }; reader.readAsDataURL(input.files[0]); } }
        function showAdminLogin() { document.getElementById('modal-login').classList.remove('hidden-view'); }
        function checkAdminPin() { if(document.getElementById('pin-input').value === ADMIN_PIN) { document.getElementById('modal-login').classList.add('hidden-view'); nav('admin'); adminNav('dashboard'); fetchAdminData(); } else alert("PIN Salah"); }
        function logoutAdmin() { nav('welcome'); document.getElementById('pin-input').value = ''; document.getElementById('profile-menu').classList.add('hidden'); }
        function adminNav(tab) { document.querySelectorAll('.admin-panel').forEach(e => e.classList.add('hidden-view')); document.getElementById(`admin-panel-${tab}`).classList.remove('hidden-view'); document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('active-nav'); }); document.getElementById(`nav-${tab}`).classList.add('active-nav'); if(tab === 'questions') renderMapelList(); if(tab === 'settings') switchSettingsTab('profile'); if(tab === 'students') renderAdminTables(); }
        function startQuiz() { const name = document.getElementById('input-nama').value; const cls = document.getElementById('input-kelas').value; const mjr = document.getElementById('input-jurusan').value; const token = document.getElementById('input-token').value.toUpperCase(); if(!name || !cls || !mjr || !token) return alert("Lengkapi Data!"); userData = { name, cls, mjr, mapel: db[token] ? db[token].name : 'Ujian' }; currentQuestions = JSON.parse(JSON.stringify(db[token] ? db[token].questions : [])); if(currentQuestions.length === 0) return alert("Soal tidak ditemukan/Token salah"); currentQ=0; userAnswers={}; violations=0; startTime=new Date(); document.getElementById('play-name').textContent = name; document.getElementById('avatar-initial').textContent = name[0]; document.getElementById('play-info').textContent = `${cls} • ${mjr}`; nav('playing'); renderQ(); startTimer(); }
        function renderQ() { const q = currentQuestions[currentQ]; document.getElementById('q-num').textContent = currentQ+1; document.getElementById('q-text').innerHTML = q.question; const cont = document.getElementById('options-container'); cont.innerHTML = ''; if (q.type === 'essay') { cont.innerHTML = `<textarea class="w-full border p-3 rounded-xl" rows="5" placeholder="Jawab..." onchange="userAnswers[currentQ]=this.value">${userAnswers[currentQ] || ''}</textarea>`; } else { q.options.forEach((opt, i) => { const isSel = userAnswers[currentQ] === i; const btn = document.createElement('button'); btn.className = `w-full text-left p-4 rounded-xl border transition flex gap-3 items-center ${isSel ? 'border-blue-600 bg-blue-50 text-blue-800' : 'hover:bg-slate-50'}`; btn.onclick = () => { userAnswers[currentQ] = i; renderQ(); }; btn.innerHTML = `<span class="font-bold text-sm ${isSel?'text-blue-600':'text-slate-400'}">${String.fromCharCode(65+i)}.</span> <span>${opt}</span>`; cont.appendChild(btn); }); } document.getElementById('btn-prev').disabled = currentQ===0; const isLast = currentQ===currentQuestions.length-1; document.getElementById('btn-next').classList.toggle('hidden', isLast); document.getElementById('btn-finish').classList.toggle('hidden', !isLast); }
        function nextQ() { if(currentQ<currentQuestions.length-1){currentQ++; renderQ();} }
        function prevQ() { if(currentQ>0){currentQ--; renderQ();} }
        async function finishQuiz() { clearInterval(tokenInterval); nav('result-card'); document.getElementById('res-score').textContent = "Selesai"; }
        function startTimer() { if (tokenInterval) clearInterval(tokenInterval); tokenInterval = setInterval(() => { const diff = new Date() - startTime; const m = Math.floor(diff/60000).toString().padStart(2,'0'); const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0'); const el = document.getElementById('timer-display'); if(el) el.textContent = `${m}:${s}`; }, 1000); }
        function renderMapelList() { const l = document.getElementById('mapel-list'); l.innerHTML = ''; Object.keys(db).forEach(k => { const d = document.createElement('div'); d.className = "p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2"; d.innerHTML = `<b>${db[k].name}</b> <span class="text-xs text-slate-400">${k}</span>`; d.onclick = () => { activeTokenAdmin=k; renderSoalList(); }; l.appendChild(d); }); }
        function openAddSubject() { document.getElementById('modal-subject').classList.remove('hidden-view'); }
        function saveNewSubject() { const t = document.getElementById('new-token').value.toUpperCase(); const n = document.getElementById('new-mapel').value; if(t&&n) { db[t] = {name:n, questions:[]}; localStorage.setItem('cbt_db_v4', JSON.stringify(db)); document.getElementById('modal-subject').classList.add('hidden-view'); renderMapelList(); } }
        function renderSoalList() { const l = document.getElementById('soal-list'); l.innerHTML = ''; if(activeTokenAdmin && db[activeTokenAdmin]) { db[activeTokenAdmin].questions.forEach((q, i) => { const d = document.createElement('div'); d.className = "p-3 border rounded mb-2 bg-white"; const plainText = q.question.replace(/<[^>]*>?/gm, ''); d.innerHTML = `<div class="text-sm font-bold truncate">${plainText}</div><div class="text-right text-xs mt-2"><button onclick="editQ(${i})" class="text-blue-500 mr-2">Edit</button><button onclick="delQ(${i})" class="text-red-500">Hapus</button></div>`; l.appendChild(d); }); } }
        function openAddQuestion() { editingQIdx=null; document.getElementById('modal-question').classList.remove('hidden-view'); if(document.getElementById('ed-q').customEditor) document.getElementById('ed-q').customEditor.innerHTML = ''; document.getElementById('ed-q').value = ''; renderAnswerInput(); }
        function editQ(i) { editingQIdx=i; document.getElementById('modal-question').classList.remove('hidden-view'); const questionData = db[activeTokenAdmin].questions[i]; if(document.getElementById('ed-q').customEditor) { document.getElementById('ed-q').customEditor.innerHTML = questionData.question; } document.getElementById('ed-q').value = questionData.question; renderAnswerInput(questionData); }
        function delQ(i) { db[activeTokenAdmin].questions.splice(i,1); localStorage.setItem('cbt_db_v4', JSON.stringify(db)); renderSoalList(); }
        function renderAnswerInput(data=null) { const c = document.getElementById('ed-opts-container'); c.innerHTML = ''; const opts = data ? data.options : ['', '', '', '']; opts.forEach((o, i) => { const d = document.createElement('div'); d.className = "flex gap-2 mb-1"; d.innerHTML = `<input type="radio" name="ans" ${data && data.answer==i?'checked':''}><input class="border p-2 w-full rounded opt-val text-sm" value="${o}">`; c.appendChild(d); }); }
        function addEditorOpt() { const d = document.createElement('div'); d.className = "flex gap-2 mb-1"; d.innerHTML = `<input type="radio" name="ans"><input class="border p-2 w-full rounded opt-val text-sm">`; document.getElementById('ed-opts-container').appendChild(d); }
        function saveQuestion() { const q = document.getElementById('ed-q').value; const opts = []; let ans = -1; document.querySelectorAll('.opt-val').forEach((el, i) => { opts.push(el.value); if(document.querySelectorAll('input[name="ans"]')[i].checked) ans = i; }); if(!q || ans === -1) return alert("Lengkapi soal"); const newQ = { id: Date.now(), type:'pg', question:q, options:opts, answer:ans, points:2.5 }; if(editingQIdx!==null) db[activeTokenAdmin].questions[editingQIdx] = newQ; else db[activeTokenAdmin].questions.push(newQ); localStorage.setItem('cbt_db_v4', JSON.stringify(db)); document.getElementById('modal-question').classList.add('hidden-view'); renderSoalList(); }
        function initSimpleEditor(textareaId) { const ta = document.getElementById(textareaId); if (!ta || ta.nextElementSibling?.classList.contains('custom-editor')) return; ta.style.display = 'none'; const editorContainer = document.createElement('div'); editorContainer.className = 'custom-editor border rounded-xl overflow-hidden border-slate-300 bg-white flex flex-col h-full'; if(textareaId === 'ed-q') editorContainer.style.height = '350px'; else editorContainer.style.height = '300px'; const toolbar = document.createElement('div'); toolbar.className = 'flex flex-wrap items-center gap-1 p-2 bg-slate-50 border-b border-slate-200 shrink-0'; const tools = [{icon:'bold',cmd:'bold'},{icon:'italic',cmd:'italic'},{icon:'list',cmd:'insertUnorderedList'}]; tools.forEach(t => { const btn = document.createElement('button'); btn.className = 'p-1.5 rounded hover:bg-slate-200 text-slate-600'; btn.innerHTML = `<i data-feather="${t.icon}" class="w-4 h-4"></i>`; btn.onclick=(e)=>{e.preventDefault();document.execCommand(t.cmd,false,null);}; toolbar.appendChild(btn); }); const contentArea = document.createElement('div'); contentArea.className = 'editor-content-area p-4 flex-grow outline-none text-sm text-slate-700 overflow-y-auto'; contentArea.contentEditable = true; contentArea.innerHTML = ta.value; contentArea.oninput = () => { ta.value = contentArea.innerHTML; }; editorContainer.appendChild(toolbar); editorContainer.appendChild(contentArea); ta.parentNode.insertBefore(editorContainer, ta); if(window.feather) feather.replace(); ta.customEditor = contentArea; }
        function downloadTemplateWord() { alert("Template downloaded"); }
        function toggleSidebar() { const sb = document.getElementById('admin-sidebar'); sb.classList.toggle('w-64'); sb.classList.toggle('w-0'); sb.classList.toggle('px-0'); sb.classList.toggle('overflow-hidden'); }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else if (document.exitFullscreen) document.exitFullscreen(); }
        function toggleProfileMenu() { document.getElementById('profile-menu').classList.toggle('hidden'); }
        function nav(id) { document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden-view')); document.getElementById(`view-${id}`).classList.remove('hidden-view'); document.getElementById('student-header').style.display = id === 'welcome' ? 'flex' : 'none'; }
        
        // --- FEATURE 2: Restore Active Page on Refresh ---
        function saveActivePage(pageId, tabId = null) {
            sessionStorage.setItem('cbt_active_page', pageId);
            if(tabId) sessionStorage.setItem('cbt_active_tab', tabId);
        }
        
        function restoreActivePage() {
            const pageId = sessionStorage.getItem('cbt_active_page');
            const tabId = sessionStorage.getItem('cbt_active_tab');
            
            if (pageId) {
                if (pageId === 'admin') {
                    // Show login modal if not authenticated session (simplified for demo)
                    document.getElementById('modal-login').classList.remove('hidden-view');
                } else {
                    nav(pageId);
                }
            }
            
            if (tabId && pageId === 'admin') {
                adminNav(tabId);
            }
        }

        // 5. INIT
        function init() {
            updateDropdowns();
            const savedToken = localStorage.getItem('cbt_token_dash'); if(savedToken && document.getElementById('dash-token')) document.getElementById('dash-token').textContent = savedToken; if(document.getElementById('setting-token-display')) document.getElementById('setting-token-display').textContent = savedToken || "NOFDTI";
            const tokenDur = localStorage.getItem('cbt_token_duration'); const useTok = localStorage.getItem('cbt_token_active'); if(tokenDur) { config.tokenDuration = parseInt(tokenDur); if(document.getElementById('token-duration')) document.getElementById('token-duration').value = config.tokenDuration; } if(useTok !== null && document.getElementById('toggle-token')) document.getElementById('toggle-token').checked = (useTok === 'true');
            startTokenTimer(); const savedLogo = localStorage.getItem('school_logo_url_base64'); if(savedLogo) applyLogo(savedLogo); setInterval(() => { const now = new Date(); if(document.getElementById('digital-clock')) document.getElementById('digital-clock').textContent = now.toLocaleTimeString(); }, 1000);
            if(localStorage.getItem('school_info')) { const si = JSON.parse(localStorage.getItem('school_info')); if(document.getElementById('sch-name')) document.getElementById('sch-name').value = si.name || ''; if(document.getElementById('sch-level')) document.getElementById('sch-level').value = si.level || ''; if(document.getElementById('sch-addr')) document.getElementById('sch-addr').value = si.addr || ''; if(document.getElementById('sch-email')) document.getElementById('sch-email').value = si.email || ''; if(document.getElementById('sch-web')) document.getElementById('sch-web').value = si.web || ''; if(document.getElementById('school-name-display')) document.getElementById('school-name-display').textContent = si.name || 'CBT ONLINE'; }
            if(localStorage.getItem('cbt_admin_cache')) { adminDataCache = JSON.parse(localStorage.getItem('cbt_admin_cache')); updateDashboardStats(); }
            initSimpleEditor('rules-content'); initSimpleEditor('ed-q');
            
            // Restore page on load
            // restoreActivePage(); // Uncomment to enable
        }
        init(); 
        
        // Add save state to nav functions
        const originalNav = nav;
        nav = function(id) {
            originalNav(id);
            saveActivePage(id);
        }
        
        const originalAdminNav = adminNav;
        adminNav = function(tab) {
            originalAdminNav(tab);
            saveActivePage('admin', tab);
        }
    </script>
</body>
</html>


